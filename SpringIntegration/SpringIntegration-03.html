<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="application/xhtml+xml; charset=windows-1252" />
    <meta name="author" content="Bhaskar.S">
    <meta name="description" content="Spring Integration Notes :: Part - 3">
    <meta name="subject" content="Spring Integration Notes :: Part - 3">
    <meta name="keywords" content="eip, java, spring">
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <title>Spring Integration Notes :: Part - 3</title>
    <link href="../css/polarsparc-v2.4.css" type="text/css" rel="stylesheet" />
  </head>
  <body>
    <br />
    <table borber="0">
      <tr>
        <td valign="bottom"><span id="ps-home"></span></td>
        <td valign="bottom"><span id="home-a"><a id="home-a" href="https://polarsparc.github.io/">PolarSPARC</a></span></td>
      </tr>
    </table>
    <br/>
    <div id="title-div">
      <p>Spring Integration Notes :: Part - 3</p>
    </div>
    <br />
    <table id="ad-table">
      <tbody>
        <tr>
          <td class="author-td">Bhaskar S</td>
          <td class="date-td">05/01/2021 (<span class="hi-yellow">UPDATED</span>)</td>
        </tr>
      </tbody>
    </table>
    <hr class="line-hr" />
    <br />
    <div id="section-div">
      <p>Overview</p>
    </div>
    <div id="para-div">
      <p>In <span class="bold"><a target="_blank" href="https://polarsparc.github.io/SpringIntegration/SpringIntegration-02.html">
        Part-2</a></span>, we covered basic examples of <span class="bold">Spring Integration</span> relating to Logging of Messages,
        Multi-Threading, and Exception Handling.</p>
      <p>We will continue our journey to explore some basic examples in <span class="bold">Spring Integration</span> relating to the
        following:</p>
      <ul id="blue-sqr-ul">
        <li>
          <p>Polling for Files in a Directory</p>
        </li>
        <li>
          <p>Transfer Files from a Remote Directory using SFTP</p>
        </li>
      </ul>
      <p>In <span class="bold">Spring Integration</span>, to connect to an external system such as a Filesystem, or an SFTP, or a
        Database, or a Messaging System etc., one needs to use the appropriate <span class="hi-yellow">Channel Adapter</span>.</p>
      <p>A <span class="bold">Channel Adapter</span> is an <span class="bold">endpoint</span> that connects a <span class="bold">
        channel</span> to the external system(s) or transport(s).</p>
      <p>A <span class="bold">Channel Adapter</span> can be:</p>
      <ul id="blue-sqr-ul">
        <li>
          <p><span class="hi-yellow">Inbound</span> &#8680; in which case the external system acts as the source of the
            <span class="bold">message</span>s</p>
          <div id="img-outer-div">
            <img class="img-cls" src="./images/spring-int-05.png" alt="Inbound" />
            <div class="img-cap">Inbound</div>
          </div>
        </li>
        <li>
          <p><span class="hi-yellow">Outbound</span> &#8680; in which case the external system is the target of the
            <span class="bold">message</span>s</p>
          <div id="img-outer-div">
            <img class="img-cls" src="./images/spring-int-06.png" alt="Outbound" />
            <div class="img-cap">Outbound</div>
          </div>
        </li>
      </ul>
      <p><span class="bold">Spring Integration</span> comes with a number of out-of-the-box <span class="bold">Channel Adapter</span>s.</p>
    </div>
    <div id="section-div">
      <p>Setup</p>
    </div>
    <div id="para-div">
      <p>Ensure <span class="hi-yellow"><a href="https://polarsparc.github.io/xhtml/Docker.html" target="_blank">Docker</a></span> is
        setup in the Linux system as we will be demonstrating the <span class="bold">channel adapter</span>s relating to SFTP using
        the appropriate <span class="bold">docker</span> image.</p>
    </div>
    <div id="para-div">
      <p>To setup the Java directory structure for the demonstrations in this part, execute the following commands:</p>
    </div>
    <div id="cmd-div">
      <p>$ cd $HOME/java/SpringIntegration</p>
      <p>$ mkdir -p src/main/java/com/polarsparc/si/p3</p>
      <p>$ mkdir -p src/main/resources/p3</p>
      <p>$ mkdir -p src/main/resources/META-INF/keys</p>
    </div>
    <div id="para-div">
      <p>To setup the other directory structure(s), execute the following commands:</p>
    </div>
    <div id="cmd-div">
      <p>$ mkdir -p /tmp/in-dir</p>
      <p>$ mkdir -p /tmp/out-dir</p>
    </div>
    <div id="para-div">
      <p>To download the required <span class="bold">docker</span> image for the <span class="bold">sftp</span> server, execute the
        following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ docker pull atmoz/sftp</p>
    </div>
    <div id="para-div">
      <p>To create the asymmetric public-private keys for <span class="bold">sftp</span>, execute the following commands:</p>
    </div>
    <div id="cmd-div">
      <p>$ mkdir -p $HOME/Downloads/sftp/share</p>
      <p>$ cd $HOME/Downloads/sftp</p>
      <p>$ ssh-keygen -m pem -t rsa -b 2048 -f sftp_rsa_key -C noname &lt; /dev/null</p>
    </div>
    <div id="para-div">
      <p>The private key is stored in the file <span class="hi-yellow">$HOME/Downloads/sftp/sftp_rsa_key</span> and the public key
        is stored in the file <span class="hi-yellow">$HOME/Downloads/sftp/sftp_rsa_key.pub</span>.</p>
    </div>
    <div id="para-div">
      <p>To setup the private key for the <span class="bold">sftp</span> client, execute the following commands:</p>
    </div>
    <div id="cmd-div">
      <p>$ cd $HOME/Downloads/sftp</p>
      <p>$ mv sftp_rsa_key $HOME/java/SpringIntegration/src/main/resources/META-INF/keys</p>
    </div>
    <br/>
    <div id="para-div">
      <p>The following is the listing for the updated <span class="bold">Maven</span> project file <span class="hi-green">pom.xml</span>
        to support the file and sftp <span class="bold">channel adapter</span>s:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">pom.xml</div>
      <div class="src-body-1">
<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;

    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;com.polarsparc.si&lt;/groupId&gt;
    &lt;artifactId&gt;SpringIntegration&lt;/artifactId&gt;
    &lt;version&gt;1.0&lt;/version&gt;
    &lt;name&gt;SpringIntegration&lt;/name&gt;
    &lt;description&gt;Spring Integration Examples&lt;/description&gt;

    &lt;properties&gt;
        &lt;maven.compiler.source&gt;11&lt;/maven.compiler.source&gt;
        &lt;maven.compiler.target&gt;11&lt;/maven.compiler.target&gt;
    &lt;/properties&gt;

    &lt;build&gt;
        &lt;pluginManagement&gt;
            &lt;plugins&gt;
                &lt;plugin&gt;
                    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                    &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                    &lt;version&gt;3.8.1&lt;/version&gt;
                    &lt;configuration&gt;
                        &lt;fork&gt;true&lt;/fork&gt;
                        &lt;meminitial&gt;128m&lt;/meminitial&gt;
                        &lt;maxmem&gt;512m&lt;/maxmem&gt;
                        &lt;source&gt;11&lt;/source&gt;
                        &lt;target&gt;11&lt;/target&gt;
                    &lt;/configuration&gt;
                &lt;/plugin&gt;
            &lt;/plugins&gt;
        &lt;/pluginManagement&gt;
    &lt;/build&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;javax.annotation&lt;/groupId&gt;
            &lt;artifactId&gt;javax.annotation-api&lt;/artifactId&gt;
            &lt;version&gt;1.3.2&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-core&lt;/artifactId&gt;
            &lt;version&gt;5.3.5&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-context&lt;/artifactId&gt;
            &lt;version&gt;5.3.5&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-beans&lt;/artifactId&gt;
            &lt;version&gt;5.3.5&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.integration&lt;/groupId&gt;
            &lt;artifactId&gt;spring-integration-core&lt;/artifactId&gt;
            &lt;version&gt;5.4.5&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.integration&lt;/groupId&gt;
            &lt;artifactId&gt;spring-integration-file&lt;/artifactId&gt;
            &lt;version&gt;5.4.5&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.integration&lt;/groupId&gt;
            &lt;artifactId&gt;spring-integration-sftp&lt;/artifactId&gt;
            &lt;version&gt;5.4.5&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
            &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
            &lt;version&gt;1.7.30&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
            &lt;artifactId&gt;log4j-over-slf4j&lt;/artifactId&gt;
            &lt;version&gt;1.7.30&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
            &lt;artifactId&gt;slf4j-simple&lt;/artifactId&gt;
            &lt;version&gt;1.7.30&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

&lt;/project&gt;</pre>
      </div>
    </div>
    <br/>
    <div id="section-div">
      <p>Hands-on Spring Integration</p>
    </div>
    <div id="step-div">
      <p>Polling for Files in a Directory</p>
    </div>
    <div id="para-div">
      <p>In this example, we poll for file(s) matching a regular expression file name pattern in a specified input directory. On
        finding new file(s), they are processed by a handler, moved to a specified output directory, and deleted from the input
        directory.</p>
    </div>
    <div id="para-div">
      <p>We will use an external properties file to configure the locations of the source (input) and target (output) directories
        versus hardcoding the locations in <span class="bold">Spring Integration</span> configuration.</p>
    </div>
    <div id="para-div">
      <p>The following is the properties file <span class="bold">file.properties</span> located in the <span class="bold">resources/p3
        </span> directory:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Listing.31</div>
      <div class="src-body-1">
<pre>#
# Properties for file processing
#

input.files.directory=/tmp/in-dir
output.files.directory=/tmp/out-dir
files.regex.pattern="[a-z]+.dat"</pre>
      </div>
    </div>
    <br/>
    <table id="step-table">
      <tbody>
        <tr>
          <td class="text-td">XML based Approach</td>
          <td class="pointer-td"></td>
        </tr>
      </tbody>
    </table>
    <div id="para-div">
      <p>The following is the file handler POJO that displays the file name and file size:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Listing.32</div>
      <div class="src-body-1">
<pre>/*
 * Name:   FileProcessHandler
 * Author: Bhaskar S
 * Date:   05/01/2021
 * Blog:   https://polarsparc.github.io
 */

package com.polarsparc.si.p3;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;

public class FileProcessHandler {
    private static final Logger LOGGER = LoggerFactory.getLogger(FileProcessHandler.class);

    public File handler(File input) {
        LOGGER.info("Processed input file: {}, size: {} (using Xml)", input.getAbsolutePath(), input.length());

        return input;
    }
}</pre>
      </div>
    </div>
    <br/>
    <div id="para-div">
      <p>The following is the <span class="bold">XML</span> based <span class="bold">Spring Integration</span> configuration that
        refers to the external <span class="bold">file.properties</span> file and wires up the <span class="bold">channels</span>,
        the input and output file <span class="bold">channel adapter</span>s, and the <span class="bold">endpoint</span>:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Listing.33</div>
      <div class="src-body-1">
<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;beans xmlns="http://www.springframework.org/schema/beans"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:context="http://www.springframework.org/schema/context"
        xmlns:int="http://www.springframework.org/schema/integration"
        xmlns:file="http://www.springframework.org/schema/integration/file"
        xsi:schemaLocation="http://www.springframework.org/schema/beans
                            http://www.springframework.org/schema/beans/spring-beans.xsd
                            http://www.springframework.org/schema/context
                            http://www.springframework.org/schema/context/spring-context.xsd
                            http://www.springframework.org/schema/integration
                            http://www.springframework.org/schema/integration/spring-integration.xsd
                            http://www.springframework.org/schema/integration/file
                            http://www.springframework.org/schema/integration/file/spring-integration-file.xsd"&gt;

    &lt;context:property-placeholder location="classpath:p3/file.properties" /&gt;

    &lt;bean id="inFileHandler" class="com.polarsparc.si.p3.FileProcessHandler" /&gt;

    &lt;file:inbound-channel-adapter id="inChannel"
                                  directory="file:${input.files.directory}"
                                  filename-regex="${files.regex.pattern}"
                                  prevent-duplicates="true"&gt;
        &lt;int:poller id="poller" fixed-delay="5000" /&gt;
    &lt;/file:inbound-channel-adapter&gt;

    &lt;file:outbound-channel-adapter id="outChannel"
                                    directory="file:${output.files.directory}"
                                    delete-source-files="true" /&gt;

    &lt;int:service-activator input-channel="inChannel"
                            output-channel="outChannel"
                            ref="inFileHandler"
                            method="handler" /&gt;

&lt;/beans&gt;</pre>
      </div>
    </div>
    <br/>
    <div id="para-div">
      <p>Some aspects of the <span class="bold">Listing.33</span> from the above needs a little explanation.</p>
      <ul id="blue-sqr-ul">
        <li>
          <p>The <span class="hi-yellow">property-placeholder</span> element allows one to read and load the externally stored
            properties file via the classpath into the spring context.</p>
          <p>Under-the-hood, <span class="bold">Spring Integration</span> uses
            <span class="hi-yellow">org.springframework.context.support.PropertySourcesPlaceholderConfigurer</span> to load the
            properties file from the classpath</p>
        </li>
        <li>
          <p>The file <span class="hi-yellow">inbound-channel-adapter</span> element allows one to scan for file(s) matching the
            regular expression pattern as specified by the attribute <span class="hi-green">filename-regex</span> in the filesystem
            location as specified by the attribute <span class="hi-green">directory</span>.</p>
          <p>The <span class="hi-green">prevent-duplicates</span> attribute when set to <span class="bold">true</span>, indicates
            to the underlying file reader to only fetch file(s) that were not identified in the previous polling.</p>
          <p>Under-the-hood, <span class="bold">Spring Integration</span> uses
            <span class="hi-yellow">org.springframework.integration.file.FileReadingMessageSource</span>
            to fetch the file(s) matching the specified pattern from the specified filesystem location</p>
        </li>
        <li>
          <p>The file <span class="hi-yellow">outbound-channel-adapter</span> element allows one to write file(s) to the filesystem
            at the location as specified by the attribute <span class="hi-green">directory</span>.</p>
          <p>The <span class="hi-green">delete-source-files</span> attribute when set to <span class="bold">true</span>, will delete
            the original source file(s) from the input directory.</p>
          <p>Under-the-hood, <span class="bold">Spring Integration</span> uses
            <span class="hi-yellow">org.springframework.integration.file.FileWritingMessageHandler</span> to write file(s) at the
            specified filesystem location</p>
        </li>
      </ul>
    </div>
    <div id="para-div">
      <p>The following is our main application to test the file <span class="bold">channel adapter</span>:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Listing.34</div>
      <div class="src-body-1">
<pre>/*
 * Name:   FileProcessMainXml
 * Author: Bhaskar S
 * Date:   05/01/2021
 * Blog:   https://polarsparc.github.io
 */

package com.polarsparc.si.p3;

import org.springframework.context.support.ClassPathXmlApplicationContext;

public class FileProcessMainXml {
    public static void main(String[] args) {
        new ClassPathXmlApplicationContext("p3/FileProcess.xml");
    }
}</pre>
      </div>
    </div>
    <br/>
    <div id="para-div">
      <p>To execute the code from <span class="bold">Listing.34</span>, open a terminal window and run the following commands:</p>
    </div>
    <div id="cmd-div">
      <p>$ cd $HOME/java/SpringIntegration</p>
      <p>$ mvn exec:java -Dexec.mainClass="com.polarsparc.si.p3.FileProcessMainXml"</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.11</h4>
      <pre>[INFO] Scanning for projects...
[INFO] 
[INFO] ----------------&lt; com.polarsparc.si:SpringIntegration &gt;-----------------
[INFO] Building SpringIntegration 1.0
[INFO] --------------------------------[ jar ]---------------------------------
[INFO] 
[INFO] --- exec-maven-plugin:3.0.0:java (default-cli) @ SpringIntegration ---
2021-05-01 11:56:37:290 [com.polarsparc.si.p3.FileProcessMainXml.main()] INFO org.springframework.integration.config.DefaultConfiguringBeanFactoryPostProcessor - No bean named 'errorChannel' has been explicitly defined. Therefore, a default PublishSubscribeChannel will be created.
2021-05-01 11:56:37:293 [com.polarsparc.si.p3.FileProcessMainXml.main()] INFO org.springframework.integration.config.DefaultConfiguringBeanFactoryPostProcessor - No bean named 'taskScheduler' has been explicitly defined. Therefore, a default ThreadPoolTaskScheduler will be created.
2021-05-01 11:56:37:298 [com.polarsparc.si.p3.FileProcessMainXml.main()] INFO org.springframework.integration.config.DefaultConfiguringBeanFactoryPostProcessor - No bean named 'integrationHeaderChannelRegistry' has been explicitly defined. Therefore, a default DefaultHeaderChannelRegistry will be created.
2021-05-01 11:56:37:518 [com.polarsparc.si.p3.FileProcessMainXml.main()] INFO org.springframework.scheduling.concurrent.ThreadPoolTaskScheduler - Initializing ExecutorService 'taskScheduler'
2021-05-01 11:56:37:543 [com.polarsparc.si.p3.FileProcessMainXml.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - Adding {file:outbound-channel-adapter:outChannel.adapter} as a subscriber to the 'outChannel' channel
2021-05-01 11:56:37:544 [com.polarsparc.si.p3.FileProcessMainXml.main()] INFO org.springframework.integration.channel.DirectChannel - Channel 'org.springframework.context.support.ClassPathXmlApplicationContext@42062658.outChannel' has 1 subscriber(s).
2021-05-01 11:56:37:545 [com.polarsparc.si.p3.FileProcessMainXml.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - started bean 'outChannel.adapter'; defined in: 'class path resource [p3/FileProcess.xml]'; from source: ''file:outbound-channel-adapter' with id='outChannel''
2021-05-01 11:56:37:546 [com.polarsparc.si.p3.FileProcessMainXml.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - Adding {service-activator} as a subscriber to the 'inChannel' channel
2021-05-01 11:56:37:547 [com.polarsparc.si.p3.FileProcessMainXml.main()] INFO org.springframework.integration.channel.DirectChannel - Channel 'org.springframework.context.support.ClassPathXmlApplicationContext@42062658.inChannel' has 1 subscriber(s).
2021-05-01 11:56:37:547 [com.polarsparc.si.p3.FileProcessMainXml.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - started bean 'org.springframework.integration.config.ConsumerEndpointFactoryBean#0'
2021-05-01 11:56:37:548 [com.polarsparc.si.p3.FileProcessMainXml.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - Adding {logging-channel-adapter:_org.springframework.integration.errorLogger} as a subscriber to the 'errorChannel' channel
2021-05-01 11:56:37:549 [com.polarsparc.si.p3.FileProcessMainXml.main()] INFO org.springframework.integration.channel.PublishSubscribeChannel - Channel 'org.springframework.context.support.ClassPathXmlApplicationContext@42062658.errorChannel' has 1 subscriber(s).
2021-05-01 11:56:37:550 [com.polarsparc.si.p3.FileProcessMainXml.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - started bean '_org.springframework.integration.errorLogger'
2021-05-01 11:56:37:554 [com.polarsparc.si.p3.FileProcessMainXml.main()] INFO org.springframework.integration.endpoint.SourcePollingChannelAdapter - started bean 'inChannel.adapter'; defined in: 'class path resource [p3/FileProcess.xml]'; from source: ''file:inbound-channel-adapter' with id='inChannel''</pre>
    </div>
    <div id="para-div">
      <p>Create a file called <span class="bold">abc.dat</span> in the directory <span class="bold">/tmp/in-dir</span> by executing
        the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ echo 'Spring Integration' &gt; /tmp/in-dir/abc.dat</p>
    </div>
    <div id="para-div">
      <p>We will see the following update in the terminal output:</p>
    </div>
    <div id="out-div">
      <h4>Output.12</h4>
      <pre>2021-05-01 11:58:02:569 [task-scheduler-6] INFO org.springframework.integration.handler.support.MessagingMethodInvokerHelper - Overriding default instance of MessageHandlerMethodFactory with provided one.
2021-05-01 11:58:02:575 [task-scheduler-6] INFO com.polarsparc.si.p3.FileProcessHandler - Processed input file: /tmp/in-dir/abc.dat, size: 19 (using Xml)</pre>
    </div>
    <div id="para-div">
      <p>Now, create another file called <span class="bold">def.txt</span> in the directory <span class="bold">/tmp/in-dir</span> by
        executing the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ echo 'Ignored' &gt; /tmp/in-dir/def.txt</p>
    </div>
    <div id="para-div">
      <p>Nothing will happen as the file name does not match the pattern.</p>
    </div>
    <table id="step-table">
      <tbody>
        <tr>
          <td class="text-td">Java Config based Approach</td>
          <td class="pointer-td"></td>
        </tr>
      </tbody>
    </table>
    <div id="para-div">
      <p>The following is the Java Config based POJO that defines the file handler <span class="bold">endpoint</span> that displays
        the file name and file size:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Listing.35</div>
      <div class="src-body-1">
<pre>/*
 * Name:   FileProcessHandler2
 * Author: Bhaskar S
 * Date:   05/01/2021
 * Blog:   https://polarsparc.github.io
 */

package com.polarsparc.si.p3;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.context.annotation.Configuration;
import org.springframework.integration.annotation.ServiceActivator;
import org.springframework.integration.config.EnableIntegration;

import java.io.File;

@Configuration
@EnableIntegration
public class FileProcessHandler2 {
    private static final Logger LOGGER = LoggerFactory.getLogger(FileProcessHandler2.class);

    @ServiceActivator(inputChannel = "inChannel", outputChannel = "outChannel")
    public File handler(File input) {
        LOGGER.info("Processed input file: {}, size: {} (using Config)", input.getAbsolutePath(), input.length());

        return input;
    }
}</pre>
      </div>
    </div>
    <br/>
    <div id="para-div">
      <p>The following is the Java Config based POJO that refers to the external <span class="bold">file.properties</span> file and
        defines the input and output file <span class="bold">channel adapter</span>s as well as the <span class="bold">endpoint</span>
        similar to the way defined in the <span class="bold">XML</span> configuration file of <span class="bold">Listing.33</span>
        above:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Listing.36</div>
      <div class="src-body-1">
<pre>/*
 * Name:   FileProcessConfig
 * Author: Bhaskar S
 * Date:   05/01/2021
 * Blog:   https://polarsparc.github.io
 */

package com.polarsparc.si.p3;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.PropertySource;
import org.springframework.integration.annotation.InboundChannelAdapter;
import org.springframework.integration.annotation.Poller;
import org.springframework.integration.annotation.ServiceActivator;
import org.springframework.integration.config.EnableIntegration;
import org.springframework.integration.core.MessageSource;
import org.springframework.integration.file.FileReadingMessageSource;
import org.springframework.integration.file.FileWritingMessageHandler;
import org.springframework.integration.file.filters.AcceptOnceFileListFilter;
import org.springframework.integration.file.filters.CompositeFileListFilter;
import org.springframework.integration.file.filters.RegexPatternFileListFilter;
import org.springframework.messaging.MessageHandler;

import java.io.File;

@Configuration
@EnableIntegration
@PropertySource("classpath:p3/file.properties")
public class FileProcessConfig {
    @Value("${input.files.directory}")
    private String filesInDir;

    @Value("${output.files.directory}")
    private String filesOutDir;

    @Bean
    @InboundChannelAdapter(value = "inChannel", poller = @Poller(fixedDelay = "5000"))
    public MessageSource&lt;File&gt; fileInboundChannelAdapter() {
        FileReadingMessageSource adapter = new FileReadingMessageSource();
        adapter.setDirectory(new File(filesInDir));
        CompositeFileListFilter&lt;File&gt; filter = new CompositeFileListFilter&lt;&gt;();
        filter.addFilter(new AcceptOnceFileListFilter&lt;&gt;());
        filter.addFilter(new RegexPatternFileListFilter("[a-z]+.dat"));
        adapter.setFilter(filter);
        return adapter;
    }

    @Bean
    @ServiceActivator(inputChannel = "outChannel")
    public MessageHandler fileOutboundChannelAdapter() {
        FileWritingMessageHandler adapter = new FileWritingMessageHandler(new File(filesOutDir));
        adapter.setDeleteSourceFiles(true);
        adapter.setExpectReply(false);
        return adapter;
    }
}</pre>
      </div>
    </div>
    <br/>
    <div id="para-div">
      <p>Some aspects of the <span class="bold">Listing.36</span> from the above needs a little explanation.</p>
      <ul id="blue-sqr-ul">
        <li>
          <p>The annotation class <span class="hi-yellow">org.springframework.context.annotation.PropertySource</span> provides a
            convenient and declarative way of accessing external properties file(s) into the <span class="bold">Spring</span>
            environment</p>
        </li>
        <li>
          <p>The annotation class <span class="hi-yellow">org.springframework.beans.factory.annotation.Value</span> allows one to
            access any application specific configuration property defined in external properties file(s) (that are sourced via the
            annotation <span class="bold">PropertySource</span>)</p>
        </li>
        <li>
          <p>The file filter class <span class="hi-yellow">org.springframework.integration.file.filters.AcceptOnceFileListFilter</span>
            prevents duplicate processing of the source file(s)</p>
        </li>
        <li>
          <p>The file filter class <span class="hi-yellow">org.springframework.integration.file.filters.RegexPatternFileListFilter</span>
            encapsulates the regular expression pattern for the source file(s)</p>
        </li>
        <li>
          <p>The class <span class="hi-yellow">org.springframework.integration.file.filters.CompositeFileListFilter</span> evaluates
            a collection of file filter(s)</p>
        </li>
        <li>
          <p>The annotation class <span class="hi-yellow">org.springframework.integration.annotation.Poller</span> allows one to
            define a polled <span class="bold">endpoint</span> similar to the element <span class="bold">&lt;int:poller&gt;</span>
            from the <span class="bold">XML</span> configuration file of <span class="bold">Listing.33</span> above</p>
        </li>
        <li>
          <p>The annotation class <span class="hi-yellow">org.springframework.integration.annotation.InboundChannelAdapter</span>
            allows one to configure the inbound <span class="bold">channel adapter</span></p>
        </li>
        <li>
          <p>The class <span class="hi-yellow">org.springframework.integration.file.FileReadingMessageSource</span> is used to
            implement the input file source for the inbound <span class="bold">channel adapter</span></p>
        </li>
        <li>
          <p>The class <span class="hi-yellow">org.springframework.integration.file.FileWritingMessageHandler</span> is used to
            implement the outbound <span class="bold">channel adapter</span></p>
        </li>
      </ul>
    </div>
    <div id="para-div">
      <p>And finally, the following is the main application that uses the POJOs from <span class="bold">Listing.35</span> and
        <span class="bold">Listing.36</span> to test the file <span class="bold">channel adapter</span>:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Listing.37</div>
      <div class="src-body-1">
<pre>/*
 * Name:   FileProcessMainConfig
 * Author: Bhaskar S
 * Date:   05/01/2021
 * Blog:   https://polarsparc.github.io
 */

package com.polarsparc.si.p3;

import org.springframework.context.annotation.AnnotationConfigApplicationContext;

public class FileProcessMainConfig {
    public static void main(String[] args) {
        new AnnotationConfigApplicationContext(FileProcessHandler2.class, FileProcessConfig.class);
    }
}</pre>
      </div>
    </div>
    <br/>
    <div id="para-div">
      <p>To execute the code from <span class="bold">Listing.37</span>, open a terminal window and run the following commands:</p>
    </div>
    <div id="cmd-div">
      <p>$ cd $HOME/java/SpringIntegration</p>
      <p>$ mvn exec:java -Dexec.mainClass="com.polarsparc.si.p3.FileProcessMainConfig"</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.13</h4>
      <pre>[INFO] Scanning for projects...
[INFO] 
[INFO] ----------------&lt; com.polarsparc.si:SpringIntegration &gt;-----------------
[INFO] Building SpringIntegration 1.0
[INFO] --------------------------------[ jar ]---------------------------------
[INFO] 
[INFO] --- exec-maven-plugin:3.0.0:java (default-cli) @ SpringIntegration ---
2021-05-01 12:11:33:439 [com.polarsparc.si.p3.FileProcessMainConfig.main()] INFO org.springframework.integration.config.DefaultConfiguringBeanFactoryPostProcessor - No bean named 'errorChannel' has been explicitly defined. Therefore, a default PublishSubscribeChannel will be created.
2021-05-01 12:11:33:444 [com.polarsparc.si.p3.FileProcessMainConfig.main()] INFO org.springframework.integration.config.DefaultConfiguringBeanFactoryPostProcessor - No bean named 'taskScheduler' has been explicitly defined. Therefore, a default ThreadPoolTaskScheduler will be created.
2021-05-01 12:11:33:448 [com.polarsparc.si.p3.FileProcessMainConfig.main()] INFO org.springframework.integration.config.DefaultConfiguringBeanFactoryPostProcessor - No bean named 'integrationHeaderChannelRegistry' has been explicitly defined. Therefore, a default DefaultHeaderChannelRegistry will be created.
2021-05-01 12:11:33:485 [com.polarsparc.si.p3.FileProcessMainConfig.main()] INFO org.springframework.context.support.PostProcessorRegistrationDelegate$BeanPostProcessorChecker - Bean 'integrationChannelResolver' of type [org.springframework.integration.support.channel.BeanFactoryChannelResolver] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2021-05-01 12:11:33:489 [com.polarsparc.si.p3.FileProcessMainConfig.main()] INFO org.springframework.context.support.PostProcessorRegistrationDelegate$BeanPostProcessorChecker - Bean 'integrationDisposableAutoCreatedBeans' of type [org.springframework.integration.config.annotation.Disposables] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2021-05-01 12:11:33:702 [com.polarsparc.si.p3.FileProcessMainConfig.main()] INFO org.springframework.scheduling.concurrent.ThreadPoolTaskScheduler - Initializing ExecutorService 'taskScheduler'
2021-05-01 12:11:33:792 [com.polarsparc.si.p3.FileProcessMainConfig.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - Adding {logging-channel-adapter:_org.springframework.integration.errorLogger} as a subscriber to the 'errorChannel' channel
2021-05-01 12:11:33:793 [com.polarsparc.si.p3.FileProcessMainConfig.main()] INFO org.springframework.integration.channel.PublishSubscribeChannel - Channel 'org.springframework.context.annotation.AnnotationConfigApplicationContext@396abb96.errorChannel' has 1 subscriber(s).
2021-05-01 12:11:33:794 [com.polarsparc.si.p3.FileProcessMainConfig.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - started bean '_org.springframework.integration.errorLogger'
2021-05-01 12:11:33:794 [com.polarsparc.si.p3.FileProcessMainConfig.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - Adding {service-activator:fileProcessHandler2.handler.serviceActivator} as a subscriber to the 'inChannel' channel
2021-05-01 12:11:33:795 [com.polarsparc.si.p3.FileProcessMainConfig.main()] INFO org.springframework.integration.channel.DirectChannel - Channel 'org.springframework.context.annotation.AnnotationConfigApplicationContext@396abb96.inChannel' has 1 subscriber(s).
2021-05-01 12:11:33:796 [com.polarsparc.si.p3.FileProcessMainConfig.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - started bean 'fileProcessHandler2.handler.serviceActivator'
2021-05-01 12:11:33:796 [com.polarsparc.si.p3.FileProcessMainConfig.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - Adding {file:outbound-channel-adapter:fileProcessConfig.fileOutboundChannelAdapter.serviceActivator} as a subscriber to the 'outChannel' channel
2021-05-01 12:11:33:797 [com.polarsparc.si.p3.FileProcessMainConfig.main()] INFO org.springframework.integration.channel.DirectChannel - Channel 'org.springframework.context.annotation.AnnotationConfigApplicationContext@396abb96.outChannel' has 1 subscriber(s).
2021-05-01 12:11:33:798 [com.polarsparc.si.p3.FileProcessMainConfig.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - started bean 'fileProcessConfig.fileOutboundChannelAdapter.serviceActivator'
2021-05-01 12:11:33:802 [com.polarsparc.si.p3.FileProcessMainConfig.main()] INFO org.springframework.integration.endpoint.SourcePollingChannelAdapter - started bean 'fileProcessConfig.fileInboundChannelAdapter.inboundChannelAdapter'</pre>
    </div>
    <div id="para-div">
      <p>Once again, create a file called <span class="bold">abc.dat</span> in the directory <span class="bold">/tmp/in-dir</span> by
        executing the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ echo 'Spring Integration' &gt; /tmp/in-dir/abc.dat</p>
    </div>
    <div id="para-div">
      <p>We will see the following update in the terminal output:</p>
    </div>
    <div id="out-div">
      <h4>Output.14</h4>
      <pre>2021-05-01 12:13:33:818 [task-scheduler-3] INFO org.springframework.integration.handler.support.MessagingMethodInvokerHelper - Overriding default instance of MessageHandlerMethodFactory with provided one.
2021-05-01 12:13:33:824 [task-scheduler-3] INFO com.polarsparc.si.p3.FileProcessHandler2 - Processed input file: /tmp/in-dir/abc.dat, size: 19 (using Config)</pre>
    </div>
    <div id="para-div">
      <p>Now, create another file called <span class="bold">def.txt</span> in the directory <span class="bold">/tmp/in-dir</span> by
        executing the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ echo 'Ignored' &gt; /tmp/in-dir/def.txt</p>
    </div>
    <div id="para-div">
      <p>Nothing will happen as the file name does not match the pattern.</p>
    </div>
    <div id="para-div">
      <p>As can be inferred from the <span class="bold">Output.12</span> and <span class="bold">Output.14</span> above,
        <span class="bold">Spring Integration</span> successfully processed the two input files using the file <span class="bold">
        channel adapter</span>.</p>
    </div>
    <div id="step-div">
      <p>Transfer Files from a Remote Directory using SFTP</p>
    </div>
    <div id="para-div">
      <p>The Secure File Transfer Protocol (SFTP) is a network protocol that allows one to transfer file(s) between two computers
        over the network using a reliable network stream.</p>
      <p>In order to transfer file(s) using SFTP, a client (consumer) initiates a connection to a remote host running the SFTP server.
        For this demonstration, we will run the SFTP server using <span class="bold">docker</span>.</p>
    </div>
    <div id="para-div">
      <p>Assuming the currently logged in user-id is <span class="hi-grey">polarsparc</span>, to start the <span class="bold">SFTP
        </span> server, open a terminal window and execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ docker run --rm --name atmoz-sftp -v $HOME/Downloads/sftp/sftp_rsa_key.pub:/home/polarsparc/.ssh/keys/sftp_rsa_key.pub:ro -v $HOME/Downloads/sftp/share:/home/polarsparc/ -p 2222:22 -d atmoz/sftp polarsparc:polarsparc:1000</p>
    </div>
    <div id="para-div">
      <p>The following are the contents of the properties file <span class="bold">sftp.properties</span>:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Listing.38</div>
      <div class="src-body-1">
<pre>#
# Properties for sftp processing
#

sftp.host=localhost
sftp.port=2222
sftp.username=polarsparc
sftp.privateKey=classpath:META-INF/keys/sftp_rsa_key
sftp.allowUnknownKeys=true
sftp.file.pattern=*.dat
sftp.remote.dir=.
sftp.local.dir=/tmp/out-dir</pre>
      </div>
    </div>
    <br/>
    <table id="step-table">
      <tbody>
        <tr>
          <td class="text-td">XML based Approach</td>
          <td class="pointer-td"></td>
        </tr>
      </tbody>
    </table>
    <div id="para-div">
      <p>For processing the files from the <span class="bold">SFTP</span> site, we will leverage the same POJO defined in
        <span class="bold">Listing.32</span> above.</p>
    </div>
    <div id="para-div">
      <p>The following is the <span class="bold">XML</span> based <span class="bold">Spring Integration</span> configuration that
        wires up a <span class="bold">SFTP</span> session factory, the necessary <span class="bold">channel</span>s, the sftp
        <span class="bold">channel adapter</span>, and the <span class="bold">endpoint</span>:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Listing.39</div>
      <div class="src-body-1">
<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;beans xmlns="http://www.springframework.org/schema/beans"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:context="http://www.springframework.org/schema/context"
        xmlns:int="http://www.springframework.org/schema/integration"
        xmlns:sftp="http://www.springframework.org/schema/integration/sftp"
        xsi:schemaLocation="http://www.springframework.org/schema/beans
                            http://www.springframework.org/schema/beans/spring-beans.xsd
                            http://www.springframework.org/schema/context
                            http://www.springframework.org/schema/context/spring-context.xsd
                            http://www.springframework.org/schema/integration
                            http://www.springframework.org/schema/integration/spring-integration.xsd
                            http://www.springframework.org/schema/integration/sftp
                            http://www.springframework.org/schema/integration/sftp/spring-integration-sftp.xsd"&gt;

    &lt;context:property-placeholder location="classpath:p3/sftp.properties" /&gt;

    &lt;bean id="inFileHandler" class="com.polarsparc.si.p3.FileProcessHandler" /&gt;

    &lt;bean id="sftpSessionFactory" class="org.springframework.integration.sftp.session.DefaultSftpSessionFactory"&gt;
        &lt;property name="host" value="${sftp.host}" /&gt;
        &lt;property name="port" value="${sftp.port}" /&gt;
        &lt;property name="user" value="${sftp.username}" /&gt;
        &lt;property name="privateKey" value="${sftp.privateKey}" /&gt;
        &lt;property name="allowUnknownKeys" value="${sftp.allowUnknownKeys}" /&gt;
    &lt;/bean&gt;

    &lt;sftp:inbound-channel-adapter id="sftpInBound"
                                  channel="inChannel"
                                  session-factory="sftpSessionFactory"
                                  filename-pattern="${sftp.file.pattern}"
                                  delete-remote-files="false"
                                  remote-directory="${sftp.remote.dir}"
                                  local-directory="${sftp.local.dir}"&gt;
        &lt;int:poller id="poller" fixed-rate="5000" /&gt;
    &lt;/sftp:inbound-channel-adapter&gt;

    &lt;int:service-activator input-channel="inChannel"
                            output-channel="nullChannel"
                            ref="inFileHandler"
                            method="handler" /&gt;

&lt;/beans&gt;</pre>
      </div>
    </div>
    <br/>
    <div id="para-div">
      <p>Some aspects of the <span class="bold">Listing.39</span> from the above needs a little explanation.</p>
      <ul id="blue-sqr-ul">
        <li>
          <p>The <span class="bold">Spring Integration</span> class
            <span class="hi-yellow">org.springframework.integration.sftp.session.DefaultSftpSessionFactory</span> is the default
            <span class="bold">SFTP</span> session factory implementation that allows one to open an <span class="bold">SFTP</span>
            network connection with the <span class="bold">SFTP</span> server. The default <span class="bold">Spring Integration</span>
            session factory uses a separate physical connection for each channel. The property
            <span class="hi-green">allowUnknownKeys</span> allows connections from hosts with unknown (or changed) keys. By default,
            it is set to <span class="bold">false</span></p>
        </li>
        <li>
          <p>The sftp <span class="hi-yellow">inbound-channel-adapter</span> element allows one to connect to an <span class="bold">
            SFTP</span> server using the session factory specified via the attribute <span class="hi-green">session-factory</span>
            and scan for file(s) with the pattern as specified by the attribute <span class="hi-green">filename-pattern</span> in the
            remote directory location as specified by the attribute <span class="hi-green">remote-directory</span>. The remote file(s)
            from the <span class="bold">SFTP</span> server are downloaded to the local directory as specified by the attribute
            <span class="hi-green">local-directory</span>. The <span class="hi-green">delete-remote-files</span> attribute when set
            to <span class="bold">true</span>, will delete the file(s) from the remote directory after the successful download</p>
        </li>
      </ul>
    </div>
    <div id="para-div">
      <p>The following is our main application to test the sftp <span class="bold">channel adapter</span>:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Listing.40</div>
      <div class="src-body-1">
<pre>/*
 * Name:   SftpProcessMainXml
 * Author: Bhaskar S
 * Date:   05/01/2021
 * Blog:   https://polarsparc.github.io
 */

package com.polarsparc.si.p3;

import org.springframework.context.support.ClassPathXmlApplicationContext;

public class SftpProcessMainXml {
    public static void main(String[] args) {
        new ClassPathXmlApplicationContext("p3/SftpProcess.xml");
    }
}</pre>
      </div>
    </div>
    <br/>
    <div id="para-div">
      <p>To execute the code from <span class="bold">Listing.40</span>, open a terminal window and run the following commands:</p>
    </div>
    <div id="cmd-div">
      <p>$ cd $HOME/java/SpringIntegration</p>
      <p>$ mvn exec:java -Dexec.mainClass="com.polarsparc.si.p3.SftpProcessMainXml"</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.15</h4>
      <pre>[INFO] Scanning for projects...
[INFO] 
[INFO] ----------------&lt; com.polarsparc.si:SpringIntegration &gt;-----------------
[INFO] Building SpringIntegration 1.0
[INFO] --------------------------------[ jar ]---------------------------------
[INFO] 
[INFO] --- exec-maven-plugin:3.0.0:java (default-cli) @ SpringIntegration ---
2021-05-01 12:51:32:146 [com.polarsparc.si.p3.SftpProcessMainXml.main()] INFO org.springframework.integration.config.DefaultConfiguringBeanFactoryPostProcessor - No bean named 'errorChannel' has been explicitly defined. Therefore, a default PublishSubscribeChannel will be created.
2021-05-01 12:51:32:152 [com.polarsparc.si.p3.SftpProcessMainXml.main()] INFO org.springframework.integration.config.DefaultConfiguringBeanFactoryPostProcessor - No bean named 'taskScheduler' has been explicitly defined. Therefore, a default ThreadPoolTaskScheduler will be created.
2021-05-01 12:51:32:156 [com.polarsparc.si.p3.SftpProcessMainXml.main()] INFO org.springframework.integration.config.DefaultConfiguringBeanFactoryPostProcessor - No bean named 'integrationHeaderChannelRegistry' has been explicitly defined. Therefore, a default DefaultHeaderChannelRegistry will be created.
2021-05-01 12:51:32:384 [com.polarsparc.si.p3.SftpProcessMainXml.main()] INFO org.springframework.scheduling.concurrent.ThreadPoolTaskScheduler - Initializing ExecutorService 'taskScheduler'
2021-05-01 12:51:32:411 [com.polarsparc.si.p3.SftpProcessMainXml.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - Adding {service-activator} as a subscriber to the 'inChannel' channel
2021-05-01 12:51:32:412 [com.polarsparc.si.p3.SftpProcessMainXml.main()] INFO org.springframework.integration.channel.DirectChannel - Channel 'org.springframework.context.support.ClassPathXmlApplicationContext@4278a583.inChannel' has 1 subscriber(s).
2021-05-01 12:51:32:413 [com.polarsparc.si.p3.SftpProcessMainXml.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - started bean 'org.springframework.integration.config.ConsumerEndpointFactoryBean#0'
2021-05-01 12:51:32:413 [com.polarsparc.si.p3.SftpProcessMainXml.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - Adding {logging-channel-adapter:_org.springframework.integration.errorLogger} as a subscriber to the 'errorChannel' channel
2021-05-01 12:51:32:414 [com.polarsparc.si.p3.SftpProcessMainXml.main()] INFO org.springframework.integration.channel.PublishSubscribeChannel - Channel 'org.springframework.context.support.ClassPathXmlApplicationContext@4278a583.errorChannel' has 1 subscriber(s).
2021-05-01 12:51:32:415 [com.polarsparc.si.p3.SftpProcessMainXml.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - started bean '_org.springframework.integration.errorLogger'
2021-05-01 12:51:32:418 [com.polarsparc.si.p3.SftpProcessMainXml.main()] INFO org.springframework.integration.endpoint.SourcePollingChannelAdapter - started bean 'sftpInBound'; defined in: 'class path resource [p3/SftpProcess.xml]'; from source: ''sftp:inbound-channel-adapter' with id='sftpInBound''
2021-05-01 12:51:32:665 [task-scheduler-1] INFO org.springframework.integration.sftp.session.DefaultSftpSessionFactory - The authenticity of host 'localhost' can't be established.
RSA key fingerprint is f6:24:d1:19:a9:4e:8d:6b:47:15:36:54:55:31:44:21.
Are you sure you want to continue connecting?
2021-05-01 12:51:32:666 [task-scheduler-1] WARN com.jcraft.jsch - Permanently added 'localhost' (RSA) to the list of known hosts.</pre>
    </div>
    <div id="para-div">
      <p>Create a file called <span class="bold">abc.dat</span> in the directory <span class="bold">/tmp/in-dir</span> and transfer
        to the sftp remote directory by executing the following commands:</p>
    </div>
    <div id="cmd-div">
      <p>$ echo 'Spring Integration' &gt; /tmp/in-dir/abc.dat</p>
      <p>$ sudo mv /tmp/in-dir/abc.dat $HOME/Downloads/DATA/sftp/share</p>
    </div>
    <div id="para-div">
      <p>We will see the following update in the terminal output:</p>
    </div>
    <div id="out-div">
      <h4>Output.16</h4>
      <pre>2021-05-01 12:55:32:801 [task-scheduler-3] INFO org.springframework.integration.handler.support.MessagingMethodInvokerHelper - Overriding default instance of MessageHandlerMethodFactory with provided one.
2021-05-01 12:55:32:805 [task-scheduler-3] INFO com.polarsparc.si.p3.FileProcessHandler - Processed input file: /tmp/out-dir/abc.dat, size: 19 (using Xml)</pre>
    </div>
    <div id="para-div">
      <p>Now, create another file called <span class="bold">def.txt</span> in the directory <span class="bold">/tmp/in-dir</span> and
        transfer to the sftp remote directory by executing the following commands:</p>
    </div>
    <div id="cmd-div">
      <p>$ echo 'Ignored' &gt; /tmp/in-dir/def.txt</p>
      <p>$ sudo mv /tmp/in-dir/def.txt $HOME/Downloads/DATA/sftp/share</p>
    </div>
    <div id="para-div">
      <p>Nothing will happen as the file name does not match the pattern.</p>
    </div>
    <table id="step-table">
      <tbody>
        <tr>
          <td class="text-td">Java Config based Approach</td>
          <td class="pointer-td"></td>
        </tr>
      </tbody>
    </table>
    <div id="para-div">
      <p>The following is the Java Config based POJO that defines the file handler <span class="bold">endpoint</span> that displays
        the file name and file size:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Listing.41</div>
      <div class="src-body-1">
<pre>/*
 * Name:   FileProcessHandler3
 * Author: Bhaskar S
 * Date:   05/01/2021
 * Blog:   https://polarsparc.github.io
 */

package com.polarsparc.si.p3;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.context.annotation.Configuration;
import org.springframework.integration.annotation.ServiceActivator;
import org.springframework.integration.config.EnableIntegration;

import java.io.File;

@Configuration
@EnableIntegration
public class FileProcessHandler3 {
    private static final Logger LOGGER = LoggerFactory.getLogger(FileProcessHandler3.class);

    @ServiceActivator(inputChannel = "inChannel", outputChannel = "nullChannel")
    public File handler(File input) {
        LOGGER.info("Processed input file: {}, size: {} (using Config)", input.getAbsolutePath(), input.length());

        return input;
    }
}</pre>
      </div>
    </div>
    <br/>
    <div id="para-div">
      <p>The following is the Java Config based POJO refers to the external <span class="bold">sftp.properties</span> file and defines
        the <span class="bold">SFTP</span> session factory, the sftp <span class="bold">channel adapter</span>, and the
        <span class="bold">endpoint</span> similar to the way defined in the <span class="bold">XML</span> configuration file of
        <span class="bold">Listing.39</span> above:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Listing.42</div>
      <div class="src-body-1">
<pre>/*
 * Name:   SftpProcessConfig
 * Author: Bhaskar S
 * Date:   04/24/2021
 * Blog:   https://polarsparc.github.io
 */

package com.polarsparc.si.p3;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.PropertySource;
import org.springframework.core.io.Resource;
import org.springframework.integration.annotation.InboundChannelAdapter;
import org.springframework.integration.annotation.Poller;
import org.springframework.integration.config.EnableIntegration;
import org.springframework.integration.core.MessageSource;
import org.springframework.integration.file.filters.AcceptOnceFileListFilter;
import org.springframework.integration.sftp.filters.SftpSimplePatternFileListFilter;
import org.springframework.integration.sftp.inbound.SftpInboundFileSynchronizer;
import org.springframework.integration.sftp.inbound.SftpInboundFileSynchronizingMessageSource;
import org.springframework.integration.sftp.session.DefaultSftpSessionFactory;

import java.io.File;

@Configuration
@EnableIntegration
@PropertySource("classpath:p3/sftp.properties")
public class SftpProcessConfig {
    private static final Logger LOGGER = LoggerFactory.getLogger(SftpProcessConfig.class);

    @Value("${sftp.host}")
    private String sftpHost;

    @Value("${sftp.port:22}")
    private int sftpPort;

    @Value("${sftp.username}")
    private String sftpUser;

    @Value("${sftp.privateKey}")
    private Resource sftpPrivateKey;

    @Value("${sftp.allowUnknownKeys}")
    private boolean sftpAllowUnknownKeys;

    @Value("${sftp.remote.dir}")
    private String sftpRemoteDir;

    @Value("${sftp.local.dir}")
    private String sftpLocalDir;

    @Value("${sftp.file.pattern}")
    private String sftpFilePattern;

    @Bean
    public DefaultSftpSessionFactory sftpSessionFactory() {
        LOGGER.info(String.format("Host: %s, Port: %d, User: %s", sftpHost, sftpPort, sftpUser));

        DefaultSftpSessionFactory factory = new DefaultSftpSessionFactory();
        factory.setHost(sftpHost);
        factory.setPort(sftpPort);
        factory.setUser(sftpUser);
        factory.setPrivateKey(sftpPrivateKey);
        factory.setAllowUnknownKeys(sftpAllowUnknownKeys);
        return factory;
    }

    @Bean
    public SftpInboundFileSynchronizer sftpFileSynchronizer() {
        LOGGER.info(String.format("Remote Dir: %s", sftpRemoteDir));

        SftpInboundFileSynchronizer synchronizer = new SftpInboundFileSynchronizer(sftpSessionFactory());
        synchronizer.setDeleteRemoteFiles(false);
        synchronizer.setRemoteDirectory(sftpRemoteDir);
        synchronizer.setFilter(new SftpSimplePatternFileListFilter(sftpFilePattern));
        return synchronizer;
    }

    @Bean
    @InboundChannelAdapter(channel = "inChannel", poller = @Poller(fixedDelay = "5000"))
    public MessageSource&lt;File&gt; sftpChannelAdapter() {
        LOGGER.info(String.format("Local Dir: %s", sftpLocalDir));

        SftpInboundFileSynchronizingMessageSource adapter =
                new SftpInboundFileSynchronizingMessageSource(sftpFileSynchronizer());
        adapter.setLocalDirectory(new File(sftpLocalDir));
        adapter.setMaxFetchSize(1);
        adapter.setLocalFilter(new AcceptOnceFileListFilter&lt;File&gt;());
        return adapter;
    }
}</pre>
      </div>
    </div>
    <br/>
    <div id="para-div">
      <p>Some aspects of the <span class="bold">Listing.42</span> from the above needs a little explanation.</p>
      <ul id="blue-sqr-ul">
        <li>
          <p>The class <span class="hi-yellow">org.springframework.integration.sftp.inbound.SftpInboundFileSynchronizer</span> uses
            the <span class="bold">SFTP</span> session factory to manage the <span class="bold">SFTP</span> connection and handle
            the synchronization between a remote <span class="bold">SFTP</span> directory and a local directory</p>
        </li>
        <li>
          <p>The file filter class <span class="hi-yellow">org.springframework.integration.sftp.filters.SftpSimplePatternFileListFilter</span>
            supports <span class="bold">ant</span> style patterns for the source file(s)</p>
        </li>
        <li>
          <p>The class <span class="hi-yellow">org.springframework.integration.sftp.inbound.SftpInboundFileSynchronizingMessageSource</span>
            implements the inbound <span class="bold">channel adapter</span> for <span class="bold">SFTP</span> file synchronization</p>
        </li>
        <li>
          <p>The file filter class <span class="hi-yellow">org.springframework.integration.file.filters.AcceptOnceFileListFilter</span>
            prevents duplicate processing of the source file(s)</p>
        </li>
      </ul>
    </div>
    <div id="para-div">
      <p>And finally, the following is the main application that uses the POJOs from <span class="bold">Listing.41</span> and
        <span class="bold">Listing.42</span> to test the sftp <span class="bold">channel adapter</span>:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Listing.43</div>
      <div class="src-body-1">
<pre>/*
 * Name:   SftpProcessMainConfig
 * Author: Bhaskar S
 * Date:   05/01/2021
 * Blog:   https://polarsparc.github.io
 */

package com.polarsparc.si.p3;

import org.springframework.context.annotation.AnnotationConfigApplicationContext;

public class SftpProcessMainConfig {
    public static void main(String[] args) {
        new AnnotationConfigApplicationContext(FileProcessHandler3.class, SftpProcessConfig.class);
    }
}</pre>
      </div>
    </div>
    <br/>
    <div id="para-div">
      <p>To execute the code from <span class="bold">Listing.43</span>, open a terminal window and run the following commands:</p>
    </div>
    <div id="cmd-div">
      <p>$ cd $HOME/java/SpringIntegration</p>
      <p>$ mvn exec:java -Dexec.mainClass="com.polarsparc.si.p3.SftpProcessMainConfig"</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.17</h4>
      <pre>[INFO] Scanning for projects...
[INFO] 
[INFO] ----------------&lt; com.polarsparc.si:SpringIntegration &gt;-----------------
[INFO] Building SpringIntegration 1.0
[INFO] --------------------------------[ jar ]---------------------------------
[INFO] 
[INFO] --- exec-maven-plugin:3.0.0:java (default-cli) @ SpringIntegration ---
2021-05-01 13:04:51:311 [com.polarsparc.si.p3.SftpProcessMainConfig.main()] INFO org.springframework.integration.config.DefaultConfiguringBeanFactoryPostProcessor - No bean named 'errorChannel' has been explicitly defined. Therefore, a default PublishSubscribeChannel will be created.
2021-05-01 13:04:51:317 [com.polarsparc.si.p3.SftpProcessMainConfig.main()] INFO org.springframework.integration.config.DefaultConfiguringBeanFactoryPostProcessor - No bean named 'taskScheduler' has been explicitly defined. Therefore, a default ThreadPoolTaskScheduler will be created.
2021-05-01 13:04:51:321 [com.polarsparc.si.p3.SftpProcessMainConfig.main()] INFO org.springframework.integration.config.DefaultConfiguringBeanFactoryPostProcessor - No bean named 'integrationHeaderChannelRegistry' has been explicitly defined. Therefore, a default DefaultHeaderChannelRegistry will be created.
2021-05-01 13:04:51:358 [com.polarsparc.si.p3.SftpProcessMainConfig.main()] INFO org.springframework.context.support.PostProcessorRegistrationDelegate$BeanPostProcessorChecker - Bean 'integrationChannelResolver' of type [org.springframework.integration.support.channel.BeanFactoryChannelResolver] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2021-05-01 13:04:51:362 [com.polarsparc.si.p3.SftpProcessMainConfig.main()] INFO org.springframework.context.support.PostProcessorRegistrationDelegate$BeanPostProcessorChecker - Bean 'integrationDisposableAutoCreatedBeans' of type [org.springframework.integration.config.annotation.Disposables] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2021-05-01 13:04:51:488 [com.polarsparc.si.p3.SftpProcessMainConfig.main()] INFO com.polarsparc.si.p3.SftpProcessConfig - Host: localhost, Port: 2222, User: bswamina
2021-05-01 13:04:51:495 [com.polarsparc.si.p3.SftpProcessMainConfig.main()] INFO com.polarsparc.si.p3.SftpProcessConfig - Remote Dir: .
2021-05-01 13:04:51:509 [com.polarsparc.si.p3.SftpProcessMainConfig.main()] INFO com.polarsparc.si.p3.SftpProcessConfig - Local Dir: /tmp/out-dir
2021-05-01 13:04:51:575 [com.polarsparc.si.p3.SftpProcessMainConfig.main()] INFO org.springframework.scheduling.concurrent.ThreadPoolTaskScheduler - Initializing ExecutorService 'taskScheduler'
2021-05-01 13:04:51:653 [com.polarsparc.si.p3.SftpProcessMainConfig.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - Adding {logging-channel-adapter:_org.springframework.integration.errorLogger} as a subscriber to the 'errorChannel' channel
2021-05-01 13:04:51:654 [com.polarsparc.si.p3.SftpProcessMainConfig.main()] INFO org.springframework.integration.channel.PublishSubscribeChannel - Channel 'org.springframework.context.annotation.AnnotationConfigApplicationContext@396abb96.errorChannel' has 1 subscriber(s).
2021-05-01 13:04:51:655 [com.polarsparc.si.p3.SftpProcessMainConfig.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - started bean '_org.springframework.integration.errorLogger'
2021-05-01 13:04:51:655 [com.polarsparc.si.p3.SftpProcessMainConfig.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - Adding {service-activator:fileProcessHandler3.handler.serviceActivator} as a subscriber to the 'inChannel' channel
2021-05-01 13:04:51:656 [com.polarsparc.si.p3.SftpProcessMainConfig.main()] INFO org.springframework.integration.channel.DirectChannel - Channel 'org.springframework.context.annotation.AnnotationConfigApplicationContext@396abb96.inChannel' has 1 subscriber(s).
2021-05-01 13:04:51:657 [com.polarsparc.si.p3.SftpProcessMainConfig.main()] INFO org.springframework.integration.endpoint.EventDrivenConsumer - started bean 'fileProcessHandler3.handler.serviceActivator'
2021-05-01 13:04:51:660 [com.polarsparc.si.p3.SftpProcessMainConfig.main()] INFO org.springframework.integration.endpoint.SourcePollingChannelAdapter - started bean 'sftpProcessConfig.sftpChannelAdapter.inboundChannelAdapter'
2021-05-01 13:04:51:885 [task-scheduler-1] INFO org.springframework.integration.sftp.session.DefaultSftpSessionFactory - The authenticity of host 'localhost' can't be established.
RSA key fingerprint is f6:24:d1:19:a9:4e:8d:6b:47:15:36:54:55:31:44:21.
Are you sure you want to continue connecting?
2021-05-01 13:04:51:886 [task-scheduler-1] WARN com.jcraft.jsch - Permanently added 'localhost' (RSA) to the list of known hosts.</pre>
    </div>
    <div id="para-div">
      <p>Once again, create a file called <span class="bold">abc.dat</span> in the directory <span class="bold">/tmp/in-dir</span> and
        transfer to the sftp remote directory by executing the following commands:</p>
    </div>
    <div id="cmd-div">
      <p>$ echo 'Spring Integration' &gt; /tmp/in-dir/abc.dat</p>
      <p>$ sudo mv /tmp/in-dir/abc.dat $HOME/Downloads/DATA/sftp/share</p>
    </div>
    <div id="para-div">
      <p>We will see the following update in the terminal output:</p>
    </div>
    <div id="out-div">
      <h4>Output.18</h4>
      <pre>2021-05-01 13:07:11:763 [task-scheduler-2] INFO org.springframework.integration.handler.support.MessagingMethodInvokerHelper - Overriding default instance of MessageHandlerMethodFactory with provided one.
2021-05-01 13:07:11:766 [task-scheduler-2] INFO com.polarsparc.si.p3.FileProcessHandler3 - Processed input file: /tmp/out-dir/abc.dat, size: 19 (using Config)</pre>
    </div>
    <div id="para-div">
      <p>Now, create another file called <span class="bold">def.txt</span> in the directory <span class="bold">/tmp/in-dir</span> and
        transfer to the sftp remote directory by executing the following commands:</p>
    </div>
    <div id="cmd-div">
      <p>$ echo 'Ignored' &gt; /tmp/in-dir/def.txt</p>
      <p>$ sudo mv /tmp/in-dir/def.txt $HOME/Downloads/DATA/sftp/share</p>
    </div>
    <div id="para-div">
      <p>Nothing will happen as the file name does not match the pattern.</p>
    </div>
    <div id="para-div">
      <p>As can be inferred from the <span class="bold">Output.16</span> and <span class="bold">Output.18</span> above,
        <span class="bold">Spring Integration</span> successfully transferred and processed the two files.</p>
    </div>
    <div id="section-div">
      <p>References</p>
    </div>
    <div id="para-div">
      <p><a target="_blank" href="https://polarsparc.github.io/SpringIntegration/SpringIntegration-02.html"><span class="bold">Spring Integration Notes :: Part - 2</span></a></p>
      <p><a target="_blank" href="https://polarsparc.github.io/SpringIntegration/SpringIntegration-01.html"><span class="bold">Spring Integration Notes :: Part - 1</span></a></p>
      <p><a target="_blank" href="https://docs.spring.io/spring-integration/reference/html/file.html"><span class="bold">Spring Integration - File Support</span></a></p>
      <p><a target="_blank" href="https://docs.spring.io/spring-integration/docs/current/reference/html/sftp.html"><span class="bold">Spring Integration - SFTP Adapters</span></a></p>
    </div>
    <br/>
    <hr class="line-hr" />
    <div>
      <a id="footer-a" href="https://polarsparc.github.io/">&copy;&nbsp;PolarSPARC</a>
    </div>
  </body>
</html>
