<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="application/xhtml+xml; charset=windows-1252" />
    <meta name="author" content="Bhaskar.S">
    <meta name="description" content="Fundamentals of Linux iptables Firewall">
    <meta name="subject" content="Fundamentals of Linux iptables Firewall">
    <meta name="keywords" content="firewall, iptables, linux, networking, security">
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <title>Fundamentals of Linux iptables Firewall</title>
    <link href="../css/polarsparc-v2.4.css" type="text/css" rel="stylesheet" />
  </head>
  <body>
    <br/>
    <table borber="0">
      <tr>
        <td valign="bottom"><span id="ps-home"></span></td>
        <td valign="bottom"><span id="home-a"><a id="home-a" href="https://polarsparc.github.io/">PolarSPARC</a></span></td>
      </tr>
    </table>
    <br/>
    <div id="title-div">
      <p>Fundamentals of Linux iptables Firewall</p>
    </div>
    <br/>
    <table id="ad-table">
      <tbody>
        <tr>
          <td class="author-td">Bhaskar S</td>
          <td class="date-td">11/22/2020</td>
        </tr>
      </tbody>
    </table>
    <hr class="line-hr" />
    <br />
    <div id="section-div">
      <p>Overview</p>
    </div>
    <div id="para-div">
      <p>In networking, a <span class="hi-yellow">Firewall</span> is a security protection system, through which all network traffic
        is routed, to monitor and control the flow of network traffic coming in or going out using a set of rules. In other words,
        a firewall is used to enforce the security policies in a network.</p>
      <p>A network firewall is also referred to as a <span class="hi-yellow">Packet Filter</span>, which basically implies inspect and
        regulate all network packets traversing between the nodes in the network.</p>
      <p><span class="hi-yellow"><a href="https://www.netfilter.org/" target="_blank"><span class="bold">netfilter</span></a></span>
        is a Linux kernel space networking framework, with various hooks for performing different network inspections and operations,
        such that it provides the firewall functionality required for monitoring and directing packets in the network.</p>
      <p><span class="hi-yellow">iptables</span> is a user-space command-line interface for netfilter that allows system adminstrators
        to add, modify, or remove packet filtering rules.</p>
    </div>
    <div id="para-div">
      <p>To level set on the networking basics, the following are some of terms used in this article:</p>
    </div>
    <br/>
    <table id="col2-table">
      <thead>
        <tr>
          <th>Term</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="col2-c1-odd"><span class="bold">Ethernet</span></td>
          <td class="col2-c2-odd">a family of computer networking protocols used for communication between nodes in a network</td>
        </tr>
        <tr>
          <td class="col2-c1-even"><span class="bold">NIC</span></td>
          <td class="col2-c2-even"><span class="bold">N</span>etwork <span class="bold">I</span>nterface <span class="bold">C</span>ontroller
            (or Card) is a physical device that connects a system to the network</td>
        </tr>
        <tr>
          <td class="col2-c1-odd"><span class="bold">MAC Address</span></td>
          <td class="col2-c2-odd"><span class="bold">M</span>edia <span class="bold">A</span>ccess <span class="bold">C</span>ontrol
            address is a globally unique address assigned to a NIC and used by the Ethernet protocol</td>
        </tr>
        <tr>
          <td class="col2-c1-even"><span class="bold">IP</span></td>
          <td class="col2-c2-even">stands for <span class="bold">I</span>nternet <span class="bold">P</span>rotocol and is the
            standard of internet communication</td>
        </tr>
        <tr>
          <td class="col2-c1-odd"><span class="bold">ICMP</span></td>
          <td class="col2-c2-odd">stands for <span class="bold">I</span>nternet <span class="bold">C</span>ontrol
            <span class="bold">M</span>essage <span class="bold">P</span>rotocol and is used for exchaning informational data
            on the success or failure of communication between systems in the network</td>
        </tr>
        <tr>
          <td class="col2-c1-even"><span class="bold">IP Address</span></td>
          <td class="col2-c2-even">a logical numerical label assigned to each system on the IP network</td>
        </tr>
        <tr>
          <td class="col2-c1-odd"><span class="bold">IPv4</span></td>
          <td class="col2-c2-odd">a 32-bit IP address that is often represented using the form A.B.C.D, where A, B, C, and D can
            have a value from 0 through 255. Example: 192.168.1.56</td>
        </tr>
        <tr>
          <td class="col2-c1-even"><span class="bold">TCP</span></td>
          <td class="col2-c2-even">stands for <span class="bold">T</span>ransmission <span class="bold">C</span>ontrol
            <span class="bold">P</span>rotocol and is part of the IP protocol suite that is a connection-oriented, meaning, a
            connection channel must be established between two systems before data can be exchanged</td>
        </tr>
        <tr>
          <td class="col2-c1-odd"><span class="bold">UDP</span></td>
          <td class="col2-c2-odd">stands for <span class="bold">U</span>ser <span class="bold">D</span>atagram
            <span class="bold">P</span>rotocol and is part of the IP protocol suite that is a connectionless, meaning, data
            can be exchanged between two systems without establishing any connection channel</td>
        </tr>
        <tr>
          <td class="col2-c1-even"><span class="bold">NAT</span></td>
          <td class="col2-c2-even">stands for <span class="bold">N</span>etwork <span class="bold">A</span>ddress
            <span class="bold">T</span>ranslation and is a method of mapping an IP address to another in the network</td>
        </tr>
      </tbody>
    </table>
    <br/>
    <div id="para-div">
      <p>The following diagram illustrates the <span class="hi-yellow">OSI Network Model</span> and the simplified
        <span class="hi-yellow">TCP/IP Network Model</span>:</p>
    </div>
    <br/>
    <div id="img-outer-div"> <img src="./images/iptables-1.png" class="img-cls" alt="Network Models" />
      <div class="img-cap">Figure.1</div>
    </div>
    <br/>
    <div id="para-div">
      <p>In the Figure.1 above, the diagram on the left is the general OSI Network Model, while the diagram on the right is the
        simplified TCP/IP Network Model. The following are the descriptions of the layers from the simplified TCP/IP Network
        Model:</p>
    </div>
    <div id="para-div">
      <ul id="blue-sqr-ul">
        <li>
          <p>The <span class="hi-vanila">Physical</span> layer is associated with the physical network cabling and hardware</p>
        </li>
        <li>
          <p>The <span class="hi-vanila">Data Link</span> layer is responsible for the transmission of the data over the underlying
            link protocol such as Ethernet using MAC addresses</p>
        </li>
        <li>
          <p>The <span class="hi-vanila">Network</span> layer is responsible for dealing with the IP addressing, ICMP messages, and
            routing of data in the network</p>
        </li>
        <li>
          <p>The <span class="hi-vanila">Transport</span> layer provides support for TCP and UDP protocols that are responsible for
            providing services for system to system communication as well as services for congestion control, flow control, and
            multiplexing</p>
        </li>
      </ul>
    </div>
    <div id="para-div">
      <p>The packet filtering mechanism provided by <span class="bold">iptables</span> is organized into <span class="underbold">4</span>
        core components:</p>
      <ul id="blue-ol">
        <li>
          <p><span class="hi-green">Table</span> :: used for organizing a set of rules and is defined based on the type of packet
            processing they perform</p>
        </li>
        <li>
          <p><span class="hi-green">Chain</span> :: allows one to inspect traffic at various points, such as when they just arrive
            on the NIC or just before they are handed over to a process</p>
        </li>
        <li>
          <p><span class="hi-green">Rule</span> :: statement that tells the system what to do with the network packet</p>
        </li>
        <li>
          <p><span class="hi-green">Target</span> :: decides the destiny of a packet once a rule matches - either allow it or reject
            it</p>
        </li>
      </ul>
    </div>
    <div id="para-div">
      <p>There are <span class="underbold">4</span> types of tables defined in <span class="bold">iptables</span>:</p>
    </div>
    <div id="para-div">
      <ul id="blue-sqr-ul">
        <li>
          <p><span class="hi-yellow">raw</span> :: used for tracking packets based on their state</p>
        </li>
        <li>
          <p><span class="hi-yellow">mangle</span> :: used to alter IP headers</p>
        </li>
        <li>
          <p><span class="hi-yellow">nats</span> :: used to translation of the source or destination IP address</p>
        </li>
        <li>
          <p><span class="hi-yellow">filter</span> :: is the <span class="underbold">default</span> table and is used for filtering
            packets</p>
        </li>
      </ul>
    </div>
    <div id="para-div">
      <p>There are <span class="underbold">5</span> types of chains defined in <span class="bold">iptables</span>:</p>
    </div>
    <div id="para-div">
      <ul id="blue-ol">
        <li>
          <p><span class="hi-blue">PREROUTING</span> :: used to process packets as they arrive on the NIC for destination NAT or port
            forwarding</p>
        </li>
        <li>
          <p><span class="hi-blue">INPUT</span> :: used for processing incoming packets to a system</p>
        </li>
        <li>
          <p><span class="hi-blue">OUTPUT</span> :: used on packets originating from a system to be transmitted out</p>
        </li>
        <li>
          <p><span class="hi-blue">FORWARD</span> :: used on packets that are routed through a system</p>
        </li>
        <li>
          <p><span class="hi-blue">POSTROUTING</span> :: used to process packets as they are about to leave the NIC for source NAT
            (sometimes referred to as IP <span class="hi-yellow">masquerade</span>)</p>
        </li>
      </ul>
    </div>
    <div id="para-div">
      <p>There are <span class="underbold">3</span> types of targets defined in <span class="bold">iptables</span>:</p>
    </div>
    <div id="para-div">
      <ul id="blue-sqr-ul">
        <li>
          <p><span class="hi-grey">ACCEPT</span> :: causes the packet to be accepted</p>
        </li>
        <li>
          <p><span class="hi-grey">DROP</span> :: causes the packet to be dropped silently</p>
        </li>
        <li>
          <p><span class="hi-grey">REJECT</span> :: causes the packet to be rejected and respond with an ICMP reply</p>
        </li>
      </ul>
    </div>
    <div id="para-div">
      <p>At a high-level, when a packet arrives (or leaves) a system, the packet traverses the different layers of the network model
        and in turn the various tables/chains of the <span class="bold">iptables</span> within the layer. Within a table, the packet
        starts at the top of the chain and is matched against each rule in the chain (till the last rule). If a rule is matched, the
        corresponding target is executed. If none of the rules match, the default <span class="bold">iptables</span> policy is applied.</p>
    </div>
    <div id="para-div">
      <p>The following diagram illustrates how a packet would traverse through the core components of the <span class="bold">iptables
        </span> in the simplified <span class="bold">TCP/IP Network Model</span>:</p>
    </div>
    <br/>
    <div id="img-outer-div"> <img src="./images/iptables-2.png" class="img-cls" alt="Packet Traversal" />
      <div class="img-cap">Figure.2</div>
    </div>
    <br/>
    <div id="para-div">
      <p>The following is the high-level traversal of a packet from the illustration in Figure.2 above:</p>
    </div>
    <div id="para-div">
      <ol id="blue-ol">
        <li>
          <p>When a packet arrives through the NIC (ingress), it traverses the <span class="bold">PREROUTING</span> chain of the
            tables <span class="bold">raw</span>, <span class="bold">mangle</span> and <span class="bold">nat</span> in the
            <span class="bold">Data Link</span> layer</p>
        </li>
        <li>
          <p>The packet then arrives at the <span class="bold">Network</span> layer to determine if the packet is for this system
            or another system by the routing module</p>
        </li>
        <li>
          <p>If the packet is for <span class="underbold">THIS</span> system, then the packet traverses the <span class="bold">INPUT
            </span> chain of the tables <span class="bold">mangle</span> and <span class="bold">filter</span> at the <span class="bold">
            Network</span> layer. If the packet is not dropped or rejected it moves to the <span class="bold">Transport</span> layer
            (step 5 below)</p>
        </li>
        <li>
          <p>If the packet is for <span class="underbold">ANOTHER</span> system, then the packet traverses the <span class="bold">
            FORWARD</span> chain of the tables <span class="bold">mangle</span> and <span class="bold">filter</span> at the
            <span class="bold">Network</span> layer and moves to the <span class="bold">Data Link</span> layer (step 7 below)</p>
        </li>
        <li>
          <p>In the <span class="bold">Transport</span> layer, the local network application process to which the packet needs to be
            dispatched is determined (look up) using the destination IP and port</p>
        </li>
        <li>
          <p>The packet is processed by the local application process in the <span class="bold">Application</span> layer. The local
            application process creates and sends a response packet back to the source IP and port. This causes the packet to traverse
            the <span class="bold">OUTPUT</span> chain of the tables <span class="bold">raw</span>, <span class="bold">mangle</span>,
            <span class="bold">nat</span>, and <span class="bold">filter</span> in the <span class="bold">Network</span> layer and
            moves to the <span class="bold">Data Link</span> layer</p>
        </li>
        <li>
          <p>In the <span class="bold">Data Link</span> layer, the packet traverses the <span class="bold">POSTROUTING</span> chain
            of the tables <span class="bold">mangle</span> and <span class="bold">nat</span> to go out through the NIC (egress)</p>
        </li>
      </ol>
    </div>
    <div id="section-div">
      <p>Installation and Setup</p>
    </div>
    <div id="para-div">
      <p>The setup will be on a Ubuntu 20.04 LTS based Linux desktop. For the demonstrations, we will create an environment with
        3 virtual machines running on the hypervisor <span class="hi-yellow">VirtualBox</span>.</p>
    </div>
    <div id="para-div">
      <p>The following diagram illustrates the virtual machines environment setup:</p>
    </div>
    <div id="img-outer-div"> <img src="./images/iptables-3.png" class="img-cls" alt="VM Environment" />
      <div class="img-cap">Figure.3</div>
    </div>
    <br/>
    <div id="para-div">
      <p>The following are some of the highlights of the 3 virtual machines:</p>
      <ul id="blue-sqr-ul">
        <li>
          <p><span class="hi-yellow">vm-1</span> :: 1 vCPU, 2GB RAM, 20GB storage, Ubuntu 20.04 OS, and uses a single virtual network
            interface with <span class="bold">NAT</span> networking (<span class="hi-red">10.0.2.15</span>)</p>
        </li>
        <li>
          <p><span class="hi-yellow">vm-2</span> :: 1 vCPU, 2GB RAM, 20GB storage, Ubuntu 20.04 OS, and uses a single virtual network
            interface with <span class="bold">NAT</span> networking (<span class="hi-green">172.20.1.6</span>)</p>
        </li>
        <li>
          <p><span class="hi-yellow">vm-3</span> :: 1 vCPU, 2GB RAM, 20GB storage, Ubuntu 20.04 OS, and uses a two separate virtual
            network interfaces - one with <span class="bold">NAT</span> networking (<span class="hi-red">10.0.2.4</span>) and the
            other also with <span class="bold">NAT</span> networking (<span class="hi-green">172.20.1.5</span>)</p>
        </li>
      </ul>
    </div>
    <div id="para-div">
      <p>Open a Terminal window for each of the 3 virtual machines <span class="bold">vm-1</span> thru <span class="bold">vm-3</span>
        to install few pre-requisites by executing the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo apt install python3-flask net-tools nmap openssh-server traceroute -y</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output (some portion trimmed ... [SNIP] ...):</p>
    </div>
    <div id="out-div">
      <h4>Output.1</h4>
      <pre>Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following additional packages will be installed:
  javascript-common libjs-jquery liblinear4 liblua5.3-0 lua-lpeg ncurses-term nmap-common openssh-sftp-server
  python3-itsdangerous python3-jinja2 python3-markupsafe python3-openssl python3-pyinotify python3-werkzeug
  ssh-import-id traceroute
Suggested packages:
  apache2 | lighttpd | httpd molly-guard monkeysphere ssh-askpass liblinear-tools liblinear-dev ncat ndiff zenmap
  python-flask-doc python-jinja2-doc python-openssl-doc python3-openssl-dbg python-pyinotify-doc ipython3
  python-werkzeug-doc python3-lxml python3-termcolor python3-watchdog
The following NEW packages will be installed:
  javascript-common libjs-jquery liblinear4 liblua5.3-0 lua-lpeg ncurses-term net-tools nmap nmap-common
  openssh-server openssh-sftp-server python3-flask python3-itsdangerous python3-jinja2 python3-markupsafe
  python3-openssl python3-pyinotify python3-werkzeug ssh-import-id
0 upgraded, 20 newly installed, 0 to remove and 0 not upgraded.
Get:1 http://us.archive.ubuntu.com/ubuntu focal/main amd64 javascript-common all 11 [6,066 B]
Get:2 http://us.archive.ubuntu.com/ubuntu focal/main amd64 libjs-jquery all 3.3.1~dfsg-3 [329 kB]
Get:3 http://us.archive.ubuntu.com/ubuntu focal/universe amd64 liblinear4 amd64 2.3.0+dfsg-3build1 [41.7 kB]
Get:4 http://us.archive.ubuntu.com/ubuntu focal/main amd64 liblua5.3-0 amd64 5.3.3-1.1ubuntu2 [116 kB]
Get:5 http://us.archive.ubuntu.com/ubuntu focal/universe amd64 lua-lpeg amd64 1.0.2-1 [31.4 kB]
Get:6 http://us.archive.ubuntu.com/ubuntu focal/main amd64 ncurses-term all 6.2-0ubuntu2 [249 kB]
Get:7 http://us.archive.ubuntu.com/ubuntu focal/main amd64 net-tools amd64 1.60+git20180626.aebd88e-1ubuntu1 [196 kB]
Get:8 http://us.archive.ubuntu.com/ubuntu focal/universe amd64 nmap-common all 7.80+dfsg1-2build1 [3,676 kB]
Get:9 http://us.archive.ubuntu.com/ubuntu focal/universe amd64 nmap amd64 7.80+dfsg1-2build1 [1,662 kB]
Get:10 http://us.archive.ubuntu.com/ubuntu focal-updates/main amd64 openssh-sftp-server amd64 1:8.2p1-4ubuntu0.1 [51.5 kB]
Get:11 http://us.archive.ubuntu.com/ubuntu focal-updates/main amd64 openssh-server amd64 1:8.2p1-4ubuntu0.1 [377 kB]
Get:12 http://us.archive.ubuntu.com/ubuntu focal/main amd64 python3-itsdangerous all 1.1.0-1 [14.6 kB]
Get:13 http://us.archive.ubuntu.com/ubuntu focal/main amd64 python3-markupsafe amd64 1.1.0-1build2 [13.9 kB]
Get:14 http://us.archive.ubuntu.com/ubuntu focal/main amd64 python3-jinja2 all 2.10.1-2 [95.5 kB]
Get:15 http://us.archive.ubuntu.com/ubuntu focal/main amd64 python3-werkzeug all 0.16.1+dfsg1-2 [183 kB]
Get:16 http://us.archive.ubuntu.com/ubuntu focal/main amd64 python3-flask all 1.1.1-2 [80.3 kB]
Get:17 http://us.archive.ubuntu.com/ubuntu focal/main amd64 python3-openssl all 19.0.0-1build1 [43.3 kB]
Get:18 http://us.archive.ubuntu.com/ubuntu focal/main amd64 python3-pyinotify all 0.9.6-1.2ubuntu1 [24.8 kB]
Get:19 http://us.archive.ubuntu.com/ubuntu focal/main amd64 ssh-import-id all 5.10-0ubuntu1 [10.0 kB]
Get:20 http://us.archive.ubuntu.com/ubuntu focal/universe amd64 traceroute amd64 1:2.1.0-2 [45.4 kB]
...
... [SNIP] ...
...
Setting up python3-openssl (19.0.0-1build1) ...
Setting up ssh-import-id (5.10-0ubuntu1) ...
Attempting to convert /etc/ssh/ssh_import_id
Setting up python3-pyinotify (0.9.6-1.2ubuntu1) ...
Setting up python3-itsdangerous (1.1.0-1) ...
Setting up python3-markupsafe (1.1.0-1build2) ...
Setting up python3-jinja2 (2.10.1-2) ...
Setting up libjs-jquery (3.3.1~dfsg-3) ...
Setting up ncurses-term (6.2-0ubuntu2) ...
Setting up python3-werkzeug (0.16.1+dfsg1-2) ...
Setting up python3-flask (1.1.1-2) ...
Setting up lua-lpeg:amd64 (1.0.2-1) ...
Setting up liblinear4:amd64 (2.3.0+dfsg-3build1) ...
Setting up nmap-common (7.80+dfsg1-2build1) ...
Setting up liblua5.3-0:amd64 (5.3.3-1.1ubuntu2) ...
Setting up nmap (7.80+dfsg1-2build1) ...
Processing triggers for systemd (245.4-4ubuntu3.3) ...
Processing triggers for ufw (0.36-6) ...
Processing triggers for man-db (2.9.1-1) ...
Processing triggers for libc-bin (2.31-0ubuntu9.1) ...</pre>
    </div>
    <div id="para-div">
      <p>By default, Linux does *<span class="underbold">NOT</span>* forward any packets in the network. In order for the 3 virtual
        machines to reach each other, we need to enable network packet forwarding as well as add network routes.</p>
    </div>
    <div id="para-div">
      <p>In the Terminal for <span class="bold">vm-1</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ ip addr</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.2</h4>
      <pre>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
        valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
        valid_lft forever preferred_lft forever
2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 11:11:11:11:11:11 brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic noprefixroute enp0s3
        valid_lft 548sec preferred_lft 548sec
    inet6 fe80::5a1:8e6f:8f37:6d3a/64 scope link noprefixroute 
        valid_lft forever preferred_lft forever</pre>
    </div>
    <div id="para-div">
      <p>From the Output.2 above, we see the IP address of <span class="bold">vm-1</span> is <span class="hi-red">10.0.2.15</span>.</p>
    </div>
    <div id="para-div">
      <p>Similarly, in the Terminal for <span class="bold">vm-2</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ ip addr</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.3</h4>
      <pre>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
        valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
        valid_lft forever preferred_lft forever
2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 22:22:22:22:22:22 brd ff:ff:ff:ff:ff:ff
    inet 172.20.1.6/24 brd 172.20.1.255 scope global dynamic noprefixroute enp0s3
        valid_lft 505sec preferred_lft 505sec
    inet6 fe80::c5bd:dd71:57f6:2d03/64 scope link noprefixroute 
        valid_lft forever preferred_lft forever</pre>
    </div>
    <div id="para-div">
      <p>From the Output.3 above, we see the IP address of <span class="bold">vm-2</span> is <span class="hi-green">172.20.1.6</span>.</p>
    </div>
    <div id="para-div">
      <p>Finally, in the Terminal for <span class="bold">vm-3</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ ip addr</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.4</h4>
      <pre>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
        valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
        valid_lft forever preferred_lft forever
2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 33:33:33:33:33:33 brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.4/24 brd 10.0.2.255 scope global dynamic noprefixroute enp0s3
        valid_lft 459sec preferred_lft 459sec
    inet6 fe80::f46c:140d:630d:82d4/64 scope link noprefixroute 
        valid_lft forever preferred_lft forever
3: enp0s8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 44:44:44:44:44:44 brd ff:ff:ff:ff:ff:ff
    inet 172.20.1.5/24 brd 172.20.1.255 scope global dynamic noprefixroute enp0s8
        valid_lft 459sec preferred_lft 459sec
    inet6 fe80::f0c9:1f25:2962:c783/64 scope link noprefixroute 
        valid_lft forever preferred_lft forever</pre>
    </div>
    <div id="para-div">
      <p>From the Output.4 above, we see <span class="bold">vm-3</span> has two IP addresses - one is <span class="hi-red">10.0.2.4</span>
        and the other is <span class="hi-green">172.20.1.5</span>.</p>
    </div>
    <div id="step-div">
      <p>Setup vm-1</p>
    </div>
    <div id="para-div">
      <p>To trace the network route of a packet from <span class="bold">vm-1</span> to <span class="bold">vm-2</span>, execute the
        following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ traceroute -m 3 172.20.1.6</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.5</h4>
      <pre>traceroute to 172.20.1.6 (172.20.1.6), 5 hops max, 60 byte packets
  1  _gateway (10.0.2.1)  0.255 ms  0.182 ms  0.162 ms
  2  * * *
  3  * * *</pre>
    </div>
    <div id="para-div">
      <p>From the Output.5 above, we see <span class="bold">vm-2</span> is <span class="underbold">NOT</span> reachable.</p>
    </div>
    <div id="para-div">
      <p>To check if IP forwarding is enabled, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ cat /proc/sys/net/ipv4/ip_forward</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.6</h4>
      <pre>0</pre>
    </div>
    <div id="para-div">
      <p>From the Output.6 above, we see IP forwarding is disabled (value of 0) on <span class="bold">vm-1</span>.</p>
    </div>
    <div id="para-div">
      <p>To enable IP forwarding on <span class="bold">vm-1</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo bash -c 'echo 1 > /proc/sys/net/ipv4/ip_forward'</p>
    </div>
    <div id="para-div">
      <p>To check the IP routes on <span class="bold">vm-1</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ ip route show</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.7</h4>
      <pre>default via 10.0.2.1 dev enp0s3 proto dhcp metric 100 
10.0.2.0/24 dev enp0s3 proto kernel scope link src 10.0.2.15 metric 100 
169.254.0.0/16 dev enp0s3 scope link metric 1000</pre>
    </div>
    <div id="para-div">
      <p>Given only <span class="bold">vm-3</span> can communicate with <span class="bold">vm-2</span>, we need to add a route to
        <span class="bold">vm-2</span> via <span class="bold">vm-3</span> as the gateway.</p>
    </div>
    <div id="para-div">
      <p>To add an IP route on <span class="bold">vm-1</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo ip route add 172.20.1.0/24 via 10.0.2.4 dev enp0s3</p>
    </div>
    <div id="para-div">
      <p>Again, to check the IP routes on <span class="bold">vm-1</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ ip route show</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.8</h4>
      <pre>default via 10.0.2.1 dev enp0s3 proto dhcp metric 100 
10.0.2.0/24 dev enp0s3 proto kernel scope link src 10.0.2.15 metric 100 
169.254.0.0/16 dev enp0s3 scope link metric 1000 
172.20.1.0/24 via 10.0.2.4 dev enp0s3</pre>
    </div>
    <div id="step-div">
      <p>Setup vm-2</p>
    </div>
    <div id="para-div">
      <p>We will only indicate the steps to enable IP forwarding and adding a route on <span class="bold">vm-2</span>.</p>
    </div>
    <div id="para-div">
      <p>To enable IP forwarding on <span class="bold">vm-2</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo bash -c 'echo 1 > /proc/sys/net/ipv4/ip_forward'</p>
    </div>
    <div id="para-div">
      <p>Given only <span class="bold">vm-3</span> can communicate with <span class="bold">vm-1</span>, we need to add a route to
        <span class="bold">vm-1</span> via <span class="bold">vm-3</span> as the gateway.</p>
    </div>
    <div id="para-div">
      <p>To add an IP route on <span class="bold">vm-2</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo ip route add 10.0.2.0/24 via 172.20.1.5 dev enp0s3</p>
    </div>
    <div id="para-div">
      <p>Again, to check the IP routes on <span class="bold">vm-2</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ ip route show</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.9</h4>
      <pre>default via 172.20.1.1 dev enp0s3 proto dhcp metric 100 
10.0.2.0/24 via 172.20.1.5 dev enp0s3 
169.254.0.0/16 dev enp0s3 scope link metric 1000 
172.20.1.0/24 dev enp0s3 proto kernel scope link src 172.20.1.6 metric 100</pre>
    </div>
    <div id="step-div">
      <p>Setup vm-3</p>
    </div>
    <div id="para-div">
      <p>We will only indicate the step to enable IP forwarding on <span class="bold">vm-3</span>.</p>
    </div>
    <div id="para-div">
      <p>To enable IP forwarding on <span class="bold">vm-3</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo bash -c 'echo 1 > /proc/sys/net/ipv4/ip_forward'</p>
    </div>
    <div id="para-div">
      <p>At this stage, the 3 virtual machines should be able to reach each other via <span class="bold">vm-3</span> acting as a
        gateway.</p>
    </div>
    <div id="section-div">
      <p>Hands-on iptables</p>
    </div>
    <div id="para-div">
      <p>In the Terminal for <span class="bold">vm-1</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ traceroute -m 3 172.20.1.6</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.10</h4>
      <pre>traceroute to 172.20.1.6 (172.20.1.6), 3 hops max, 60 byte packets
  1  10.0.2.4 (10.0.2.4)  0.464 ms  0.402 ms  0.383 ms
  2  172.20.1.6 (172.20.1.6)  0.654 ms  0.631 ms  0.755 ms</pre>
    </div>
    <div id="para-div">
      <p>Similarly, in the Terminal for <span class="bold">vm-2</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ traceroute -m 3 10.0.2.15</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.11</h4>
      <pre>traceroute to 10.0.2.15 (10.0.2.15), 3 hops max, 60 byte packets
  1  172.20.1.5 (172.20.1.5)  0.446 ms  0.385 ms  0.365 ms
  2  10.0.2.15 (10.0.2.15)  0.709 ms  0.636 ms  0.615 ms</pre>
    </div>
    <div id="para-div">
      <p><span class="bold">PERFECT</span> !!! Our setup works as expected.</p>
    </div>
    <div id="para-div">
      <p>Given <span class="bold">vm-3</span> is the gateway, we will make it the <span class="bold">iptables</span> firewall and
        enforce the security policies there.</p>
    </div>
    <div id="warn-div">
      <h4>!! ATTENTION !!</h4>
      <pre><span class="bold">iptables</span> needs elevated access to work - we will need to use <span class="underbold">sudo</span></pre>
    </div>
    <br/>
    <div id="para-div">
      <p>The following illustration shows the general format of the <span class="bold">iptables</span> command:</p>
    </div>
    <div id="img-outer-div"> <img src="./images/iptables-4.png" class="img-cls" alt="iptables Syntax" />
      <div class="img-cap">Figure.4</div>
    </div>
    <br/>
    <div id="para-div">
      <p>To list all the firewall rules in the filter table, execute the following command in the Terminal for <span class="bold">
        vm-3</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -L</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.12</h4>
      <pre>Chain INPUT (policy ACCEPT)
target     prot opt source               destination         

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination</pre>
    </div>
    <div id="para-div">
      <p>As indicated earlier, the filter table is the default. Executing the following command will produce the same results as in
        Output.12 above:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -L</p>
    </div>
    <div id="para-div">
      <p>Copy the following <span class="bold">Python</span> based web application to <span class="bold">vm-2</span> in a file named
        <span class="hi-yellow">Web.py</span>:</p>
    </div>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Web.py</div>
      <div class="src-body-1">
      <pre>import sys
from datetime import datetime
from flask import Flask

app = Flask(__name__)
HOST = ''
PORT = 0

HTML = """
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;From %s&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h3&gt;Hello from %s:%d&lt;/h3&gt;
  &lt;h3&gt;Timestamp: %s&lt;/h3&gt;
&lt;/body&gt;
&lt;/html&gt;
"""

@app.route('/')
def index():
    return HTML % (HOST, HOST, PORT, datetime.now())

if __name__ == '__main__':
    if len(sys.argv) == 3:
        HOST = sys.argv[1]
        PORT = int(sys.argv[2])
        app.run(host=HOST, port=PORT)</pre>
      </div>
    </div>
    <div id="para-div">
      <p>To start the <span class="bold">Python</span> web application on <span class="bold">vm-2</span> on the IP address
        <span class="hi-green">172.20.1.6</span> and port <span class="hi-green">8080</span>, execute the following command in the
        Terminal for <span class="bold">vm-2</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ python3 Web.py 172.20.1.6 8080</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.13</h4>
      <pre>* Serving Flask app "Web" (lazy loading)
* Environment: production
  WARNING: This is a development server. Do not use it in a production deployment.
  Use a production WSGI server instead.
* Debug mode: off
* Running on http://172.20.1.6:8080/ (Press CTRL+C to quit)</pre>
    </div>
    <div id="para-div">
      <p>To check if <span class="bold">vm-1</span> can access the web application running on <span class="bold">vm-2</span>, execute
        the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ nmap -p 8080 172.20.1.6</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.14</h4>
      <pre>Starting Nmap 7.80 ( https://nmap.org ) at 2020-11-22 19:55 EST
Nmap scan report for 172.20.1.6
Host is up (0.00072s latency).

PORT     STATE SERVICE
8080/tcp open  http-proxy

Nmap done: 1 IP address (1 host up) scanned in 0.12 seconds</pre>
    </div>
    <div id="para-div">
      <p>To block access to the traffic from <span class="bold">vm-1</span> to the web application running on <span class="bold">
        vm-2</span>, execute the following command in the Terminal for <span class="bold">vm-3</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -A FORWARD -p tcp --dport 8080 -j DROP</p>
    </div>
    <div id="para-div">
      <p>Given that the web application is a TCP process (-p tcp) running on <span class="bold">vm-2</span> and <span class="bold">
        vm-3</span> forwards the request to <span class="bold">vm-2</span> on port 8080 (--dport 8080), we need to append (-A) the
        rule to the FORWARD chain of the filter table (-t filter -A FORWARD).</p>
    </div>
    <div id="para-div">
      <p>To list all the firewall rules in the filter table, execute the following command in the Terminal for <span class="bold">
        vm-3</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -L</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.15</h4>
      <pre>Chain INPUT (policy ACCEPT)
target     prot opt source               destination         

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  anywhere             anywhere             tcp dpt:http-alt

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination</pre>
    </div>
    <div id="para-div">
      <p>By default, the list option <span class="hi-green">-L</span> will display host names, network names, or services.</p>
    </div>
    <div id="para-div">
      <p>To list all the firewall rules in the filter table using numeric IP address(es) and port number(s), execute the following
        command in the Terminal for <span class="bold">vm-3</span> by adding the <span class="hi-green">-n</span> option:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -n -L</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.16</h4>
      <pre>Chain INPUT (policy ACCEPT)
target     prot opt source               destination         

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:8080

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination</pre>
    </div>
    <div id="para-div">
      <p>Once again, to check if <span class="bold">vm-1</span> can access the web application running on <span class="bold">vm-2
        </span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ nmap -p 8080 172.20.1.6</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.17</h4>
      <pre>Starting Nmap 7.80 ( https://nmap.org ) at 2020-11-22 20:22 EST
Nmap scan report for 172.20.1.6
Host is up (0.00066s latency).

PORT     STATE    SERVICE
8080/tcp filtered http-proxy

Nmap done: 1 IP address (1 host up) scanned in 0.31 seconds</pre>
    </div>
    <div id="para-div">
      <p><span class="bold">BINGO</span> !!! The request from <span class="bold">vm-1</span> to <span class="bold">vm-2</span> on
        port 8080 is <span class="underbold">BLOCKED</span> (filtered).</p>
    </div>
    <div id="para-div">
      <p>Executing the above command from <span class="bold">vm-3</span> to <span class="bold">vm-2</span> on port 8080 will be
        <span class="underbold">ALLOWED</span> and the result will be similar to the one in Output.14 above.</p>
    </div>
    <div id="para-div">
      <p>To block access to all <span class="hi-grey">ssh</span> (port 22) traffic to <span class="bold">vm-3</span>, execute the
        following command in the Terminal for <span class="bold">vm-3</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -A INPUT -p tcp --dport 22 -j DROP</p>
    </div>
    <div id="para-div">
      <p>Given that <span class="bold">ssh</span> is a TCP process (-p tcp) running on port 22 (--dport 22), we need to append (-A)
        the rule to the INPUT chain of the filter table (-t filter -A INPUT).</p>
    </div>
    <div id="para-div">
      <p>Execute the following command in the Terminal of <span class="bold">vm-3</span> to list all the firewall rules in the filter
        table:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -n -L</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.18</h4>
      <pre>Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:8080

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination</pre>
    </div>
    <div id="para-div">
      <p>Execute the following command in the Terminal of <span class="bold">vm-1</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ nmap -p 22 10.0.2.4</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.19</h4>
      <pre>Starting Nmap 7.80 ( https://nmap.org ) at 2020-11-22 21:02 EST
Nmap scan report for 10.0.2.4
Host is up (0.00041s latency).

PORT   STATE    SERVICE
22/tcp filtered ssh

Nmap done: 1 IP address (1 host up) scanned in 0.31 seconds</pre>
    </div>
    <div id="para-div">
      <p>Similarly, one can check from <span class="bold">vm-2</span> as well and will get similar results as in Output.19 above.</p>
    </div>
    <div id="para-div">
      <p>To block access to all <span class="hi-grey">ping</span> (ICMP) traffic to <span class="bold">vm-3</span>, execute the
        following command in the Terminal for <span class="bold">vm-3</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -A INPUT -p icmp -j DROP</p>
    </div>
    <div id="para-div">
      <p>Given that <span class="bold">ping</span> is a ICMP process (-p icmp), we need to append (-A) the rule to the INPUT chain
        of the filter table (-t filter -A INPUT).</p>
    </div>
    <div id="para-div">
      <p>Execute the following command in the Terminal of <span class="bold">vm-3</span> to list all the firewall rules in the filter
        table:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -n -L</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.20</h4>
      <pre>Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22
DROP       icmp --  0.0.0.0/0            0.0.0.0/0           

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:8080

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination</pre>
    </div>
    <div id="para-div">
      <p>Execute the following command in the Terminal of <span class="bold">vm-1</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ ping -c 3 10.0.2.4</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.21</h4>
      <pre>PING 10.0.2.4 (10.0.2.4) 56(84) bytes of data.

--- 10.0.2.4 ping statistics ---
3 packets transmitted, 0 received, 100% packet loss, time 2029ms</pre>
    </div>
    <div id="para-div">
      <p>Similarly, one can check from <span class="bold">vm-2</span> as well and will get similar results as in Output.21 above.</p>
    </div>
    <div id="para-div">
      <p>One should be able to <span class="hi-grey">ping</span> from <span class="bold">vm-3</span> to the other 2 virtual machines.
        To verify that, execute the following command in the Terminal of <span class="bold">vm-3</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ ping -c 3 10.0.2.15</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.22</h4>
      <pre>PING 10.0.2.15 (10.0.2.15) 56(84) bytes of data.

--- 10.0.2.15 ping statistics ---
3 packets transmitted, 0 received, 100% packet loss, time 2028ms</pre>
    </div>
    <div id="para-div">
      <p><span class="bold">WHAT</span> ??? Why is <span class="bold">ping</span> from <span class="bold">vm-3</span> blocked ???.</p>
    </div>
    <div id="para-div">
      <p>The reason for this is because we have block all types of ICMP requests to <span class="bold">vm-3</span>. When we issue
        the <span class="hi-grey">ping</span> from <span class="bold">vm-3</span>, it sends out an <span class="hi-yellow">icmp
        request</span> packet to <span class="bold">vm-1</span>. In response, <span class="bold">vm-1</span> sends an
        <span class="hi-yellow">icmp reply</span> packet which is blocked by <span class="bold">vm-3</span>.</p>
    </div>
    <div id="para-div">
      <p>To fix this, we need to remove (-D) the existing ICMP rule from <span class="bold">vm-3</span> and be more specific. To
        remove the existing rule, execute the following command in the Terminal for <span class="bold">vm-3</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -D INPUT -p icmp -j DROP</p>
    </div>
    <div id="para-div">
      <p>To only block ICMP request traffic to <span class="bold">vm-3</span>, execute the following command in the Terminal for
        <span class="bold">vm-3</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -A INPUT -p icmp --icmp-type echo-request -j DROP</p>
    </div>
    <div id="para-div">
      <p>Execute the following command in the Terminal of <span class="bold">vm-3</span> to list all the firewall rules in the filter
        table:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -n -L</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.23</h4>
      <pre>Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22
DROP       icmp --  0.0.0.0/0            0.0.0.0/0            icmptype 8

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:8080

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination</pre>
    </div>
    <div id="para-div">
      <p>Now <span class="bold">vm-3</span> will be anle to <span class="bold">ping</span> the other 2 virtual machines, but not the
        other way around.</p>
    </div>
    <div id="para-div">
      <p>To remove all the firewall rules from <span class="bold">vm-3</span>, execute the following command in the Terminal for
        <span class="bold">vm-3</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -F</p>
    </div>
    <div id="para-div">
      <p>Execute the following command in the Terminal of <span class="bold">vm-3</span> to list all the firewall rules in the filter
        table:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -n -L</p>
    </div>
    <div id="para-div">
      <p>The result should be similar to the one in Output.12 above.</p>
    </div>
    <div id="para-div">
      <p>From the Output.12 above, we see the default policy is to accept all the network traffic (policy ACCEPT).</p>
    </div>
    <div id="para-div">
      <p>To reverse the policy to reject all the network traffic, execute the following commands in the Terminal for
        <span class="bold">vm-3</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -P INPUT DROP</p>
      <p>$ sudo iptables -t filter -P FORWARD DROP</p>
      <p>$ sudo iptables -t filter -P OUTPUT DROP</p>
    </div>
    <div id="para-div">
      <p>Execute the following command in the Terminal of <span class="bold">vm-3</span> to list all the firewall rules in the filter
        table:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -n -L</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.24</h4>
      <pre>Chain INPUT (policy DROP)
target     prot opt source               destination         

Chain FORWARD (policy DROP)
target     prot opt source               destination         

Chain OUTPUT (policy DROP)
target     prot opt source               destination</pre>
    </div>
    <div id="para-div">
      <p>From the Output.24 above, we see the default policy is now to reject all the network traffic (policy DROP).</p>
    </div>
    <div id="para-div">
      <p>To verify the default policy, execute the following command in the Terminal of <span class="bold">vm-1</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ ping -c 3 10.0.2.4</p>
    </div>
    <div id="para-div">
      <p>The result should be similar to the one in Output.21 above. Similarly, one can check from <span class="bold">vm-2</span>
       or <span class="bold">vm-3</span> and one will get similar results as in Output.21 above.</p>
    </div>
    <div id="para-div">
      <p>To <span class="underbold">ONLY</span> allow <span class="bold">vm-3</span> to be able to <span class="hi-grey">ping</span>
        the other 2 virtual machines, execute the following commands in the Terminal for <span class="bold">vm-3</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -A OUTPUT -p icmp --icmp-type echo-request -j ACCEPT</p>
      <p>$ sudo iptables -t filter -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT</p>
    </div>
    <div id="para-div">
      <p>We want to allow ICMP requests going <span class="underbold">OUT</span> from <span class="bold">vm-3</span> and also allow
        ICMP replies coming <span class="underbold">IN</span> to <span class="bold">vm-3</span>.</p>
    </div>
    <div id="para-div">
      <p>Execute the following command in the Terminal of <span class="bold">vm-3</span> to list all the firewall rules in the filter
        table:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -n -L</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.25</h4>
      <pre>Chain INPUT (policy DROP)
target     prot opt source               destination         
ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0            icmptype 0

Chain FORWARD (policy DROP)
target     prot opt source               destination         

Chain OUTPUT (policy DROP)
target     prot opt source               destination         
ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0            icmptype 8</pre>
    </div>
    <div id="para-div">
      <p>To verify the ICMP rules, execute the following command in the Terminal of <span class="bold">vm-3</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ ping -c 3 10.0.2.15</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.26</h4>
      <pre>PING 10.0.2.15 (10.0.2.15) 56(84) bytes of data.
64 bytes from 10.0.2.15: icmp_seq=1 ttl=64 time=0.407 ms
64 bytes from 10.0.2.15: icmp_seq=2 ttl=64 time=0.385 ms
64 bytes from 10.0.2.15: icmp_seq=3 ttl=64 time=0.361 ms

--- 10.0.2.15 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2052ms
rtt min/avg/max/mdev = 0.361/0.384/0.407/0.018 ms</pre>
    </div>
    <div id="para-div">
      <p><span class="bold">WALLA</span> !!! The firewall rules behave as expected.</p>
    </div>
    <div id="para-div">
      <p>To <span class="underbold">ONLY</span> allow <span class="bold">vm-1</span> to be able to access the web application that
        is hosted on <span class="bold">vm-2</span> (on port 8080), execute the following commands in the Terminal for
        <span class="bold">vm-3</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -A FORWARD -p tcp -s 10.0.2.15 -d 172.20.1.6 --dport 8080 -j ACCEPT</p>
      <p>$ sudo iptables -t filter -A FORWARD -p tcp -s 172.20.1.6 -d 10.0.2.15 --sport 8080 -j ACCEPT</p>
    </div>
    <div id="para-div">
      <p>We want to allow HTTP requests forwarded from <span class="bold">vm-1</span> to <span class="bold">vm-2</span> and also
        allow HTTP responses forwarded from <span class="bold">vm-2</span> to <span class="bold">vm-1</span>.</p>
    </div>
    <div id="para-div">
      <p>Execute the following command in the Terminal of <span class="bold">vm-3</span> to list all the firewall rules in the filter
        table:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo iptables -t filter -n -L</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.27</h4>
      <pre>Chain INPUT (policy DROP)
target     prot opt source               destination         
ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0            icmptype 0

Chain FORWARD (policy DROP)
target     prot opt source               destination         
ACCEPT     tcp  --  10.0.2.15            172.20.1.6           tcp dpt:8080
ACCEPT     tcp  --  172.20.1.6           10.0.2.15            tcp spt:8080

Chain OUTPUT (policy DROP)
target     prot opt source               destination         
ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0            icmptype 8</pre>
    </div>
    <div id="para-div">
      <p>To verify the HTTP rules, launch a browser on <span class="bold">vm-1</span> and open the url to
        <span class="bold">http://172.20.1.6:8080</span>.</p>
    </div>
    <div id="para-div">
      <p>The following diagram illustrates the screenshot of the browser:</p>
    </div>
    <div id="img-outer-div"> <img src="./images/iptables-5.png" class="img-cls" alt="Browser" />
      <div class="img-cap">Figure.5</div>
    </div>
    <br/>
    <div id="para-div">
      <p>Trying to access the url <span class="bold">http://172.20.1.6:8080</span> from a browser on <span class="bold">vm-3</span>
        will <span class="underbold">NOT</span> work.</p>
      <p><span class="bold">TA DA</span> !!! The firewall rules works as expected.</p>
    </div>
    <div id="section-div">
      <p>References</p>
    </div>
    <div id="para-div">
      <p><a href="https://www.netfilter.org/" target="_blank"><span class="bold">Official netfilter Documentation</span></a></p>
      <p><a href="https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture" target="_blank"><span class="bold">A Deep Dive into Iptables and Netfilter Architecture</span></a></p>
    </div>
    <br/>
    <hr class="line-hr" />
    <div>
      <a id="footer-a" href="https://polarsparc.github.io/">&copy;&nbsp;PolarSPARC</a>
    </div>
  </body>
</html>
