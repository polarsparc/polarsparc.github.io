<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="application/xhtml+xml; charset=windows-1252" />
    <meta name="author" content="Bhaskar.S">
    <meta name="description" content="Building a Linux Container using Namespaces :: Part - 2">
    <meta name="subject" content="Building a Linux Container using Namespaces :: Part - 2">
    <meta name="keywords" content="container, linux, namespaces, golang">
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <title>Building a Linux Container using Namespaces :: Part - 2</title>
    <link href="../css/polarsparc-v2.4.css" type="text/css" rel="stylesheet" />
  </head>
  <body>
    <br/>
    <table borber="0">
      <tr>
        <td valign="bottom"><span id="ps-home"></span></td>
        <td valign="bottom"><span id="home-a"><a id="home-a" href="https://polarsparc.github.io/">PolarSPARC</a></span></td>
      </tr>
    </table>
    <br/>
    <div id="title-div">
      <p>Building a Linux Container using Namespaces :: Part - 2</p>
    </div>
    <br />
    <table id="ad-table">
      <tbody>
        <tr>
          <td class="author-td">Bhaskar S</td>
          <td class="date-td">03/15/2020</td>
        </tr>
      </tbody>
    </table>
    <hr class="line-hr" /> <br />
    <div id="section-div">
      <p>Overview</p>
    </div>
    <div id="para-div">
      <p>In <a href="https://polarsparc.github.io/Linux/Containers-1.html" target="_blank"><span class="bold">Part - 1</span></a>
        of this series, we demonstrated isolation of the Host name, User/Group IDs, and Process IDs using namespaces <span class=
        "hi-blue">UTS</span>, <span class="hi-blue">User</span>, <span class="hi-blue">PID</span>, and <span class="hi-blue">Mount</span>.</p>
      <p>In this article, we continue the journey with <span class="hi-blue">Mount</span> and <span class="hi-blue">Network</span>
        namespaces. We will not explore the <span class="hi-blue">IPC</span> namespace.</p>
    </div>
    <div id="section-div">
      <p>Hands-on with Namespaces</p>
    </div>
    <div id="step-div">
      <p>Mount Namespace</p>
    </div>
    <div id="para-div">
      <p>Next, we will mimic the above <span class="bold">UTS</span>, <span class="bold">User</span>, <span class="bold">
        PID</span>, and <span class="bold">Mount</span>, namespace isolation using the following <span class="bold">go</span>
        program:</p>
    </div>    
    <div id="src-outer-div-1">
      <div class="src-cap-1">Listing.1</div>
      <div class="src-body-1">
      <pre>package main

import (
	"log"
	"os"
	"os/exec"
	"syscall"
)

func createTxtFile() {
	f, err := os.Create("/tmp/leopard.txt")
	if err != nil {
		panic(err)
	}

	defer f.Close()

	_, err = f.WriteString("leopard")
	if err != nil {
		panic(err)
	}
}

func execContainerShell() {
	log.Printf("Ready to exec container shell ...\n")

	if err := syscall.Sethostname([]byte("leopard")); err != nil {
		panic(err)
	}

	log.Printf("Chaning to /tmp directory ...\n")

	if err := os.Chdir("/tmp"); err != nil {
		panic(err)
	}

	log.Printf("Mounting / as private ...\n")

	mf := uintptr(syscall.MS_PRIVATE | syscall.MS_REC)
	if err := syscall.Mount("", "/", "", mf, ""); err != nil {
		panic(err)
	}

	log.Printf("Binding rootfs/ to rootfs/ ...\n")

	mf = uintptr(syscall.MS_BIND | syscall.MS_REC)
	if err := syscall.Mount("rootfs/", "rootfs/", "", mf, ""); err != nil {
		panic(err)
	}

	log.Printf("Pivot new root at rootfs/ ...\n")

	if err := syscall.PivotRoot("rootfs/", "rootfs/.old_root"); err != nil {
		panic(err)
	}

	log.Printf("Changing to / directory ...\n")

	if err := os.Chdir("/"); err != nil {
		panic(err)
	}

	log.Printf("Mounting /tmp as tmpfs ...\n")

	mf = uintptr(syscall.MS_NODEV)
	if err := syscall.Mount("tmpfs", "/tmp", "tmpfs", mf, ""); err != nil {
		panic(err)
	}

	log.Printf("Mounting /proc filesystem ...\n")

	mf = uintptr(syscall.MS_NODEV)
	if err := syscall.Mount("proc", "/proc", "proc", mf, ""); err != nil {
		panic(err)
	}

	createTxtFile()

	log.Printf("Mounting /.old_root as private ...\n")

	mf = uintptr(syscall.MS_PRIVATE | syscall.MS_REC)
	if err := syscall.Mount("", "/.old_root", "", mf, ""); err != nil {
		panic(err)
	}

	log.Printf("Unmount parent rootfs from /.old_root ...\n")

	if err := syscall.Unmount("/.old_root", syscall.MNT_DETACH); err != nil {
		panic(err)
	}

	const sh = "/bin/sh"

	env := os.Environ()
	env = append(env, "PS1=-> ")

	if err := syscall.Exec(sh, []string{""}, env); err != nil {
		panic(err)
	}
}

func main() {
	log.Printf("Starting process %s with args: %v\n", os.Args[0], os.Args)

	const clone = "CLONE"

	if len(os.Args) > 1 && os.Args[1] == clone {
		execContainerShell()
		os.Exit(0)
	}

	log.Printf("Ready to run command ...\n")

	cmd := exec.Command(os.Args[0], []string{clone}...)
	cmd.Stdin = os.Stdin
	cmd.Stdout = os.Stdout
	cmd.Stderr = os.Stderr
	cmd.SysProcAttr = &syscall.SysProcAttr{
		Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWUSER | syscall.CLONE_NEWNS | syscall.CLONE_NEWPID,
		UidMappings: []syscall.SysProcIDMap{
			{ContainerID: 0, HostID: 0, Size: 1},
		},
		GidMappings: []syscall.SysProcIDMap{
			{ContainerID: 0, HostID: 0, Size: 1},
		},
	}

	if err := cmd.Run(); err != nil {
		panic(err)
	}
}</pre>
      </div>
    </div>
    <div id="para-div">
      <p>Create and change to the directory <span class="bold">$GOPATH/mount</span> by executing the following commands in
        <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ mkdir -p $GOPATH/mount</p>
      <p>$ cd $GOPATH/mount</p>
    </div>
    <div id="para-div">
      <p>Copy the above code into the program file <span class="bold">main.go</span> in the current directory.</p>
    </div>
    <div id="para-div">
      <p>To compile the program file <span class="bold">main.go</span>, execute the following command in <span class="bold">
        TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ go build main.go</p>
    </div>
    <div id="para-div">
      <p>To run program <span class="bold">main</span>, execute the following command in <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo ./main</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.1</h4>
      <pre>2020/03/14 22:05:46 Starting process ./main with args: [./main]
2020/03/14 22:05:46 Ready to run command ...
2020/03/14 22:05:46 Starting process ./main with args: [./main CLONE]
2020/03/14 22:05:46 Ready to exec container shell ...
2020/03/14 22:05:46 Chaning to /tmp directory ...
2020/03/14 22:05:46 Mounting / as private ...
2020/03/14 22:05:46 Binding rootfs/ to rootfs/ ...
2020/03/14 22:05:46 Pivot new root at rootfs/ ...
2020/03/14 22:05:46 Changing to / directory ...
2020/03/14 22:05:46 Mounting /tmp as tmpfs ...
2020/03/14 22:05:46 Mounting /proc filesystem ...
2020/03/14 22:05:46 Mounting /.old_root as private ...
2020/03/14 22:05:46 Unmount parent rootfs from /.old_root ...
-></pre>
    </div>
    <div id="para-div">
      <p>The command prompt will change to a <span class="bold">-&gt;</span>.</p>
    </div>
    <div id="para-div">
      <p>To display the host name of the simple container, execute the following command in <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p>-&gt; hostname</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.2</h4>
      <pre>leopard</pre>
    </div>
    <div id="para-div">
      <p>To display the user ID and group ID in the new namespace, execute the following command in <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p>-&gt; id</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.3</h4>
      <pre>uid=0(root) gid=0(root) groups=0(root)</pre>
    </div>
    <div id="para-div">
      <p>To display all the processes in the simple container, execute the following command in <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p>-&gt; ps -fu</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.4</h4>
      <pre>USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.0   4628   824 pts/1    S    22:05   0:00 
root         8  0.0  0.0  37368  3368 pts/1    R+   22:05   0:00 ps -fu</pre>
    </div>
    <div id="para-div">
      <p>To list all the mount points in the new namespace by executing the following command in <span class="bold">TB</span>
        :</p>
    </div>
    <div id="cmd-div">
      <p>-&gt; cat /proc/mounts | sort</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.5</h4>
      <pre>/dev/sda1 / ext4 rw,relatime,errors=remount-ro,data=ordered 0 0
proc /proc proc rw,relatime 0 0
tmpfs /tmp tmpfs rw,relatime 0 0</pre>
    </div>
    <div id="para-div">
      <p>To list all the file(s) under <span class="bold">/</span> in the new namespace, execute the following command in
        <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p># ls -l /</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.6</h4>
      <pre>total 68
drwxr-xr-x   2 nobody nogroup 4096 Feb  3 20:24 bin
drwxr-xr-x   2 nobody nogroup 4096 Apr 24  2018 boot
drwxr-xr-x   2 nobody nogroup 4096 Feb  3 20:24 dev
drwxr-xr-x  29 nobody nogroup 4096 Feb  3 20:24 etc
drwxr-xr-x   2 nobody nogroup 4096 Apr 24  2018 home
drwxr-xr-x   8 nobody nogroup 4096 May 23  2017 lib
drwxr-xr-x   2 nobody nogroup 4096 Feb  3 20:23 lib64
drwxr-xr-x   2 nobody nogroup 4096 Feb  3 20:23 media
drwxr-xr-x   2 nobody nogroup 4096 Feb  3 20:23 mnt
drwxr-xr-x   2 nobody nogroup 4096 Feb  3 20:23 opt
dr-xr-xr-x 329 root   root       0 Mar 21 17:32 proc
drwx------   2 nobody nogroup 4096 Feb  3 20:24 root
drwxr-xr-x   4 nobody nogroup 4096 Feb  3 20:23 run
drwxr-xr-x   2 nobody nogroup 4096 Feb  3 20:24 sbin
drwxr-xr-x   2 nobody nogroup 4096 Feb  3 20:23 srv
drwxr-xr-x   2 nobody nogroup 4096 Apr 24  2018 sys
drwxrwxrwt   2 root   root      60 Mar 21 17:32 tmp
drwxr-xr-x  10 nobody nogroup 4096 Feb  3 20:23 usr
drwxr-xr-x  11 nobody nogroup 4096 Feb  3 20:24 var</pre>
    </div>
    <div id="para-div">
      <p>To list the the properties of the file <span class="bold">/tmp/leopard.txt</span> in the simple container, execute
        the following command in <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p>-&gt; ls -l /tmp/leopard.txt</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.7</h4>
      <pre>-rw-r--r-- 1 root root 7 Mar 14 22:05 /tmp/leopard.txt</pre>
    </div>
    <div id="para-div">
      <p>To list all the namespaces associated with the simple container, execute the following command in <span class="bold">
        TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p>-&gt; ls -l /proc/$$/ns</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.8</h4>
      <pre>total 0
lrwxrwxrwx 1 root root 0 Mar 14 22:07 cgroup -> 'cgroup:[4026531835]'
lrwxrwxrwx 1 root root 0 Mar 14 22:07 ipc -> 'ipc:[4026531839]'
lrwxrwxrwx 1 root root 0 Mar 14 22:07 mnt -> 'mnt:[4026532609]'
lrwxrwxrwx 1 root root 0 Mar 14 22:07 net -> 'net:[4026531993]'
lrwxrwxrwx 1 root root 0 Mar 14 22:07 pid -> 'pid:[4026532611]'
lrwxrwxrwx 1 root root 0 Mar 14 22:07 pid_for_children -> 'pid:[4026532611]'
lrwxrwxrwx 1 root root 0 Mar 14 22:07 user -> 'user:[4026532608]'
lrwxrwxrwx 1 root root 0 Mar 14 22:07 uts -> 'uts:[4026532610]'</pre>
    </div>
    <div id="para-div">
      <p>To exit the simple container, execute the following command in <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p>-&gt; exit</p>
    </div>
    <div id="para-div">
      <p><span class="bold">SUCCESS !!!</span> We have demonstrated the combined <span class="bold">UTS</span>,
        <span class="bold">User</span>, <span class="bold">PID</span>, and <span class="bold">Mount</span> namespaces
        using both the <span class="bold">unshare</span> command and a simple <span class="bold">go</span> program.</p>
    </div>
    <div id="step-div">
      <p>Network Namespace</p>
    </div>
    <div id="para-div">
      <p>Finally, let us now layer the <span class="bold">Network</span> namespace on top of the <span class="bold">UTS</span>,
        the <span class="bold">User</span>, the <span class="bold">PID</span>, and the <span class="bold">Mount</span>
        namespaces.</p>
      <p>To launch a simple container whose networking as well as the mount points, the process IDs, the user/group IDs, and
        the host name are isolated from the parent namespace, execute the following command in <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo unshare -uUrpfmn --mount-proc /bin/sh</p>
    </div>
    <div id="para-div">
      <p>The <span class="hi-green">-n</span> option enables the <span class="bold">Network</span> namespace.</p>
    </div>
    <div id="para-div">
      <p>The command prompt will change to a <span class="bold">#</span>.</p>
    </div>
    <div id="para-div">
      <p>To list all the network interfaces in the new namespace, execute the following command in <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p># ip link</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.9</h4>
      <pre>1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</pre>
    </div>
    <div id="para-div">
      <p>From Output.12 above, we see only the <span class="hi-yellow">loopback</span> (<span class="bold">127.0.0.1</span>)
        interface and it is <span class="underbold">DOWN</span>.</p>
    </div>
    <div id="para-div">
      <p>To bring up the <span class="bold">loopback</span> interface in the new namespace, execute the following command in
        <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p># ip link set dev lo up</p>
    </div>
    <div id="para-div">
      <p>To test the <span class="bold">loopback</span> interface in the new namespace, execute the following command in
        <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p># ping 127.0.0.1 -c3</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.10</h4>
      <pre>PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.022 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.024 ms
64 bytes from 127.0.0.1: icmp_seq=3 ttl=64 time=0.020 ms

--- 127.0.0.1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2040ms
rtt min/avg/max/mdev = 0.020/0.022/0.024/0.001 ms</pre>
    </div>
    <div id="para-div">
      <p>We need to create a <span class="hi-yellow">bridge</span> network interface in the parent namespace. A
        <span class="bold">bridge</span> is a virtual network switch used to connect two or more network devices.</p>
    </div>
    <div id="para-div">
      <p>To create a <span class="bold">bridge</span> interface called <span class="hi-green">br0</span> and in the parent
        namespace, execute the following command in <span class="bold">TA</span>:</p>
    </div>
    <div id="cmd-div">
      <p>S sudo brctl addbr br0</p>
    </div>
    <div id="para-div">
      <p>To list all the bridge interfaces in the parent namespace, execute the following command in <span class="bold">TA
        </span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo brctl show</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.11</h4>
      <pre>bridge name bridge id           STP enabled interfaces
br0         8000.000000000000   no</pre>
    </div>
    <div id="para-div">
      <p>Let us assign <span class="bold">br0</span> the address <span class="hi-yellow">172.20.1.2</span>. To assign an
        ip address to the bridge interface <span class="bold">br0</span> in the parent namespace, execute the following
        command in <span class="bold">TA</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo ip addr add 172.20.1.2/24 dev br0</p>
    </div>
    <div id="para-div">
      <p>To bring up the bridge interface <span class="bold">br0</span> in the parent namespace, execute the following
        command in <span class="bold">TA</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo ip link set br0 up</p>
    </div>
    <div id="para-div">
      <p>To list all the network interfaces in the parent namespace, execute the following command in <span class="bold">TA
        </span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ ip link</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.12</h4>
      <pre>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: enp5s0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc fq_codel state DOWN mode DEFAULT group default qlen 1000
    link/ether 18:18:18:05:05:05 brd ff:ff:ff:ff:ff:ff
3: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/ether 0a:ae:d0:65:21:bb brd ff:ff:ff:ff:ff:ff</pre>
    </div>
    <div id="para-div">
      <p>One can add a virtual ethernet device <span class="hi-yellow">veth</span> to the <span class="bold">Network</span>
        namespace. They can act as a tunnel between <span class="bold">Network</span> namespaces and are always created in
        pairs. Packets transmitted on one device in the pair are immediately received on the other device. One end of the
        pair would be in the parent namespace and the other end of the pair would be in the new namespace.</p>
    </div>
    <div id="para-div">
      <p>The following diagram illustrates the bridge network with the virtual ethernet pairs:</p>
    </div>
    <div id="img-outer-div"> <img alt="Bridge Network" class="img-cls" src="./images/bridge-veth.png" />
      <div class="img-cap">Bridge Network</div>
    </div>
    <div id="para-div">
      <p>To create a <span class="bold">veth</span> interface pairs called <span class="hi-green">veth0</span> and
        <span class="hi-green">veth1</span> in the parent namespace, execute the following command in <span class="bold">TA
        </span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo ip link add veth0 type veth peer name veth1</p>
    </div>
    <div id="para-div">
      <p>To list all the network interfaces in the parent namespace, execute the following command in <span class="bold">TA
        </span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ ip link</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.13</h4>
      <pre>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: enp5s0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc fq_codel state DOWN mode DEFAULT group default qlen 1000
    link/ether 18:18:18:05:05:05 brd ff:ff:ff:ff:ff:ff
3: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/ether 0a:ae:d0:65:21:bb brd ff:ff:ff:ff:ff:ff
4: veth1@veth0: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether c6:46:7c:18:1c:ef brd ff:ff:ff:ff:ff:ff
5: veth0@veth1: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 76:3e:78:4e:9d:28 brd ff:ff:ff:ff:ff:ff</pre>
    </div>
    <div id="para-div">
      <p>The end <span class="bold">veth0</span> should be in the parent namespace, while the end <span class="bold">veth1
        </span> should be in the new namespace.</p>
      <p>To place the end <span class="bold">veth1</span> in the new namespace, we need to identify the process ID of the
        command <span class="bold">unshare</span>.</p>
    </div>
    <div id="para-div">
      <p>To find and store the pid of <span class="bold">unshare</span> in an environment variable <span class="hi-yellow">
        UPID</span>, execute the following command in <span class="bold">TA</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ export UPID=$(pidof unshare)</p>
    </div>
    <div id="para-div">
      <p>To place the end <span class="bold">veth1</span> in the new namespace, execute the following command in
        <span class="bold">TA</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo ip link set veth1 netns $UPID</p>
    </div>
    <div id="para-div">
      <p>To list all the network interfaces in the parent namespace, execute the following command in <span class="bold">TA
        </span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ ip link</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.14</h4>
      <pre>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: enp5s0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc fq_codel state DOWN mode DEFAULT group default qlen 1000
    link/ether 18:18:18:05:05:05 brd ff:ff:ff:ff:ff:ff
3: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/ether 0a:ae:d0:65:21:bb brd ff:ff:ff:ff:ff:ff
5: veth0@if6: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 76:3e:78:4e:9d:28 brd ff:ff:ff:ff:ff:ff</pre>
    </div>
    <div id="para-div">
      <p>To list all the network interfaces in the new namespace, execute the following command in <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p># ip link</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.15</h4>
      <pre>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: veth1@if3: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether c6:46:7c:18:1c:ef brd ff:ff:ff:ff:ff:ff</pre>
    </div>
    <div id="para-div">
      <p>Comparing Output.15 and Output.14, we see they are completely different.</p>
    </div>
    <div id="para-div">
      <p>To connect the end <span class="bold">veth0</span> to the bridge <span class="bold">br0</span> in the parent namespace,
        execute the following command in <span class="bold">TA</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo ip link set veth0 master br0 up</p>
    </div>
    <div id="para-div">
      <p>Let us assign <span class="bold">veth0</span> the address <span class="hi-yellow">172.20.1.3</span>. To assign an ip
        address to the network interface <span class="bold">veth0</span> in the parent namespace, execute the following
        command in <span class="bold">TA</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo ip addr add 172.20.1.3/24 dev veth0</p>
    </div>
    <div id="para-div">
      <p>To bring up the network interface <span class="bold">veth0</span> in the parent namespace, execute the following
        command in <span class="bold">TA</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo ip link set veth0 up</p>
    </div>
    <div id="para-div">
      <p>Let us assign <span class="bold">veth1</span> the address <span class="hi-yellow">172.20.1.4</span>. To assign an ip
        address to the network interface <span class="bold">veth1</span> in the new namespace, execute the following command
        in <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p># ip addr add 172.20.1.4/24 dev veth1</p>
    </div>
    <div id="para-div">
      <p>To bring up the network interface <span class="bold">veth1</span> in the new namespace, execute the following
        command in <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p># ip link set veth1 up</p>
    </div>
    <div id="para-div">
      <p>To test the ip address <span class="bold">172.20.1.4</span> (of the container) in the parent namespace, execute the
        following command in <span class="bold">TA</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ ping 172.20.1.4 -c3</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.16</h4>
      <pre>PING 172.20.1.4 (172.20.1.4) 56(84) bytes of data.
64 bytes from 172.20.1.4: icmp_seq=1 ttl=64 time=0.079 ms
64 bytes from 172.20.1.4: icmp_seq=2 ttl=64 time=0.038 ms
64 bytes from 172.20.1.4: icmp_seq=3 ttl=64 time=0.040 ms

--- 172.20.1.4 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2036ms
rtt min/avg/max/mdev = 0.038/0.052/0.079/0.019 ms</pre>
    </div>
    <div id="para-div">
      <p>Similarly, to test the ip address <span class="bold">172.20.1.3</span> (of the host) in the new namespace, execute the
        following command in <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p># ping 172.20.1.3 -c3</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.17</h4>
      <pre>PING 172.20.1.3 (172.20.1.3) 56(84) bytes of data.
64 bytes from 172.20.1.3: icmp_seq=1 ttl=64 time=0.072 ms
64 bytes from 172.20.1.3: icmp_seq=2 ttl=64 time=0.039 ms
64 bytes from 172.20.1.3: icmp_seq=3 ttl=64 time=0.044 ms

--- 172.20.1.3 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2044ms
rtt min/avg/max/mdev = 0.039/0.051/0.072/0.016 ms</pre>
    </div>
    <div id="para-div">
      <p><span class="bold">YAY !!!</span> We have successfully demonstrated a simple container by combining <span class="bold">
        UTS</span>, <span class="bold">User</span>, <span class="bold">PID</span>, <span class="bold">Mount</span>, and
        <span class="bold">Network</span> namespaces using the <span class="bold">unshare</span> command.</p>
    </div>
    <div id="para-div">
      <p>To clean up the bridge interface we created earlier, we need to first bring it down and then delete it.</p>
      <p>To bring down the bridge interface <span class="bold">br0</span> in the parent namespace, execute the following
        command in <span class="bold">TA</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo ip link set br0 down</p>
    </div>
    <div id="para-div">
      <p>To delete the bridge interface <span class="bold">br0</span> in the parent namespace, execute the following command
        in <span class="bold">TA</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo brctl delbr br0</p>
    </div>
    <div id="para-div">
      <p>Next, we will mimic the above <span class="bold">UTS</span>, <span class="bold">User</span>, <span class="bold">
        PID</span>, <span class="bold">Mount</span>, and <span class="bold">Network</span>, namespace isolation using the
        following <span class="bold">go</span> program:</p>
    </div>    
    <div id="src-outer-div-1">
      <div class="src-cap-1">Listing.2</div>
      <div class="src-body-1">
      <pre>package main

import (
    "fmt"
    "github.com/vishvananda/netlink"
    "log"
    "net"
    "os"
    "os/exec"
    "syscall"
)

const (
    Bridge   = "br0"
    BridgeIp = "172.20.1.2/24"
    Lo       = "lo"
    Peer0    = "veth0"
    Peer0Ip  = "172.20.1.3/24"
    Peer1    = "veth1"
    Peer1Ip  = "172.20.1.4/24"
)

func createTxtFile() {
    f, err := os.Create("/tmp/leopard.txt")
    if err != nil {
        panic(err)
    }

    _, err = f.WriteString("leopard")
    if err != nil {
        panic(err)
    }

    _ = f.Close()
}

func checkBridge() (*netlink.Bridge, error) {
    la := netlink.NewLinkAttrs()
    la.Name = Bridge

    br := &netlink.Bridge{LinkAttrs: la}

    if _, err := net.InterfaceByName(Bridge); err != nil {
        return br, err
    }

    return br, nil
}

func setupBridge() error {
    br, err := checkBridge()
    if err != nil {
        log.Printf("Bridge %s does not exists ...\n", Bridge)
        log.Printf("Creating the Bridge %s ...\n", Bridge)

        if err = netlink.LinkAdd(br); err != nil {
            fmt.Println(err)
            return err
        }
    } else {
        log.Printf("Bridge %s already exists ...\n", Bridge)
    }

    addr, err := netlink.ParseAddr(BridgeIp)
    if err != nil {
        fmt.Println(err)
        return err
    }

    log.Printf("Attaching address %s to the Bridge %s ...\n", BridgeIp, Bridge)

    if err = netlink.AddrAdd(br, addr); err != nil {
        fmt.Println(err)
        return err
    }

    log.Printf("Activating the Bridge %s ...\n", Bridge)

    if err = netlink.LinkSetUp(br); err != nil {
        fmt.Println(err)
        return err
    }

    return nil
}

func deleteBridge() error {
    br, err := checkBridge()
    if err != nil {
        fmt.Println(err)
        return err
    }

    log.Printf("Deactivating the Bridge %s ...\n", Bridge)

    if err := netlink.LinkSetDown(br); err != nil {
        fmt.Println(err)
        return err
    }

    log.Printf("Deleting the Bridge %s ...\n", Bridge)

    if err := netlink.LinkDel(br); err != nil {
        fmt.Println(err)
        return err
    }

    return nil
}

func setupVethPeers() error {
    br, err := checkBridge()
    if err != nil {
        fmt.Println(err)
        return err
    }

    la := netlink.NewLinkAttrs()
    la.Name = Peer0
    la.MasterIndex = br.Attrs().Index

    log.Printf("Creating the pairs %s and %s ...\n", Peer0, Peer1)

    // ip link add veth0 type veth peer name veth1
    veth := &netlink.Veth{LinkAttrs: la, PeerName: Peer1}
    if err := netlink.LinkAdd(veth); err != nil {
        fmt.Println(err)
        return err
    }

    log.Printf("Link %s as master of %s ...\n", Bridge, Peer0)

    // ip link set veth0 master br0
    if err = netlink.LinkSetMaster(veth, br); err != nil {
        fmt.Println(err)
        return err
    }

    log.Printf("Activating the pairs %s & %s ...\n", Peer0, Peer1)

    if err = netlink.LinkSetUp(veth); err != nil {
      fmt.Println(err)
      return err
    }

    return nil
}

func namespaceVethPeer(pid int) error {
    log.Printf("Getting the link for pair %s ...\n", Peer1)

    veth1, err := netlink.LinkByName(Peer1)
    if err != nil {
        fmt.Println(err)
        return err
    }

    log.Printf("Namespacing the pair %s with pid %d ...\n", Peer1, pid)

    // ip link set veth1 netns $UPID
    if err := netlink.LinkSetNsPid(veth1, pid); err != nil {
        fmt.Println(err)
        return err
    }

    return nil
}

func activateLo() error {
    log.Printf("Getting the link for pair %s ...\n", Lo)

    loIf, err := netlink.LinkByName(Lo)
    if err != nil {
        fmt.Println(err)
        return err
    }

    log.Printf("Activating %s ...\n", Lo)

    // ip link set dev lo up
    if err = netlink.LinkSetUp(loIf); err != nil {
        fmt.Println(err)
        return err
    }

    return nil
}

func activateVethPair(name, ip string) error {
    log.Printf("Getting the link for pair %s ...\n", name)

    veth, err := netlink.LinkByName(name)
    if err != nil {
        fmt.Println(err)
        return err
    }

    addr, err := netlink.ParseAddr(ip)
    if err != nil {
        fmt.Println(err)
        return err
    }

    log.Printf("Attaching address %s to the pair %s ...\n", ip, name)

    // ip addr add ip dev vethX
    if err = netlink.AddrAdd(veth, addr); err != nil {
        fmt.Println(err)
        return err
    }

    log.Printf("Activating the pair %s ...\n", name)

    // ip link set dev vethX up
    if err = netlink.LinkSetUp(veth); err != nil {
        fmt.Println(err)
        return err
    }

    return nil
}

func execContainerShell() {
    log.Printf("Ready to exec container shell ...\n")

    if err := syscall.Sethostname([]byte("leopard")); err != nil {
        panic(err)
    }

    log.Printf("Chaning to /tmp directory ...\n")

    if err := os.Chdir("/tmp"); err != nil {
        panic(err)
    }

    log.Printf("Mounting / as private ...\n")

    mf := uintptr(syscall.MS_PRIVATE | syscall.MS_REC)
    if err := syscall.Mount("", "/", "", mf, ""); err != nil {
        panic(err)
    }

    log.Printf("Binding rootfs/ to rootfs/ ...\n")

    mf = uintptr(syscall.MS_BIND | syscall.MS_REC)
    if err := syscall.Mount("rootfs/", "rootfs/", "", mf, ""); err != nil {
        panic(err)
    }

    log.Printf("Pivot new root at rootfs/ ...\n")

    if err := syscall.PivotRoot("rootfs/", "rootfs/.old_root"); err != nil {
        panic(err)
    }

    log.Printf("Changing to / directory ...\n")

    if err := os.Chdir("/"); err != nil {
        panic(err)
    }

    log.Printf("Mounting /tmp as tmpfs ...\n")

    mf = uintptr(syscall.MS_NODEV)
    if err := syscall.Mount("tmpfs", "/tmp", "tmpfs", mf, ""); err != nil {
        panic(err)
    }

    log.Printf("Mounting /proc filesystem ...\n")

    mf = uintptr(syscall.MS_NODEV)
    if err := syscall.Mount("proc", "/proc", "proc", mf, ""); err != nil {
        panic(err)
    }

    createTxtFile()

    log.Printf("Mounting /.old_root as private ...\n")

    mf = uintptr(syscall.MS_PRIVATE | syscall.MS_REC)
    if err := syscall.Mount("", "/.old_root", "", mf, ""); err != nil {
        panic(err)
    }

    log.Printf("Unmount parent rootfs from /.old_root ...\n")

    if err := syscall.Unmount("/.old_root", syscall.MNT_DETACH); err != nil {
        panic(err)
    }

    if err := activateLo(); err != nil {
        panic(err)
    }

    if err := activateVethPair(Peer1, Peer1Ip); err != nil {
        panic(err)
    }

    const sh = "/bin/sh"

    env := os.Environ()
    env = append(env, "PS1=-> ")

    if err := syscall.Exec(sh, []string{""}, env); err != nil {
        panic(err)
    }
}

func main() {
    log.Printf("Starting process %s with args: %v\n", os.Args[0], os.Args)

    const clone = "CLONE"

    if len(os.Args) > 1 && os.Args[1] == clone {
        // Clone
        execContainerShell()
    } else {
        // Parent
        if err := setupBridge(); err != nil {
            panic(err)
        }

        if err := setupVethPeers(); err != nil {
            panic(err)
        }

        if err := activateVethPair(Peer0, Peer0Ip); err != nil {
            panic(err)
        }
    }

    log.Printf("Ready to run command ...\n")

    cmd := exec.Command(os.Args[0], []string{clone}...)
    cmd.Stdin = os.Stdin
    cmd.Stdout = os.Stdout
    cmd.Stderr = os.Stderr
    cmd.SysProcAttr = &syscall.SysProcAttr{
        Cloneflags: syscall.CLONE_NEWUTS |
                    syscall.CLONE_NEWUSER |
                    syscall.CLONE_NEWNS |
                    syscall.CLONE_NEWPID |
                    syscall.CLONE_NEWNET,
        UidMappings: []syscall.SysProcIDMap{
            {ContainerID: 0, HostID: 0, Size: 1},
        },
        GidMappings: []syscall.SysProcIDMap{
            {ContainerID: 0, HostID: 0, Size: 1},
        },
    }

    if err := cmd.Start(); err != nil {
        panic(err)
    }

    if err := namespaceVethPeer(cmd.Process.Pid); err != nil {
        panic(err)
    }

    _ = cmd.Wait()

    _ = deleteBridge()
}</pre>
      </div>
    </div>
    <div id="para-div">
      <p>Create and change to the directory <span class="bold">$GOPATH/network</span> by executing the following commands in
        <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ mkdir -p $GOPATH/network</p>
      <p>$ cd $GOPATH/network</p>
    </div>
    <div id="para-div">
      <p>Copy the above code into the program file <span class="bold">main.go</span> in the current directory.</p>
    </div>
    <div id="para-div">
      <p>To compile the program file <span class="bold">main.go</span>, execute the following command in <span class="bold">
        TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ go build main.go</p>
    </div>
    <div id="para-div">
      <p>To run program <span class="bold">main</span>, execute the following command in <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo ./main</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.18</h4>
      <pre>2020/03/14 22:17:52 Starting process ./main with args: [./main]
2020/03/14 22:17:52 Bridge br0 does not exists ...
2020/03/14 22:17:52 Creating the Bridge br0 ...
2020/03/14 22:17:52 Attaching address 172.20.1.2/24 to the Bridge br0 ...
2020/03/14 22:17:52 Activating the Bridge br0 ...
2020/03/14 22:17:52 Creating the pairs veth0 and veth1 ...
2020/03/14 22:17:52 Link br0 as master of veth0 ...
2020/03/14 22:17:52 Activating the pairs veth0 & veth1 ...
2020/03/14 22:17:52 Getting the link for pair veth0 ...
2020/03/14 22:17:52 Attaching address 172.20.1.3/24 to the pair veth0 ...
2020/03/14 22:17:52 Activating the pair veth0 ...
2020/03/14 22:17:52 Ready to run command ...
2020/03/14 22:17:52 Getting the link for pair veth1 ...
2020/03/14 22:17:52 Namespacing the pair veth1 with pid 20367 ...
2020/03/14 22:17:52 Starting process ./main with args: [./main CLONE]
2020/03/14 22:17:52 Ready to exec container shell ...
2020/03/14 22:17:52 Chaning to /tmp directory ...
2020/03/14 22:17:52 Mounting / as private ...
2020/03/14 22:17:52 Binding rootfs/ to rootfs/ ...
2020/03/14 22:17:52 Pivot new root at rootfs/ ...
2020/03/14 22:17:52 Changing to / directory ...
2020/03/14 22:17:52 Mounting /tmp as tmpfs ...
2020/03/14 22:17:52 Mounting /proc filesystem ...
2020/03/14 22:17:52 Mounting /.old_root as private ...
2020/03/14 22:17:52 Unmount parent rootfs from /.old_root ...
2020/03/14 22:17:52 Getting the link for pair lo ...
2020/03/14 22:17:52 Activating lo ...
2020/03/14 22:17:52 Getting the link for pair veth1 ...
2020/03/14 22:17:52 Attaching address 172.20.1.4/24 to the pair veth1 ...
2020/03/14 22:17:52 Activating the pair veth1 ...
-></pre>
    </div>
    <div id="para-div">
      <p>The command prompt will change to a <span class="bold">-&gt;</span>.</p>
    </div>
    <div id="para-div">
      <p>To list all the network interfaces in the parent namespace, execute the following command in <span class="bold">TA
        </span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ cat /proc/self/net/dev</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.19</h4>
      <pre>Inter-|   Receive                                                |  Transmit
 face |bytes    packets errs drop fifo frame compressed multicast|bytes    packets errs drop fifo colls carrier compressed
enp5s0:       0       0    0    0    0     0          0         0        0       0    0    0    0     0       0          0
docker0:       0       0    0    0    0     0          0         0        0       0    0    0    0     0       0          0
    lo:  471708    4702    0    0    0     0          0         0   471708    4702    0    0    0     0       0          0
 veth0:     936      12    0    0    0     0          0         0    27370     162    0    0    0     0       0          0
   br0:     768      12    0    0    0     0          0         0    17220     106    0    0    0     0       0          0</pre>
    </div>
    <div id="para-div">
      <p>To list all the network interfaces in the new namespace, execute the following command in <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p>-&gt; cat /proc/self/net/dev</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.20</h4>
      <pre>Inter-|   Receive                                                |  Transmit
 face |bytes    packets errs drop fifo frame compressed multicast|bytes    packets errs drop fifo colls carrier compressed
    lo:       0       0    0    0    0     0          0         0        0       0    0    0    0     0       0          0
 veth1:   20994     126    0    0    0     0          0         0      796      10    0    0    0     0       0          0</pre>
    </div>
    <div id="para-div">
      <p>Comparing Output.20 and Output.19, we see they are completely different.</p>
    </div>
    <div id="para-div">
      <p>To test the ip address <span class="bold">172.20.1.4</span> (of the container) in the parent namespace, execute the
        following command in <span class="bold">TA</span>:</p>
    </div>
    <div id="cmd-div">
      <p>$ ping 172.20.1.4 -c3</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.21</h4>
      <pre>PING 172.20.1.4 (172.20.1.4) 56(84) bytes of data.
64 bytes from 172.20.1.4: icmp_seq=1 ttl=64 time=0.101 ms
64 bytes from 172.20.1.4: icmp_seq=2 ttl=64 time=0.044 ms
64 bytes from 172.20.1.4: icmp_seq=3 ttl=64 time=0.052 ms

--- 172.20.1.4 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2041ms
rtt min/avg/max/mdev = 0.044/0.065/0.101/0.026 ms</pre>
    </div>
    <div id="para-div">
      <p>Note the new namespace is running a minimalistic Ubuntu Base image and there is no <span class="bold">ping</span>
        command to check the connectivity back to the parent namespace.</p>
    </div>
    <div id="para-div">
      <p>To exit the simple container, execute the following command in <span class="bold">TB</span>:</p>
    </div>
    <div id="cmd-div">
      <p>-&gt; exit</p>
    </div>
    <div id="para-div">
      <p><span class="bold">WALLA !!!</span> We have successfully demonstrated a simple container by combining <span class="bold">
        UTS</span>, <span class="bold">User</span>, <span class="bold">PID</span>, <span class="bold">Mount</span>, and
        <span class="bold">Network</span> namespaces using a simple <span class="bold">go</span> program.</p>
    </div>
    <div id="section-div">
      <p>References</p>
    </div>
    <div id="para-div">
      <p><a href="http://man7.org/linux/man-pages/man7/mount_namespaces.7.html" target="_blank"><span class="bold">Overview of Linux Mount Namespace</span></a></p>
      <p><a href="http://man7.org/linux/man-pages/man7/network_namespaces.7.html" target="_blank"><span class="bold">Overview of Linux Network Namespace</span></a></p>
      <p><a href="https://pkg.go.dev/github.com/vishvananda/netlink?tab=doc" target="_blank"><span class="bold">Go Package - Netlink</span></a></p>
      <p><a href="https://polarsparc.github.io/Linux/Containers-1.html" target="_blank"><span class="bold">Building a Linux Container using Namespaces :: Part - 1</span></a></p>
    </div>
    <br/>
    <hr class="line-hr" />
    <div>
      <a id="footer-a" href="https://polarsparc.github.io/">&copy;&nbsp;PolarSPARC</a>
    </div>
  </body>
</html>
