<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="application/xhtml+xml; charset=windows-1252" />
    <meta name="author" content="Bhaskar.S">
    <meta name="description" content="Introduction to Google Protocol Buffers">
    <meta name="subject" content="Introduction to Google Protocol Buffers">
    <meta name="keywords" content="java, python, protobuf">
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <title>Introduction to Google Protocol Buffers</title>
    <link href="../css/polarsparc-v2.4.css" type="text/css" rel="stylesheet" />
  </head>
  <body>
    <br/>
    <table borber="0">
      <tr>
        <td valign="bottom"><span id="ps-home"></span></td>
        <td valign="bottom"><span id="home-a"><a id="home-a" href="https://polarsparc.github.io/">PolarSPARC</a></span></td>
      </tr>
    </table>
    <br/>
    <div id="title-div">
      <p>Introduction to Google Protocol Buffers</p>
    </div>
    <br />
    <table id="ad-table">
      <tbody>
        <tr>
          <td class="author-td">Bhaskar S</td>
          <td class="date-td">07/04/2020</td>
        </tr>
      </tbody>
    </table>
    <hr class="line-hr" />
    <br />
    <div id="section-div">
    <p>Overview</p>
    </div>
    <div id="para-div">
      <p>Google <a href="https://developers.google.com/protocol-buffers/" target="_blank"><span class="bold">Protocol Buffers</span></a>
        (sometimes referred to as <span class="bold">protobuf</span>) is a Data Serialization framework with the following features:</p>
      <ul id="blue-sqr-ul">
        <li>
          <p>Is platform neutral</p>
        </li>
        <li>
          <p>Is language neutral with official support for <span class="bold">C++</span>, <span class="bold">C#</span>,
            <span class="bold">Go</span>, <span class="bold">Java</span>, and <span class="bold">Python</span></p>
        </li>
        <li>
          <p>Is compact, efficient, fast, and flexible</p>
        </li>
        <li>
          <p>Supports for schema evolution</p>
        </li>
        <li>
          <p>Supports basic scalar types such as <span class="bold">bool</span>, <span class="bold">bytes</span>, <span class="bold">
            double</span>, <span class="bold">fixed32</span>, <span class="bold">fixed64</span>, <span class="bold">float</span>,
            <span class="bold">int32</span>, <span class="bold">int64</span>, <span class="bold">sint32</span>, <span class="bold">
            sint64</span>, <span class="bold">string</span>, <span class="bold">uint32</span>, <span class="bold">uint64</span>, etc</p>
        </li>
        <li>
          <p>Supports complex types such as <span class="bold">enum</span>, <span class="bold">map</span>, <span class="bold">
            message</span>, etc</p>
        </li>
        <li>
          <p>Data elements of custom type (the data format) are defined in a <span class="hi-yellow">.proto</span> file</p>
        </li>
      </ul>
    </div>
    <div id="section-div">
      <p>Installation and Setup</p>
    </div>
    <div id="para-div">
      <p>The installation is on a <span class="bold">Ubuntu 20.04 LTS</span> based Linux desktop.</p>
      <p>We need to install the packages for the protobuf compiler called <span class="hi-yellow">protobuf-compiler</span> and the
        Python language bindings called <span class="hi-yellow">python3-protobuf</span>, from the Ubuntu repository.</p>
    </div>
    <div id="para-div">
      <p>To install the mentioned packages, execute the following commands:</p>
    </div>
    <div id="cmd-div">
      <p>$ sudo apt-get update</p>
      <p>$ sudo apt-get install protobuf-compiler -y</p>
      <p>$ sudo apt-get install python3-protobuf -y</p>
    </div>
    <div id="para-div">
      <p>For Java language bindings, we will need the JAR file called <span class="hi-yellow">protobuf-java-3.x.y.jar</span>, where
        x.y is the current version. At the time of this article, the current version is <span class="hi-yellow">3.11.4</span>. We will
        leverage Maven to manage the Java dependencies.</p>
    </div>
    <div id="para-div">
      <p>The following is the Maven <span class="bold">pom.xml</span> file we will use:</p>
    </div>
    <div id="src-outer-div-1">
      <div class="src-cap-1">pom.xml</div>
      <div class="src-body-1">
<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;

    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;com.polarsparc.protobuf3&lt;/groupId&gt;
    &lt;artifactId&gt;Protobuf3&lt;/artifactId&gt;
    &lt;version&gt;1.0&lt;/version&gt;

    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.google.protobuf&lt;/groupId&gt;
            &lt;artifactId&gt;protobuf-java&lt;/artifactId&gt;
            &lt;version&gt;3.11.4&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
            &lt;artifactId&gt;junit-jupiter-engine&lt;/artifactId&gt;
            &lt;version&gt;5.6.1&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;version&gt;3.8.1&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;source&gt;1.8&lt;/source&gt;
                    &lt;target&gt;1.8&lt;/target&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
                &lt;artifactId&gt;build-helper-maven-plugin&lt;/artifactId&gt;
                &lt;version&gt;3.2.0&lt;/version&gt;
                &lt;executions&gt;
                    &lt;execution&gt;
                        &lt;phase&gt;generate-sources&lt;/phase&gt;
                        &lt;goals&gt;
                            &lt;goal&gt;add-source&lt;/goal&gt;
                        &lt;/goals&gt;
                        &lt;configuration&gt;
                            &lt;sources&gt;
                                &lt;source&gt;target/generated-sources/main/java&lt;/source&gt;
                            &lt;/sources&gt;
                        &lt;/configuration&gt;
                    &lt;/execution&gt;
                &lt;/executions&gt;
            &lt;/plugin&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.xolstice.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;protobuf-maven-plugin&lt;/artifactId&gt;
                &lt;version&gt;0.6.1&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;attachProtoSources&gt;false&lt;/attachProtoSources&gt;
                    &lt;checkStaleness&gt;true&lt;/checkStaleness&gt;
                    &lt;clearOutputDirectory&gt;false&lt;/clearOutputDirectory&gt;
                    &lt;outputDirectory&gt;target/generated-sources/main/java&lt;/outputDirectory&gt;
                    &lt;protocExecutable&gt;/usr/bin/protoc&lt;/protocExecutable&gt;
                    &lt;protoSourceRoot&gt;src/main/proto&lt;/protoSourceRoot&gt;
                &lt;/configuration&gt;
                &lt;executions&gt;
                    &lt;execution&gt;
                        &lt;goals&gt;
                            &lt;goal&gt;compile&lt;/goal&gt;
                            &lt;goal&gt;test-compile&lt;/goal&gt;
                        &lt;/goals&gt;
                    &lt;/execution&gt;
                &lt;/executions&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;</pre>
      </div>
    </div>
    <div id="para-div">
      <p>Once the data format is defined and saved in a <span class="bold">.proto</span> file, we run the protobuf compiler (called
        <span class="hi-yellow">protoc</span>) on the <span class="bold">.proto</span> file to generate the data access classes for
        the desired language bindings (Java, Python, etc).</p>
      <p>In this article, we will demostrate the serialzation and deserialization using both the Java and Python language bindings.</p>
    </div>
    <div id="section-div">
      <p>Hands-on with Google Protocol Buffers</p>
    </div>
    <div id="para-div">
      <p>We will demonstrate the ability to both serialize and deserialize a simple object <span class="bold">Customer</span> with
        scalar types using protobuf.</p>
    </div>
    <div id="para-div">
      <p>The following is the schema definition for a <span class="bold">Customer</span> object defined in the file <span class="bold">
        Customer.proto</span> located in the directory <span class="bold">src/main/proto</span> as shown below:</p>
    </div>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Customer.proto</div>
      <div class="src-body-1">
      <pre>/*
    @Author: Bhaskar S
    @Blog:   https://polarsparc.github.io
    @Date:   04 Jul 2020
*/

syntax = "proto3";

package com.polarsparc.protobuf3.simple;

message Customer {
  string first_name = 1;
  string last_name = 2;
  string email_id = 3;

  int32 age = 4;

  repeated string phone_no = 5;
}</pre>
      </div>
    </div>
    <div id="para-div">
      <p>Google Protocol Buffers version 3 referred to as <span class="hi-yellow">proto3</span> is specified using the
        <span class="hi-yellow">syntax</span> keyword.</p>
      <p>To avoid any namespace collisions, we use the <span class="hi-yellow">package</span> keyword.</p>
      <p>A <span class="bold">Customer</span> object is defined using the <span class="hi-yellow">message</span> keyword. Each field
        within the <span class="bold">Customer</span> object is defined using the following general syntax:</p>
      <p><span class="bold">[repeated] &lt;field-type&gt; &lt;field-name&gt; = &lt;field-tag&gt;</span></p>
      <p>where,</p>
      <ul id="blue-sqr-ul">
        <li><p>The optional value of <span class="hi-green">repeated</span> is used for fields that can be repeated zero or more times</p></li>
        <li><p><span class="bold">&lt;field-type&gt;</span> specifies the data type and can be any scalar type or complex type</p></li>
        <li><p><span class="bold">&lt;field-name&gt;</span> specifies the name of the field</p></li>
        <li><p><span class="bold">&lt;field-tag&gt;</span> specifies a unique integer representation for the field and should
          *<span class="underbold">NOT</span>* be changed once in use. Integers 19000 through 19999 are reserved and cannot be used</p></li>
      </ul>
    </div>
    <div id="para-div">
      <p>Let us now compile the <span class="bold">Customer.proto</span> file for Java and Python.</p>
    </div>
    <div id="para-div">
      <p>For Java binding, run Maven <span class="bold">compile</span>. This will generate a Java file called <span class="hi-yellow">
        CustomerOuterClass.java</span> in the directory <span class="bold">target/generated-sources/main/java/com/polarsparc/protobuf3</span>.</p>
    </div>
    <div id="para-div">
      <p>Let us create a Java program called <span class="bold">CustomerTest.java</span> to use the generated class in the directory
        <span class="bold">src/main/java/com/polarsparc/protobuf3</span> as shown below:</p>
    </div>
    <div id="src-outer-div-1">
      <div class="src-cap-1">CustomerTest.java</div>
      <div class="src-body-1">
      <pre>/*
    @Author: Bhaskar S
    @Blog:   https://polarsparc.github.io
    @Date:   04 Jul 2020
*/

package com.polarsparc.protobuf3;

import com.google.protobuf.InvalidProtocolBufferException;

import com.polarsparc.protobuf3.simple.CustomerOuterClass.Customer;

public class CustomerTest {
    public static void main(String[] args) {
        Customer.Builder builder = Customer.newBuilder();

        builder.setFirstName("Bugs")
                .setLastName("Bunny")
                .setEmailId("bugs.b@carrot.co")
                .addPhoneNo("100-100-1000")
                .addPhoneNo("100-100-1005");

        Customer customer = builder.build();

        System.out.printf("Customer fields: %s\n", customer.getAllFields());
        System.out.printf("Customer data size: %d\n", customer.getSerializedSize());
        System.out.printf("Customer: %s\n", customer);

        byte[] data = customer.toByteArray();

        Customer customer2 = null;
        try {
            customer2 = Customer.parseFrom(data);
        }
        catch (InvalidProtocolBufferException ex) {
            System.out.printf("Exception: %s\n", ex.getMessage());
        }

        System.out.printf("Customer deserialized: %s\n", customer2);
    }
}</pre>
      </div>
    </div>
    <div id="para-div">
      <p>The Java class(es) generated by protobuf compiler are all immutable. To construct a <span class="bold">Customer</span>
        object, one must first use the corresponding builder class (called <span class="bold">Customer.Builder</span>) to set the
        field values in the object and then finally call the <span class="bold">build()</span> method to get the object.</p>
    </div>
    <div id="para-div">
      <p>Executing the above Java program <span class="bold">CustomerTest.java</span>, produces the following results as shown in
        Output.1 below:</p>
    </div>
    <div id="out-div">
      <h4>Output.1</h4>
      <pre>Customer fields: {com.polarsparc.protobuf3.Customer.first_name=Bugs, com.polarsparc.protobuf3.Customer.last_name=Bunny, com.polarsparc.protobuf3.Customer.email_id=bugs.b@carrot.co, com.polarsparc.protobuf3.Customer.phone_no=[100-100-1000, 100-100-1005]}
Customer data size: 59
Customer: first_name: "Bugs"
last_name: "Bunny"
email_id: "bugs.b@carrot.co"
phone_no: "100-100-1000"
phone_no: "100-100-1005"

Customer deserialized: first_name: "Bugs"
last_name: "Bunny"
email_id: "bugs.b@carrot.co"
phone_no: "100-100-1000"
phone_no: "100-100-1005"</pre>
    </div>
    <div id="para-div">
      <p>Now, switching gears to the Python binding, compile the <span class="bold">Customer.proto</span> file using the following
        command:</p>
    </div>
    <div id="cmd-div">
      <p>$ protoc --python_out=. ./Customer.proto</p>
    </div>
    <div id="para-div">
      <p>The compilation will generate a Python file called <span class="hi-yellow">Customer_pb2.py</span> in the specified directory,
        which is the current directory.</p>
    </div>
    <div id="para-div">
      <p>Let us create a Python script called <span class="bold">CustomerTest.py</span> to use the generated script in the current
        directory as shown below:</p>
    </div>
    <div id="src-outer-div-1">
      <div class="src-cap-1">CustomerTest.py</div>
      <div class="src-body-1">
      <pre>#
# @Author: Bhaskar S
# @Blog:   https: // polarsparc.github.io
# @Date:   04 Jul 2020
#
        
import Customer_pb2

customer = Customer_pb2.Customer()
customer.first_name = "Bugs"
customer.last_name = "Bunny"
customer.email_id = "bugs.b@carrot.co"
customer.phone_no.append("100-100-1000")
customer.phone_no.append("100-100-1005")

print("Customer fields: %s" % customer.ListFields())
print("Customer data size: %s" % customer.ByteSize())
print("Customer: %s" % customer)

data = customer.SerializeToString()

customer2 = Customer_pb2.Customer()
customer2.ParseFromString(data)

print("Customer deserialized: %s" % customer2)</pre>
      </div>
    </div>
    <div id="para-div">
      <p>To construct a <span class="bold">Customer</span> object, one must first import the generated module (called <span class="bold">
        Customer_pb2</span>) and invoke the empty constructor. One can then set the field values in the object like any regular Python
        object.</p>
    </div>
    <div id="para-div">
      <p>Executing the above Python script <span class="bold">CustomerTest.py</span>, produces the following results as shown in Output.2
        below:</p>
    </div>
    <div id="out-div">
      <h4>Output.2</h4>
      <pre>Customer fields: [(&lt;google.protobuf.pyext._message.FieldDescriptor object at 0x7fe687eca290>, 'Bugs'), (&lt;google.protobuf.pyext._message.FieldDescriptor object at 0x7fe687eca2b0>, 'Bunny'), (&lt;google.protobuf.pyext._message.FieldDescriptor object at 0x7fe687eca2d0>, 'bugs.b@carrot.co'), (&lt;google.protobuf.pyext._message.FieldDescriptor object at 0x7fe687eca2f0>, ['100-100-1000', '100-100-1005'])]
Customer data size: 59
Customer: first_name: "Bugs"
last_name: "Bunny"
email_id: "bugs.b@carrot.co"
phone_no: "100-100-1000"
phone_no: "100-100-1005"

Customer deserialized: first_name: "Bugs"
last_name: "Bunny"
email_id: "bugs.b@carrot.co"
phone_no: "100-100-1000"
phone_no: "100-100-1005"</pre>
    </div>
    <div id="para-div">
      <p>Now, we will demonstrate the ability to both serialize and deserialize an object <span class="bold">Account</span> with
        complex types using protobuf.</p>
    </div>
    <div id="para-div">
      <p>The following is the schema definition for <span class="bold">Customer</span> and <span class="bold">Account</span> objects
        defined in the file <span class="bold">CustomerAccount.proto</span> located in the directory <span class="bold">src/main/proto
        </span> as shown below:</p>
    </div>
    <div id="src-outer-div-1">
      <div class="src-cap-1">CustomerAccount.proto</div>
      <div class="src-body-1">
      <pre>/*
    @Author: Bhaskar S
    @Blog:   https://polarsparc.github.io
    @Date:   04 Jul 2020
*/

syntax = "proto3";

package com.polarsparc.protobuf3.complex;

option java_outer_classname = "CustomerAccount";

message Customer {
  string first_name = 1;
  string last_name = 2;
  string email_id = 3;

  int32 age = 4;

  repeated string phone_no = 5;
}

enum AccountType {
  CA_UNKNOWN = 0;
  CA_SAVINGS = 1;
  CA_CHECKING = 2;
  CA_BROKERAGE = 3;
}

message Account {
  string acct_no = 1;

  AccountType acct_type = 2;

  Customer customer = 3;
}</pre>
      </div>
    </div>
    <div id="para-div">
      <p>Notice the use of the <span class="hi-yellow">option</span> keyword with <span class="hi-green">java_outer_classname</span>
        to force the name of the outer class generated by protobuf compiler.</p>
      <p>To define a pre-defined set of constants, we use the <span class="hi-yellow">enum</span> keyword. In this example
        <span class="bold">AccountType</span> is defined as an <span class="bold">enum</span> with the constants <span class="bold">
          CA_UNKNOWN</span>, <span class="bold">CA_SAVINGS</span>, <span class="bold">CA_CHECKING</span>, and <span class="bold">
          CA_BROKERAGE</span>. There *<span class="underbold">MUST</span>* always be a zero value enum, so that we can use 0 as a
          numeric default value.</p>
      <p>A field in a <span class="bold">message</span> can refer other <span class="bold">message</span> types.
        In this example, one of the fields in the <span class="bold">Account</span> type references the
        <span class="bold">Customer</span> type.</p>
    </div>
    <div id="para-div">
      <p>Let us now compile the <span class="bold">CustomerAccount.proto</span> file for Java and Python.</p>
    </div>
    <div id="para-div">
      <p>For Java binding, run Maven <span class="bold">compile</span>. This will generate a Java file called <span class="hi-yellow">
        CustomerAccount.java</span> in the directory <span class="bold">target/generated-sources/main/java/com/polarsparc/protobuf3</span>.</p>
    </div>
    <div id="para-div">
      <p>Let us create a Java program called <span class="bold">CustomerAccountTest.java</span> to use the generated class(es) in the
        directory <span class="bold">src/main/java/com/polarsparc/protobuf3</span> as shown below:</p>
    </div>
    <div id="src-outer-div-1">
      <div class="src-cap-1">CustomerAccountTest.java</div>
      <div class="src-body-1">
      <pre>/*
    @Author: Bhaskar S
    @Blog:   https://polarsparc.github.io
    @Date:   04 Jul 2020
*/

package com.polarsparc.protobuf3;

import com.google.protobuf.InvalidProtocolBufferException;

import com.polarsparc.protobuf3.CustomerAccount.complex.Account;
import com.polarsparc.protobuf3.CustomerAccount.complex.AccountType;
import com.polarsparc.protobuf3.CustomerAccount.complex.Customer;

public class CustomerAccountTest {
    public static void main(String[] args) {
        Customer customer = Customer.newBuilder()
                .setFirstName("Bugs")
                .setLastName("Bunny")
                .setEmailId("bugs.b@carrot.co")
                .addPhoneNo("100-100-1000")
                .addPhoneNo("100-100-1005")
                .build();

        Account account = Account.newBuilder()
                .setAcctNo("12345")
                .setAcctType(AccountType.CA_BROKERAGE)
                .setCustomer(customer)
                .build();

        System.out.printf("Account fields: %s\n", account.getAllFields());
        System.out.printf("Account data size: %d\n", account.getSerializedSize());
        System.out.printf("Account: %s\n", account);

        byte[] data = account.toByteArray();

        Account account2 = null;
        try {
            account2 = Account.parseFrom(data);
        }
        catch (InvalidProtocolBufferException ex) {
            System.out.printf("Exception: %s\n", ex.getMessage());
        }

        System.out.printf("Account deserialized: %s\n", account2);
    }
}</pre>
      </div>
    </div>
    <div id="para-div">
      <p>Executing the above Java program <span class="bold">CustomerAccountTest.java</span>, produces the following results as shown
        in Output.3 below:</p>
    </div>
    <div id="out-div">
      <h4>Output.3</h4>
      <pre>Account fields: {com.polarsparc.protobuf3.Account.acct_no=12345, com.polarsparc.protobuf3.Account.acct_type=CA_BROKERAGE, com.polarsparc.protobuf3.Account.customer=first_name: "Bugs"
last_name: "Bunny"
email_id: "bugs.b@carrot.co"
phone_no: "100-100-1000"
phone_no: "100-100-1005"
}
Account data size: 70
Account: acct_no: "12345"
acct_type: CA_BROKERAGE
customer {
  first_name: "Bugs"
  last_name: "Bunny"
  email_id: "bugs.b@carrot.co"
  phone_no: "100-100-1000"
  phone_no: "100-100-1005"
}

Account deserialized: acct_no: "12345"
acct_type: CA_BROKERAGE
customer {
  first_name: "Bugs"
  last_name: "Bunny"
  email_id: "bugs.b@carrot.co"
  phone_no: "100-100-1000"
  phone_no: "100-100-1005"
}</pre>
    </div>
    <div id="para-div">
      <p>Now, switching gears to the Python binding, compile the <span class="bold">CustomerAccount.proto</span> file using the
        following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ protoc --python_out=. ./CustomerAccount.proto</p>
    </div>
    <div id="para-div">
      <p>The compilation will generate a Python file called <span class="hi-yellow">CustomerAccount_pb2.py</span> in the specified
        directory, which is the current directory.</p>
    </div>
    <div id="para-div">
      <p>Let us create a Python script called <span class="bold">CustomerAccountTest.py</span> to use the generated script in the
        current directory as shown below:</p>
    </div>
    <div id="src-outer-div-1">
      <div class="src-cap-1">CustomerAccountTest.py</div>
      <div class="src-body-1">
      <pre>#
# @Author: Bhaskar S
# @Blog:   https: // polarsparc.github.io
# @Date:   04 Jul 2020
#

import CustomerAccount_pb2

account = CustomerAccount_pb2.Account()
account.acct_no = "12345"
account.acct_type = CustomerAccount_pb2.BROKERAGE
account.customer.first_name = "Bugs"
account.customer.last_name = "Bunny"
account.customer.email_id = "bugs.b@carrot.co"
account.customer.phone_no.append("100-100-1000")
account.customer.phone_no.append("100-100-1005")

print("Account fields: %s" % account.ListFields())
print("Account data size: %s" % account.ByteSize())
print("Account: %s" % account)

data = account.SerializeToString()

account2 = CustomerAccount_pb2.Account()
account2.ParseFromString(data)

print("Account deserialized: %s" % account2)</pre>
      </div>
    </div>
    <div id="para-div">
      <p>Notice how the fields of the <span class="bold">Customer</span> object within the <span class="bold">Account</span> object
        are set in Python.</p>
    </div>
    <div id="para-div">
      <p>Executing the above Python script <span class="bold">CustomerAccountTest.py</span>, produces the following results as shown
        in Output.4 below:</p>
    </div>
    <div id="out-div">
      <h4>Output.4</h4>
      <pre>Account fields: [(&lt;google.protobuf.pyext._message.FieldDescriptor object at 0x7f19b6f9de10>, '12345'), (&lt;google.protobuf.pyext._message.FieldDescriptor object at 0x7f19b6f9de30>, 2), (&lt;google.protobuf.pyext._message.FieldDescriptor object at 0x7f19b6f9de50>, first_name: "Bugs"
last_name: "Bunny"
email_id: "bugs.b@carrot.co"
phone_no: "100-100-1000"
phone_no: "100-100-1005"
)]
Account data size: 70
Account: acct_no: "12345"
acct_type: CA_BROKERAGE
customer {
  first_name: "Bugs"
  last_name: "Bunny"
  email_id: "bugs.b@carrot.co"
  phone_no: "100-100-1000"
  phone_no: "100-100-1005"
}

Account deserialized: acct_no: "12345"
acct_type: CA_BROKERAGE
customer {
  first_name: "Bugs"
  last_name: "Bunny"
  email_id: "bugs.b@carrot.co"
  phone_no: "100-100-1000"
  phone_no: "100-100-1005"
}</pre>
    </div>
    <div id="para-div">
      <p>In the above example, we had all the object definitions in a single <span class="bold">CustomerAccount.proto</span> schema
        definition file.</p>
      <p>We could modularize the object definitions and separate them into two <span class="bold">.proto</span> files - one for the
        <span class="bold">Customer</span> related object(s) and the other for the <span class="bold">Account</span> related object(s).</p>
    </div>
    <div id="para-div">
      <p>The following is the schema definition for the <span class="bold">Customer2</span> related object(s) defined in the file
        <span class="bold">Customer2.proto</span> located in the directory <span class="bold">src/main/proto</span> as shown below:</p>
    </div>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Customer2.proto</div>
      <div class="src-body-1">
      <pre>/*
    @Author: Bhaskar S
    @Blog:   https://polarsparc.github.io
    @Date:   04 Jul 2020
  */

syntax = "proto3";

package com.polarsparc.protobuf3.modular;

option java_outer_classname = "CustomerInfo";
option java_multiple_files = true;

enum PhoneType2 {
  PT_UNKNOWN = 0;
  PT_HOME = 1;
  PT_MOBILE = 2;
  PT_WORK = 3;
}

message PhoneNumber2 {
  string number = 1;

  PhoneType2 type = 2;
}

message Customer2 {
  string first_name = 1;
  string last_name = 2;
  string email_id = 3;

  int32 age = 4;

  repeated PhoneNumber2 phone_no = 5;
}</pre>
      </div>
    </div>
    <div id="para-div">
      <p>Notice the use of the <span class="hi-yellow">option</span> keyword with <span class="hi-green">java_multiple_files</span>
        which causes top-level messages, enums, etc to be defined at the package level, rather than inside an outer class file.</p>
    </div>
    <div id="para-div">
      <p>And, here is the schema definition for the <span class="bold">Account2</span> related object(s) defined in the file
        <span class="bold">Account2.proto</span> located in the directory <span class="bold">src/main/proto</span> as shown below:</p>
    </div>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Account2.proto</div>
      <div class="src-body-1">
      <pre>/*
    @Author: Bhaskar S
    @Blog:   https://polarsparc.github.io
    @Date:   04 Jul 2020
  */

syntax = "proto3";

package com.polarsparc.protobuf3.modular;

option java_outer_classname = "AccountInfo";
option java_multiple_files = true;

import "Customer2.proto";

enum AccountType2 {
  AT_UNKNOWN = 0;
  AT_SAVINGS = 1;
  AT_CHECKING = 2;
  AT_BROKERAGE = 3;
}

message Account2 {
  string acct_no = 1;

  AccountType2 acct_type = 2;

  Customer2 customer = 3;
}</pre>
      </div>
    </div>
    <div id="para-div">
      <p>In the above <span class="bold">Account2.proto</span> file, we <span class="hi-yellow">import</span> the <span class="bold">
        Customer2.proto</span> file.</p>
    </div>
    <div id="para-div">
      <p>Let us now compile both the <span class="bold">Customer2.proto</span> and the <span class="bold">Account2.proto</span>
        files for Java and Python.</p>
    </div>
    <div id="para-div">
      <p>For Java binding, run Maven <span class="bold">compile</span>. This will generate a Java file for each object type defined
        in the schema file(s) in the directory <span class="bold">target/generated-sources/main/java/com/polarsparc/protobuf3</span>.</p>
    </div>
    <div id="para-div">
      <p>Let us create a Java program called <span class="bold">CustomerAccountTest2.java</span> to use the generated classes
        in the directory <span class="bold">src/main/java/com/polarsparc/protobuf3</span> as shown below:</p>
    </div>
    <div id="src-outer-div-1">
      <div class="src-cap-1">CustomerAccountTest2.java</div>
      <div class="src-body-1">
      <pre>/*
    @Author: Bhaskar S
    @Blog:   https://polarsparc.github.io
    @Date:   04 Jul 2020
*/

package com.polarsparc.protobuf3;

import com.google.protobuf.InvalidProtocolBufferException;

import com.polarsparc.protobuf3.modular.*;

import java.util.Arrays;

public class CustomerAccountTest2 {
    public static void main(String[] args) {
        PhoneNumber2 phoneNo1 = PhoneNumber2.newBuilder()
                .setNumber("100-100-1000")
                .setType(PhoneType2.PT_MOBILE)
                .build();

        PhoneNumber2 phoneNo2 = PhoneNumber2.newBuilder()
                .setNumber("100-100-1005")
                .setType(PhoneType2.PT_WORK)
                .build();

        Customer2 customer = Customer2.newBuilder()
                .setFirstName("Bugs")
                .setLastName("Bunny")
                .setEmailId("bugs.b@looney.us")
                .addAllPhoneNo(Arrays.asList(phoneNo1, phoneNo2))
                .build();

        Account2 account = Account2.newBuilder()
                .setAcctNo("12345")
                .setAcctType(AccountType2.AT_SAVINGS)
                .setCustomer(customer)
                .build();

        System.out.printf("Account fields: %s\n", account.getAllFields());
        System.out.printf("Account data size: %d\n", account.getSerializedSize());
        System.out.printf("Account: %s\n", account);

        byte[] data = account.toByteArray();

        Account2 account2 = null;
        try {
            account2 = Account2.parseFrom(data);
        }
        catch (InvalidProtocolBufferException ex) {
            System.out.printf("Exception: %s\n", ex.getMessage());
        }

        System.out.printf("Account deserialized: %s\n", account2);
    }
}</pre>
      </div>
    </div>
    <div id="para-div">
      <p>Executing the above Java program <span class="bold">CustomerAccountTest2.java</span>, produces the following results as
        shown in Output.5 below:</p>
    </div>
    <div id="out-div">
      <h4>Output.5</h4>
      <pre>Account fields: {com.polarsparc.protobuf3.Account2.acct_no=12345, com.polarsparc.protobuf3.Account2.acct_type=AT_SAVINGS, com.polarsparc.protobuf3.Account2.customer=first_name: "Bugs"
last_name: "Bunny"
email_id: "bugs.b@looney.us"
phone_no {
  number: "100-100-1000"
  type: PT_MOBILE
}
phone_no {
  number: "100-100-1005"
  type: PT_WORK
}
}
Account data size: 78
Account: acct_no: "12345"
acct_type: AT_SAVINGS
customer {
  first_name: "Bugs"
  last_name: "Bunny"
  email_id: "bugs.b@looney.us"
  phone_no {
    number: "100-100-1000"
    type: PT_MOBILE
  }
  phone_no {
    number: "100-100-1005"
    type: PT_WORK
  }
}

Account deserialized: acct_no: "12345"
acct_type: AT_SAVINGS
customer {
  first_name: "Bugs"
  last_name: "Bunny"
  email_id: "bugs.b@looney.us"
  phone_no {
    number: "100-100-1000"
    type: PT_MOBILE
  }
  phone_no {
    number: "100-100-1005"
    type: PT_WORK
  }
}</pre>
    </div>
    <div id="para-div">
      <p>Now, switching gears to the Python binding, compile both the <span class="bold">Customer2.proto</span> and <span class="bold">
        Account2.proto</span> files using the following commands:</p>
    </div>
    <div id="cmd-div">
      <p>$ protoc --python_out=. ./Customer2.proto</p>
      <p>$ protoc --python_out=. ./Account2.proto</p>
    </div>
    <div id="para-div">
      <p>The compilation will generate two Python files called <span class="hi-yellow">Customer2_pb2.py</span> and
        <span class="hi-yellow">Account2_pb2.py</span> in the specified directory, which is the current directory.</p>
    </div>
    <div id="para-div">
      <p>Let us create a Python script called <span class="bold">CustomerAccountTest2.py</span> to use the generated script in the
        current directory as shown below:</p>
    </div>
    <div id="src-outer-div-1">
      <div class="src-cap-1">CustomerAccountTest2.py</div>
      <div class="src-body-1">
      <pre>#
# @Author: Bhaskar S
# @Blog:   https: // polarsparc.github.io
# @Date:   04 Jul 2020
#

import Customer2_pb2
import Account2_pb2

account = Account2_pb2.Account2()
account.acct_no = "12345"
account.acct_type = Account2_pb2.AT_SAVINGS
account.customer.first_name = "Bugs"
account.customer.last_name = "Bunny"
account.customer.email_id = "bugs.bunny@looney.us"
home = account.customer.phone_no.add()
home.number = "100-100-1000"
home.type = Customer2_pb2.PT_MOBILE
mobile = account.customer.phone_no.add()
mobile.number = "100-100-1005"
mobile.type = Customer2_pb2.PT_WORK

print("Account fields: %s" % account.ListFields())
print("Account data size: %s" % account.ByteSize())
print("Account: %s" % account)

data = account.SerializeToString()

account2 = Account2_pb2.Account2()
account2.ParseFromString(data)

print("Account deserialized: %s" % account2)</pre>
      </div>
    </div>
    <div id="para-div">
      <p>Notice how the fields of the <span class="bold">PhoneNumber2</span> object within the <span class="bold">Customer2</span>
        object inside the <span class="bold">Account2</span> object are set in Python.</p>
    </div>
    <div id="para-div">
      <p>Executing the above Python script <span class="bold">CustomerAccountTest2.py</span>, produces the following results as shown
        in Output.6 below:</p>
    </div>
    <div id="out-div">
      <h4>Output.6</h4>
      <pre>Account fields: [(&lt;google.protobuf.pyext._message.FieldDescriptor object at 0x7fa590626570&gt;, '12345'), (&lt;google.protobuf.pyext._message.FieldDescriptor object at 0x7fa590626230&gt;, 1), (&lt;google.protobuf.pyext._message.FieldDescriptor object at 0x7fa590626330&gt;, first_name: "Bugs"
last_name: "Bunny"
email_id: "bugs.bunny@looney.us"
phone_no {
  number: "100-100-1000"
  type: PT_MOBILE
}
phone_no {
  number: "100-100-1005"
  type: PT_WORK
}
)]
Account data size: 82
Account: acct_no: "12345"
acct_type: AT_SAVINGS
customer {
  first_name: "Bugs"
  last_name: "Bunny"
  email_id: "bugs.bunny@looney.us"
  phone_no {
    number: "100-100-1000"
    type: PT_MOBILE
  }
  phone_no {
    number: "100-100-1005"
    type: PT_WORK
  }
}

Account deserialized: acct_no: "12345"
acct_type: AT_SAVINGS
customer {
  first_name: "Bugs"
  last_name: "Bunny"
  email_id: "bugs.bunny@looney.us"
  phone_no {
    number: "100-100-1000"
    type: PT_MOBILE
  }
  phone_no {
    number: "100-100-1005"
    type: PT_WORK
  }
}</pre>
    </div>
    <div id="para-div">
      <p>We will now demonstrate the ability to serialize an instance of a <span class="bold">Customer</span> object to a file using
        Python and then deserializing the same <span class="bold">Customer</span> instance from the file using Java.</p>
    </div>
    <div id="para-div">
      <p>Let us create a Python script called <span class="bold">SerializeCustomerTest.py</span> to serialize an instance of the
        <span class="bold">Customer</span> object to a file called <span class="bold">/tmp/customer.bin</span> as shown below:</p>
    </div>
    <div id="src-outer-div-1">
      <div class="src-cap-1">SerializeCustomerTest.py</div>
      <div class="src-body-1">
      <pre>#
# @Author: Bhaskar S
# @Blog:   https: // polarsparc.github.io
# @Date:   04 Jul 2020
#

import Customer_pb2

customer = Customer_pb2.Customer()
customer.first_name = "Wile E"
customer.last_name = "Coyote"
customer.phone_no.append("200-101-2001")
customer.phone_no.append("201-102-2002")

print("Customer fields: %s" % customer.ListFields())
print("Customer data size: %s" % customer.ByteSize())
print("Customer: %s" % customer)

with open('/tmp/customer.bin', 'wb') as bf:
    bf.write(customer.SerializeToString())

print("Customer object serialized to /tmp/customer.bin")</pre>
      </div>
    </div>
    <div id="para-div">
      <p>Executing the above Python script <span class="bold">SerializeCustomerTest.py</span>, produces the following results as shown
        in Output.7 below:</p>
    </div>
    <div id="out-div">
      <h4>Output.7</h4>
      <pre>Customer fields: [(&lt;google.protobuf.pyext._message.FieldDescriptor object at 0x7fe8fc223290>, 'Wile E'), (&lt;google.protobuf.pyext._message.FieldDescriptor object at 0x7fe8fc2232b0>, 'Coyote'), (&lt;google.protobuf.pyext._message.FieldDescriptor object at 0x7fe8fc2232d0>, ['200-101-2001', '201-102-2002'])]
Customer data size: 44
Customer: first_name: "Wile E"
last_name: "Coyote"
phone_no: "200-101-2001"
phone_no: "201-102-2002"

Customer object serialized to /tmp/customer.bin</pre>
    </div>
    <div id="para-div">
      <p>Notice that we have not set a value for the <span class="bold">email_id</span> field in the <span class="bold">Customer
        </span> object.</p>
    </div>
    <div id="para-div">
      <p>Let us create a Java program called <span class="bold">DeserializeCustomerTest.java</span> in the directory <span class="bold">
        src/test/com/polarsparc/protobuf3</span> as shown below:</p>
    </div>
    <div id="src-outer-div-1">
      <div class="src-cap-1">DeserializeCustomerTest.java</div>
      <div class="src-body-1">
      <pre>/*
    @Author: Bhaskar S
    @Blog:   https://polarsparc.github.io
    @Date:   04 Jul 2020
*/

package com.polarsparc.protobuf3;

import com.google.protobuf.InvalidProtocolBufferException;

import com.polarsparc.protobuf3.simple.CustomerOuterClass;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;

public class DeserializeCustomerTest {
    public static void main(String[] args) {
        String fname = "/tmp/customer.bin";

        byte[] data = null;
        try {
            data = Files.readAllBytes(Paths.get(fname));
        }
        catch (IOException ex) {
            System.out.printf("Exception: %s\n", ex.getMessage());
        }

        CustomerOuterClass.Customer customer = null;
        try {
            if (data != null) {
                customer = CustomerOuterClass.Customer.parseFrom(data);
            }
        }
        catch (InvalidProtocolBufferException ex) {
            System.out.printf("Exception: %s\n", ex.getMessage());
        }

        System.out.printf("Customer deserialized: %s\n", customer);
    }
}</pre>
      </div>
    </div>
    <div id="para-div">
      <p>Executing the above Java program <span class="bold">DeserializeCustomerTest.java</span>, produces the following results as
        shown in Output.8 below:</p>
    </div>
    <div id="out-div">
      <h4>Output.8</h4>
      <pre>Customer deserialized: first_name: "Wile E"
last_name: "Coyote"
phone_no: "200-101-2001"
phone_no: "201-102-2002"</pre>
    </div>
    <div id="para-div">
      <p>When an object is deserialized, if the encoded message does not contain a particular field, the corresponding field in the
        parsed object is set to the default value for that field. It is <span class="bold">false</span> for type <span class="bold">
        bool</span>, empty bytes for type <span class="bold">bytes</span>, the first defined enum value (must be set to a zero value)
        for type <span class="bold">enum</span>, zero (0) for numeric types (such as <span class="bold">int32</span>,
        <span class="bold">int64</span>, etc), and empty string for type <span class="bold">string</span>.</p>
    </div>
    <div id="para-div">
      <p>This concludes the demonstration of the Google Protocol Buffers (a.k.a <span class="bold">Protobuf</span>) in both Java and
        Python.</p>
    </div>
    <div id="section-div">
      <p>Source Code</p>
    </div>
    <div id="para-div">
      <p><a href="https://github.com/bhaskars-repo/Protobuf3" target="_blank"><span class="bold">Github - Java</span></a></p>
      <p><a href="https://github.com/bhaskars-repo/PyProtobuf3" target="_blank"><span class="bold">Github - Python</span></a></p>
    </div>
    <div id="section-div">
      <p>References</p>
    </div>
    <div id="para-div">
      <p><a href="https://developers.google.com/protocol-buffers/docs/proto3" target="_blank"><span class="bold">Protobuf 3 Language Guide</span></a></p>
      <p><a href="https://developers.google.com/protocol-buffers/docs/javatutorial" target="_blank"><span class="bold">Protobuf Java Basics</span></a></p>
      <p><a href="https://developers.google.com/protocol-buffers/docs/pythontutorial" target="_blank"><span class="bold">Protobuf Python Basics</span></a></p>
      <p><a href="https://www.xolstice.org/protobuf-maven-plugin/index.html" target="_blank"><span class="bold">Maven Protocol Buffers Plugin</span></a></p>
    </div>
    <hr class="line-hr" />
    <div>
      <a id="footer-a" href="https://polarsparc.github.io/">&copy;&nbsp;PolarSPARC</a>
    </div>
  </body>
</html>
