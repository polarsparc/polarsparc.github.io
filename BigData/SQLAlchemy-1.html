<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="application/xhtml+xml; charset=windows-1252" />
    <meta name="author" content="Bhaskar.S">
    <meta name="description" content="Introduction to SQLAlchemy :: Part - 1">
    <meta name="subject" content="Introduction to SQLAlchemy :: Part - 1">
    <meta name="keywords" content="database, python">
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <title>Introduction to SQLAlchemy :: Part - 1</title>
    <link href="../css/polarsparc-v2.4.css" type="text/css" rel="stylesheet" />
  </head>
  <body>
    <br/>
    <table borber="0">
      <tr>
        <td valign="bottom"><span id="ps-home"></span></td>
        <td valign="bottom"><span id="home-a"><a id="home-a" href="https://polarsparc.github.io/">PolarSPARC</a></span></td>
      </tr>
    </table>
    <br/>
    <div id="title-div">
      <p>Introduction to SQLAlchemy :: Part - 1</p>
    </div>
    <br />
    <table id="ad-table">
      <tbody>
        <tr>
          <td class="author-td">Bhaskar S</td>
          <td class="date-td">04/04/2020</td>
        </tr>
      </tbody>
    </table>
    <hr class="line-hr" /> <br />
    <div id="section-div">
      <p>Overview</p>
    </div>
    <div id="para-div">
      <p><span class="hi-yellow">SQLAlchemy</span> (pronounced as <span class="bold">Sequel Alchemy</span>) is a popular SQL
        database abstraction layer for <span class="bold">Python</span>.</p>
      <p><span class="bold">SQLAlchemy</span> consists of two layers - the <span class="hi-blue">Core</span> and the Object
        Relational Mapping (<span class="hi-blue">ORM</span>).</p>
      <p>The following diagram illustrates a very high level view of <span class="bold">SQLAlchemy</span>:</p>
      <div id="img-outer-div"> <img alt="SQLAlchemy Layers" class="img-cls" src="./images/SQLAlchemy-1.png" />
        <div class="img-cap">SQLAlchemy Layers</div>
      </div>
      <p>In this article, we will focus on the <span class="bold">Core</span> layer for interacting with the SQL database.</p>
    </div>
    <div id="section-div">
      <p>Installation and Setup</p>
    </div>
    <div id="para-div">
      <p>The installation is on a <span class="bold">Ubuntu 18.04 LTS</span> based Linux desktop.</p>
    </div>
    <div id="para-div">
      <p>Ensure <span class="bold">Docker</span> is installed on the system. Else, follow the instructions provided in the article
        <a href="https://polarsparc.github.io/Docker/Docker.html" target="_blank"><span class="bold">Introduction to Docker</span></a>
        to complete the installation.</p>
      <p>For our demonstrations, we will be leveraging <span class="hi-yellow">PostgreSQL</span> as our SQL database. Check the
        latest stable version for <a href="https://hub.docker.com/_/postgres" target="_blank"><span class="bold">Postgres</span></a>
        docker image. Version <span class="hi-yellow">12.2</span> was the latest at the time of this article.</p>
      <p>To download the latest docker image for <span class="bold">Postgres</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ docker pull postgres:12.2</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.1</h4>
      <pre>12.2: Pulling from library/postgres
68ced04f60ab: Pull complete 
59f4081d08e6: Pull complete 
74fc17f00df0: Pull complete 
8e5e30d57895: Pull complete 
a1fd179b16c6: Pull complete 
7496d9eb4150: Pull complete 
0328931819fd: Pull complete 
8acde85a664a: Pull complete 
38e831e7d2d3: Pull complete 
582b4ba3b134: Pull complete 
cbf69ccc1db5: Pull complete 
1e1f3255b2e0: Pull complete 
c1c0cedd64ec: Pull complete 
6adde56874ed: Pull complete 
Digest: sha256:110d3325db02daa6e1541fdd37725fcbecb7d51411229d922562f208c51d35cc
Status: Downloaded newer image for postgres:12.2
docker.io/library/postgres:12.2</pre>
    </div>
    <div id="para-div">
      <p>We need to specifiy a directory on the host that will be mounted as a data volume for the <span class="bold">
        Postgres</span> database.</p>
      <p>To create a data directory on the host, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ mkdir -p $HOME/Downloads/Docker/postgres</p>
    </div>
    <div id="para-div">
      <p>Now, we will need to initialze and start the <span class="bold">Postgres</span> database.</p>
      <p>To initialze and start the <span class="bold">Postgres</span> database, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ docker run -d --rm --name postgres-12.2 -e POSTGRES_USER=polarsparc -e POSTGRES_PASSWORD=polarsparc\$123 -p 5432:5432
        -v $HOME/Downloads/Docker/postgres:/var/lib/postgresql/data postgres:12.2</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.2</h4>
      <pre>58916c2912fe4bff8ec2f727f0457011f9f8dcfd9f11f274503e7a839ce916d8</pre>
    </div>
    <div id="para-div">
      <p>To check the <span class="bold">Postgres</span> database log, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ docker logs postgres-12.2</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.3</h4>
      <pre>...SNIP...
2020-04-04 14:21:24.245 UTC [1] LOG:  starting PostgreSQL 12.2 (Debian 12.2-2.pgdg100+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 8.3.0-6) 8.3.0, 64-bit
2020-04-04 14:21:24.245 UTC [1] LOG:  listening on IPv4 address "0.0.0.0", port 5432
2020-04-04 14:21:24.245 UTC [1] LOG:  listening on IPv6 address "::", port 5432
2020-04-04 14:21:24.257 UTC [1] LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432"
2020-04-04 14:21:24.293 UTC [1] LOG:  database system is ready to accept connections</pre>
    </div>
    <div id="para-div">
      <p>Finally, we will need to create the database called <span class="hi-yellow">my_test_db</span>. For that we need to
        enter the docker shell by executing the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ docker exec -it postgres-12.2 sh</p>
    </div>
    <div id="para-div">
      <p>The shell prompt will change to <span class="bold">#</span></p>
    </div>
    <div id="para-div">
      <p>We need to enter the <span class="hi-yellow">psql</span> shell by executing the following command:</p>
    </div>
    <div id="cmd-div">
      <p># psql -U polarsparc</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.4</h4>
      <pre>psql (12.2 (Debian 12.2-2.pgdg100+1))
Type "help" for help.</pre>
    </div>
    <div id="para-div">
      <p>The shell prompt will change to <span class="bold">polarsparc=#</span></p>
    </div>
    <div id="para-div">
      <p>Execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>polarsparc=# CREATE DATABASE my_test_db;</p>
    </div>
    <div id="para-div">
      <p>Next, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>polarsparc=# GRANT ALL PRIVILEGES ON DATABASE my_test_db TO polarsparc;</p>
    </div>
    <div id="para-div">
      <p>To exit <span class="bold">psql</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>polarsparc=# \q</p>
    </div>
    <div id="para-div">
      <p>Finally, to exit docker shell, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p># exit</p>
    </div>
    <div id="para-div">
      <p>Now, we need to install the <span class="hi-yellow">sqlalchemy</span> module for <span class="bold">Python</span> by
        executing the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ python -m pip install sqlalchemy</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.5</h4>
      <pre>Collecting sqlalchemy
  Cache entry deserialization failed, entry ignored
  Cache entry deserialization failed, entry ignored
  Downloading https://files.pythonhosted.org/packages/8c/30/4134e726dd5ed13728ff814fa91fc01c447ad8700504653fe99d91fdd34b/SQLAlchemy-1.3.15.tar.gz (6.1MB)
    100% |********************| 6.1MB 228kB/s 
Installing collected packages: sqlalchemy
  Running setup.py install for sqlalchemy ... done
Successfully installed sqlalchemy-1.3.15</pre>
    </div>
    <div id="para-div">
      <p>Next, we need to install the <span class="hi-yellow">psycopg2-binary</span> module for <span class="bold">Python</span>
        by executing the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ python -m pip install psycopg2-binary</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.6</h4>
      <pre>Collecting psycopg2-binary
  Cache entry deserialization failed, entry ignored
  Downloading https://files.pythonhosted.org/packages/97/2a/b854019bcb9b925cd10ff245dbc9448a82fe7fdb40127e5cf1733ad0765c/psycopg2_binary-2.8.4-cp27-cp27mu-manylinux1_x86_64.whl (2.9MB)
    100% |********************| 2.9MB 400kB/s 
Installing collected packages: psycopg2-binary
Successfully installed psycopg2-binary-2.8.4</pre>
    </div>
    <div id="para-div">
      <p>This completes the necessary setup. Time to get hands-on !!!</p>
    </div>
    <div id="section-div">
      <p>Hands-on with SQLAlchemy Core</p>
    </div>
    <div id="para-div">
      <p>To get started, one needs an instance of <span class="hi-yellow">Engine</span>, which under-the-hood uses a database
        connection pool and a dialect to interact with the specific database (<span class="bold">Postgres</span> in this case).</p>
      <p>The following diagram illustrates the component view of the <span class="bold">Engine</span>:</p>
      <div id="img-outer-div"> <img alt="Engine Components" class="img-cls" src="./images/SQLAlchemy-2.png" />
        <div class="img-cap">Engine Components</div>
      </div>
      <p>The method <span class="hi-blue">create_db_engine</span> in the following <span class="bold">Python</span> program
        (<span class="bold">ex_sa_00.py</span>) creates and returns an instance of <span class="bold">Engine</span>:</p>
    </div>    
    <div id="src-outer-div-1">
      <div class="src-cap-1">ex_sa_00.py</div>
      <div class="src-body-1">
      <pre>from sqlalchemy.engine import Engine
from sqlalchemy.engine.url import URL
from sqlalchemy.engine import create_engine

import logging

logging.basicConfig(format='%(asctime)s - %(message)s', level=logging.INFO)


def create_db_engine() -> Engine:
    postgres_db = {'drivername': 'postgres',
                   'username': 'polarsparc',
                   'password': 'polarsparc$123',
                   'host': 'localhost',
                   'port': 5432,
                   'database': 'my_test_db'}
    db_url = URL(**postgres_db)

    logging.info("Postgres database url: %s" % db_url)

    db_engine = create_engine(db_url)

    with db_engine.connect() as db_conn:
        logging.info("Connected to the Postgres database !!!")

    return db_engine</pre>
      </div>
    </div>
    <div id="para-div">
      <p>The following are brief descriptions for some of the <span class="bold">Python</span> classes and methods:</p>
      <ul id="blue-sqr-ul">
        <li>
          <p><span class="hi-blue">URL</span> :: Represents the various parts, namely, the driver name, the user name, password,
            the host, port, and the database name of the url used to connect to a database</p>
        </li>
        <li>
          <p><span class="hi-blue">Engine</span> :: Represents the entry point through which one can interact with the underlying
            database. It wraps a connection pool and a dialect to the underlying database</p>
        </li>
        <li>
          <p><span class="hi-blue">create_engine()</span> :: Method to create an instance of <span class="bold">Engine</span>
            using the specified database url</p>
        </li>
        <li>
          <p><span class="hi-blue">connect()</span> :: Method on an instance of <span class="bold">Engine</span> to connect to
            the underlying database using an internal connection pool</p>
        </li>
      </ul>
    </div>
    <div id="para-div">
      <p>We will now demonstrate how to create a simple database table called <span class="hi-yellow">securities</span> and
        insert <span class="underbold">3</span> records into the table.</p>
      <p>The following diagram illustrates the <span class="bold">securities</span> database table:</p>
      <div id="img-outer-div"> <img alt="Securities Table" class="img-cls" src="./images/SQLAlchemy-3.png" />
        <div class="img-cap">Securities Table</div>
      </div>
    </div>
    <div id="para-div">
      <p>The method <span class="hi-blue">create_securities_table</span> in the following <span class="bold">Python</span>
        program (<span class="bold">ex_sa_01.py</span>) creates the database table <span class="bold">securities</span> and
        adds an index on the column <span class="bold">symbol</span>. The method <span class="hi-blue">insert_securities_recs
        </span> inserts 3 records into the <span class="bold">securities</span> table:</p>
    </div>    
    <div id="src-outer-div-1">
      <div class="src-cap-1">ex_sa_01.py</div>
      <div class="src-body-1">
      <pre>from sqlalchemy.engine import Engine
from SQLAlchemy.ex_sa_00 import create_db_engine

import logging

logging.basicConfig(format='%(asctime)s - %(message)s', level=logging.INFO)


def create_securities_table(engine: Engine) -> bool:
    status = False

    if not engine.dialect.has_table(engine, 'securities'):
        engine.execute('CREATE TABLE securities ('
                       'id serial PRIMARY KEY,'
                       'symbol varchar(10) UNIQUE NOT NULL,'
                       'price NUMERIC(5, 2))')

        logging.info("Created the securities table !!!")

        engine.execute('CREATE INDEX idx_securities_symbol '
                       'ON securities(symbol)')

        logging.info("Created the idx_securities_symbol index !!!")

        status = True
    else:
        logging.info("The securities table already exists !!!")

    return status


def insert_securities_recs(engine: Engine):
    if engine.dialect.has_table(engine, 'securities'):
        with engine.connect() as db_conn:
            # Record - 1
            resp = db_conn.execute('INSERT INTO securities '
                                   '(symbol, price) '
                                   'VALUES (\'BULL.ST\', 25.75)')
            if resp.rowcount == 1:
                logging.info("Inserted record for BULL.ST")
            else:
                logging.info("Failed to insert record for BULL.ST")

            # Record - 2
            resp = db_conn.execute('INSERT INTO securities '
                                   '(symbol, price) '
                                   'VALUES (\'DOG.ST\', 54.15)')
            if resp.rowcount == 1:
                logging.info("Inserted record for DOG.ST")
            else:
                logging.info("Failed to insert record for DOG.ST")

            # Record - 3
            resp = db_conn.execute('INSERT INTO securities '
                                   '(symbol, price) '
                                   'VALUES (\'BARK.ST\', 144.90)')
            if resp.rowcount == 1:
                logging.info("Inserted record for BARK.ST")
            else:
                logging.info("Failed to insert record for BARK.ST")
    else:
        logging.info("The securities table *DOES NOT* exists !!!")


if __name__ == "__main__":
    db_engine = create_db_engine()
    if create_securities_table(db_engine):
        insert_securities_recs(db_engine)</pre>
      </div>
    </div>
    <div id="para-div">
      <p>The following are brief descriptions for some of the <span class="bold">Python</span> classes and methods:</p>
      <ul id="blue-sqr-ul">
        <li>
          <p><span class="hi-blue">Dialect</span> :: Represents an abstraction to the specifc database (<span class="bold">
            Postgres</span> in this case). It hides all the intricacies of the underlying database, providing an uniform
            and consistent interface for usage</p>
        </li>
        <li>
          <p><span class="hi-blue">has_table()</span> :: Method on a instance of <span class="bold">Dialect</span> to check
            the existence of a database table</p>
        </li>
        <li>
          <p><span class="hi-blue">execute()</span> :: Method to execute the specified <span class="bold">SQL</span> statement.
            This method can be invoked on either an instance of <span class="bold">Engine</span> or on an instance of the
            database connection</p>
        </li>
        <li>
          <p><span class="hi-blue">ResultProxy</span> :: Represents the database cursor object and provides an interface to 
            access the underlying database rows</p>
        </li>
        <li>
          <p><span class="hi-blue">ResultProxy.rowcount</span> :: Returns the number of database rows</p>
        </li>
      </ul>
    </div>
    <div id="para-div">
      <p>To run the Python program <span class="bold">ex_sa_01.py</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ python ex_sa_01.py</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.7</h4>
      <pre>2020-04-04 14:33:57,051 - Postgres database url: postgres://polarsparc:polarsparc$123@localhost:5432/my_test_db
2020-04-04 14:33:57,100 - Connected to the Postgres database !!!
2020-04-04 14:33:57,123 - Created the securities table !!!
2020-04-04 14:33:57,133 - Created the idx_securities_symbol index !!!
2020-04-04 14:33:57,137 - Inserted record for BULL.ST
2020-04-04 14:33:57,138 - Inserted record for DOG.ST
2020-04-04 14:33:57,139 - Inserted record for BARK.ST</pre>
    </div>
    <div id="para-div">
      <p>The following <span class="bold">Python</span> program (<span class="bold">ex_sa_02.py</span>) demonstrates the CRUD
        (Create, Read, Update, Delete) operations on the <span class="bold">securities</span> database table.</p>
    </div>
    <div id="para-div">
      <p>The method <span class="hi-blue">create_dummy_security</span> creates a <span class="bold">DUMMY</span> record, the
        method <span class="hi-blue">query_dummy_security</span> reads the <span class="bold">DUMMY</span> record, the method
        <span class="hi-blue">update_dummy_security</span> updates the <span class="bold">DUMMY</span> record, and finally the
        method <span class="hi-blue">delete_dummy_security</span> deletes the <span class="bold">DUMMY</span> record.</p>
    </div>    
    <div id="src-outer-div-1">
      <div class="src-cap-1">ex_sa_02.py</div>
      <div class="src-body-1">
      <pre>from sqlalchemy.engine import Engine
from SQLAlchemy.ex_sa_00 import create_db_engine

import logging

logging.basicConfig(format='%(asctime)s - %(message)s', level=logging.INFO)


def create_dummy_security(engine: Engine):
    if engine.dialect.has_table(engine, 'securities'):
        with engine.connect() as db_conn:
            resp = db_conn.execute('INSERT INTO securities '
                                   '(symbol, price) '
                                   'VALUES (\'DUMMY\', 1.00)')
            if resp.rowcount == 1:
                logging.info("Inserted record for DUMMY")
            else:
                logging.info("Failed to insert record for DUMMY")
    else:
        logging.info("The securities table *DOES NOT* exists !!!")


def query_dummy_security(engine: Engine):
    if engine.dialect.has_table(engine, 'securities'):
        with engine.connect() as db_conn:
            resp = db_conn.execute('SELECT symbol, price '
                                   'FROM securities '
                                   'WHERE symbol = \'DUMMY\'')
            if resp.rowcount == 1:
                logging.info("Selected record for DUMMY")

                row = resp.fetchone()

                logging.info('Symbol: %s, Price: %d' % (row['symbol'], row[1]))
            else:
                logging.info("Record for DUMMY *DOES NOT* exists !!!")
    else:
        logging.info("The securities table *DOES NOT* exists !!!")


def update_dummy_security(engine: Engine):
    if engine.dialect.has_table(engine, 'securities'):
        with engine.connect() as db_conn:
            resp = db_conn.execute('UPDATE securities '
                                   'SET price = 2.00 '
                                   'WHERE symbol = \'DUMMY\'')
            if resp.rowcount == 1:
                logging.info("Updated record for DUMMY")
            else:
                logging.info("Record for DUMMY *DOES NOT* exists !!!")
    else:
        logging.info("The securities table *DOES NOT* exists !!!")


def delete_dummy_security(engine: Engine):
    if engine.dialect.has_table(engine, 'securities'):
        with engine.connect() as db_conn:
            resp = db_conn.execute('DELETE FROM securities '
                                   'WHERE symbol = \'DUMMY\'')
            if resp.rowcount == 1:
                logging.info("Deleted record for DUMMY")
            else:
                logging.info("Record for DUMMY *DOES NOT* exists !!!")
    else:
        logging.info("The securities table *DOES NOT* exists !!!")


if __name__ == "__main__":
    db_engine = create_db_engine()
    create_dummy_security(db_engine)
    query_dummy_security(db_engine)
    update_dummy_security(db_engine)
    query_dummy_security(db_engine)
    delete_dummy_security(db_engine)
    query_dummy_security(db_engine)</pre>
      </div>
    </div>
    <div id="para-div">
      <p>To run the Python program <span class="bold">ex_sa_02.py</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ python ex_sa_02.py</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.8</h4>
      <pre>2020-04-04 15:09:59,489 - Postgres database url: postgres://polarsparc:polarsparc$123@localhost:5432/my_test_db
2020-04-04 15:09:59,538 - Connected to the Postgres database !!!
2020-04-04 15:09:59,543 - Inserted record for DUMMY
2020-04-04 15:09:59,545 - Selected record for DUMMY
2020-04-04 15:09:59,545 - Symbol: DUMMY, Price: 1
2020-04-04 15:09:59,549 - Updated record for DUMMY
2020-04-04 15:09:59,551 - Selected record for DUMMY
2020-04-04 15:09:59,551 - Symbol: DUMMY, Price: 2
2020-04-04 15:09:59,554 - Deleted record for DUMMY
2020-04-04 15:09:59,555 - Record for DUMMY *DOES NOT* exists !!!</pre>
    </div>
    <div id="para-div">
      <p>Shifting gears, we will now demonstrate another way to create a simple database table called <span class="hi-yellow">
        customer</span> and insert <span class="underbold">3</span> records into the table.</p>
      <p>The following diagram illustrates the <span class="bold">customer</span> database table:</p>
      <div id="img-outer-div"> <img alt="Customer Table" class="img-cls" src="./images/SQLAlchemy-4.png" />
        <div class="img-cap">Customer Table</div>
      </div>
    </div>
    <div id="para-div">
      <p>The method <span class="hi-blue">create_customer_table</span> in the following <span class="bold">Python</span>
        program (<span class="bold">ex_sa_03.py</span>) creates the database table <span class="bold">customer</span> and
        adds an index on the column <span class="bold">last_name</span>. The method <span class="hi-blue">insert_customer_recs
        </span> inserts 3 records into the <span class="bold">customer</span> table:</p>
    </div>    
    <div id="src-outer-div-1">
      <div class="src-cap-1">ex_sa_03.py</div>
      <div class="src-body-1">
      <pre>from sqlalchemy.engine import Engine
from sqlalchemy import MetaData, Table, Column
from sqlalchemy import Integer, String
from SQLAlchemy.ex_sa_00 import create_db_engine

import logging

logging.basicConfig(format='%(asctime)s - %(message)s', level=logging.INFO)


def create_customer_table(engine: Engine) -> bool:
    status = False

    if not engine.dialect.has_table(engine, 'customer'):
        metadata = MetaData()
        customer_table = Table(
            'customer',
            metadata,
            Column('id', Integer, autoincrement=True, primary_key=True),
            Column('first_name', String(25), nullable=False),
            Column('last_name', String(25), nullable=False, index=True),
            Column('email', String(50)),
            Column('mobile', String(10))
        )
        customer_table.create(engine)

        logging.info("Created the customer table !!!")

        status = True
    else:
        logging.info("The customer table already exists !!!")

    return status


def insert_customer_recs(engine: Engine):
    if engine.dialect.has_table(engine, 'customer'):
        metadata = MetaData(bind=engine, reflect=True)
        customer_table = metadata.tables['customer']

        with engine.connect() as db_conn:
            # Record - 1
            rec_1 = customer_table.insert().values(
                first_name='Alice',
                last_name='Doctor',
                email='alice.d@timbuk2.do'
            )
            resp = db_conn.execute(rec_1)
            if resp.rowcount == 1:
                logging.info("Inserted record for Alice")
            else:
                logging.info("Failed to insert record for Alice")

            # Record - 2
            rec_2 = customer_table.insert().values(
                first_name='Bob',
                last_name='Builder',
                email='bbuilder@nomansland.bu'
            )
            resp = db_conn.execute(rec_2)
            if resp.rowcount == 1:
                logging.info("Inserted record for Bob")
            else:
                logging.info("Failed to insert record for Bob")

            # Record - 3
            rec_3 = customer_table.insert().values(
                first_name='Charlie',
                last_name='Driver',
                email='charlie.driver@vehicles.ve'
            )
            resp = db_conn.execute(rec_3)
            if resp.rowcount == 1:
                logging.info("Inserted record for Charlie")
            else:
                logging.info("Failed to insert record for Charlie")
    else:
        logging.info("The customer table *DOES NOT* exists !!!")


if __name__ == "__main__":
    db_engine = create_db_engine()
    if create_customer_table(db_engine):
        insert_customer_recs(db_engine)</pre>
      </div>
    </div>
    <div id="para-div">
      <p>The following are brief descriptions for some of the <span class="bold">Python</span> classes and methods:</p>
      <ul id="blue-sqr-ul">
        <li>
          <p><span class="hi-blue">Metadata</span> :: A container object that holds various pieces of information (such as
            the name of the columns, their associated types, etc) about the different tables in the database</p>
        </li>
        <li>
          <p><span class="hi-blue">Column</span> :: An object that represents a column in a database table. To create an
            instance, one needs to provide a name, the column type, and additional attributes describing the column</p>
        </li>
        <li>
          <p><span class="hi-yellow">autoincrement</span> :: An attribute of the <span class="bold">Column</span> definition
            that indicates the column is an identity column, if set to <span class="bold">True</span></p>
        </li>
        <li>
          <p><span class="hi-yellow">primary_key</span> :: An attribute of the <span class="bold">Column</span> definition
            that indicates the column is a primary key, if set to <span class="bold">True</span></p>
        </li>
        <li>
          <p><span class="hi-yellow">nullable</span> :: An attribute of the <span class="bold">Column</span> definition
            that indicates the column cannot have null values, if set to <span class="bold">False</span></p>
        </li>
        <li>
          <p><span class="hi-yellow">index</span> :: An attribute of the <span class="bold">Column</span> definition that
            indicates the creation of an index on the column, if set to <span class="bold">True</span></p>
        </li>
        <li>
          <p><span class="hi-blue">Table</span> :: An object that represents a database table. To create an instance, one
            needs to specify a name, an instance of <span class="bold">Metadata</span>, and a list of <span class="bold">
            Column</span> definitions</p>
        </li>
        <li>
          <p><span class="hi-blue">create()</span> :: Method on an instance of <span class="bold">Table</span> to create
            the database table</p>
        </li>
        <li>
          <p><span class="hi-blue">values()</span> :: Method to provide a list of <span class="bold">column</span>=value
            expression(s)</p>
        </li>
        <li>
          <p><span class="hi-blue">insert()</span> :: Method on an instance of <span class="bold">Table</span> to insert
            a record into the database table with the specified values</p>
        </li>
      </ul>
    </div>
    <div id="para-div">
      <p>To run the Python program <span class="bold">ex_sa_03.py</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ python ex_sa_03.py</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.9</h4>
      <pre>2020-04-04 20:27:47,367 - Postgres database url: postgres://polarsparc:polarsparc$123@localhost:5432/my_test_db
2020-04-04 20:27:47,418 - Connected to the Postgres database !!!
2020-04-04 20:27:47,447 - Created the customer table !!!
2020-04-04 20:27:47,475 - Inserted record for Alice
2020-04-04 20:27:47,477 - Inserted record for Bob
2020-04-04 20:27:47,478 - Inserted record for Charlie</pre>
    </div>
    <div id="para-div">
      <p>The following <span class="bold">Python</span> program (<span class="bold">ex_sa_04.py</span>) demonstrates the CRUD
        (Create, Read, Update, Delete) operations on the <span class="bold">customer</span> database table.</p>
    </div>
    <div id="para-div">
      <p>The method <span class="hi-blue">create_dummy_customer</span> creates a <span class="bold">Dummy</span> record, the
        method <span class="hi-blue">query_dummy_customer</span> reads the <span class="bold">Dummy</span> record, the method
        <span class="hi-blue">update_dummy_customer</span> updates the <span class="bold">Dummy</span> record, the method
        <span class="hi-blue">delete_dummy_customer</span> deletes the <span class="bold">Dummy</span> record, and finally
        the method <span class="hi-blue">query_customer</span> queries various records.</p>
    </div>    
    <div id="src-outer-div-1">
      <div class="src-cap-1">ex_sa_04.py</div>
      <div class="src-body-1">
      <pre>from sqlalchemy.engine import Engine
from sqlalchemy import MetaData
from SQLAlchemy.ex_sa_00 import create_db_engine

import logging

logging.basicConfig(format='%(asctime)s - %(message)s', level=logging.INFO)


def create_dummy_customer(engine: Engine):
    if engine.dialect.has_table(engine, 'customer'):
        metadata = MetaData(bind=engine, reflect=True)
        customer_table = metadata.tables['customer']
        with engine.connect() as db_conn:
            dummy = customer_table.insert().values(
                first_name='Dummy',
                last_name='Joker',
                email='dj@nowhere.cc'
            )
            resp = db_conn.execute(dummy)
            if resp.rowcount == 1:
                logging.info("Inserted record for Dummy")
            else:
                logging.info("Failed to insert record for Dummy")
    else:
        logging.info("The customer table *DOES NOT* exists !!!")


def query_dummy_customer(engine: Engine):
    if engine.dialect.has_table(engine, 'customer'):
        metadata = MetaData(bind=engine, reflect=True)
        customer_table = metadata.tables['customer']
        with engine.connect() as db_conn:
            # Select all columns
            dummy = customer_table.select() \
                .where(customer_table.columns.last_name == 'Joker')
            resp = db_conn.execute(dummy)
            if resp.rowcount == 1:
                logging.info("Selected record for Dummy")

                row = resp.fetchone()

                logging.info('First name: %s, Last name: %s, Email: %s' % (row['first_name'], row[2], row['email']))
            else:
                logging.info("Record for Dummy *DOES NOT* exists !!!")
    else:
        logging.info("The customer table *DOES NOT* exists !!!")


def update_dummy_customer(engine: Engine):
    if engine.dialect.has_table(engine, 'customer'):
        metadata = MetaData(bind=engine, reflect=True)
        customer_table = metadata.tables['customer']
        with engine.connect() as db_conn:
            dummy = customer_table.update() \
                .where(customer_table.c.last_name == 'Joker') \
                .values(email='djoker@dummy.io')
            resp = db_conn.execute(dummy)
            if resp.rowcount == 1:
                logging.info("Updated record for Dummy")
            else:
                logging.info("Record for Dummy *DOES NOT* exists !!!")
    else:
        logging.info("The customer table *DOES NOT* exists !!!")


def delete_dummy_customer(engine: Engine):
    if engine.dialect.has_table(engine, 'customer'):
        metadata = MetaData(bind=engine, reflect=True)
        customer_table = metadata.tables['customer']
        with engine.connect() as db_conn:
            dummy = customer_table.delete().where(customer_table.c.last_name == 'Joker')
            resp = db_conn.execute(dummy)
            if resp.rowcount == 1:
                logging.info("Deleted record for Dummy")
            else:
                logging.info("Record for Dummy *DOES NOT* exists !!!")
    else:
        logging.info("The customer table *DOES NOT* exists !!!")


def query_customer(engine: Engine):
    if engine.dialect.has_table(engine, 'customer'):
        metadata = MetaData(bind=engine, reflect=True)
        customer_table = metadata.tables['customer']
        with engine.connect() as db_conn:
            # Select all records and all columns
            query = customer_table.select()
            resp = db_conn.execute(query)
            if resp.rowcount > 0:
                for row in resp.fetchall():
                    logging.info('First name: %s, Last name: %s, Email: %s' % (row['first_name'], row[2], row['email']))
                logging.info("-------------------------")
            else:
                logging.info("No record(s) exists !!!")

            # Select all records and only columns last_name and email
            query = customer_table.select().with_only_columns([customer_table.c.last_name, customer_table.c.email])
            resp = db_conn.execute(query)
            if resp.rowcount > 0:
                for row in resp.fetchall():
                    logging.info('Last name: %s, Email: %s' % (row[0], row['email']))
                logging.info("-------------------------")
            else:
                logging.info("No record(s) exists !!!")

            # Select all records and only columns last_name and email order by last_name
            query = customer_table.select().with_only_columns([customer_table.c.last_name, customer_table.c.email]) \
                                  .order_by('last_name')
            resp = db_conn.execute(query)
            if resp.rowcount > 0:
                for row in resp.fetchall():
                    logging.info('Last name: %s, Email: %s' % (row[0], row['email']))
                logging.info("-------------------------")
            else:
                logging.info("No record(s) exists !!!")
    else:
        logging.info("The customer table *DOES NOT* exists !!!")


if __name__ == "__main__":
    db_engine = create_db_engine()
    create_dummy_customer(db_engine)
    query_dummy_customer(db_engine)
    update_dummy_customer(db_engine)
    query_dummy_customer(db_engine)
    delete_dummy_customer(db_engine)
    query_dummy_customer(db_engine)
    query_customer(db_engine)</pre>
      </div>
    </div>
    <div id="para-div">
      <p>The following are brief descriptions for some of the <span class="bold">Python</span> methods:</p>
      <ul id="blue-sqr-ul">
        <li>
          <p><span class="bold">Where Clause</span> :: A column C1 in a table T1 can be reference as the expression
            <span class="hi-yellow">T1.columns.C1</span> OR <span class="hi-yellow">T1.c.C1</span> in an SQL
            <span class="bold">where</span> clause</p>
        </li>
        <li>
          <p><span class="hi-blue">select()</span> :: Method on an instance of <span class="bold">Table</span> to query
            record(s) from the database table with the specified <span class="bold">where</span> clause</p>
        </li>
        <li>
          <p><span class="hi-blue">with_only_columns()</span> :: Method to specify the desired list of columns from the
            database table</p>
        </li>
        <li>
          <p><span class="hi-blue">order_by()</span> :: Method to specify a list of column name(s) from the database table</p>
        </li>
        <li>
          <p><span class="hi-blue">update()</span> :: Method on an instance of <span class="bold">Table</span> to update
            record(s) in the database table with the specified <span class="bold">where</span> clause and using the
            specified values</p>
        </li>
        <li>
          <p><span class="hi-blue">delete()</span> :: Method on an instance of <span class="bold">Table</span> to delete
            record(s) from the database table with the specified <span class="bold">where</span> clause</p>
        </li>
      </ul>
    </div>
    <div id="para-div">
      <p>To run the Python program <span class="bold">ex_sa_04.py</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ python ex_sa_04.py</p>
    </div>
    <div id="para-div">
      <p>The following would be a typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.10</h4>
      <pre>2020-04-04 21:48:05,446 - Postgres database url: postgres://bswamina:bswamina$123@localhost:5432/my_test_db
2020-04-04 21:48:05,498 - Connected to the Postgres database !!!
2020-04-04 21:48:05,526 - Inserted record for Dummy
2020-04-04 21:48:05,553 - Selected record for Dummy
2020-04-04 21:48:05,553 - First name: Dummy, Last name: Joker, Email: dj@nowhere.cc
2020-04-04 21:48:05,571 - Updated record for Dummy
2020-04-04 21:48:05,590 - Selected record for Dummy
2020-04-04 21:48:05,590 - First name: Dummy, Last name: Joker, Email: djoker@dummy.io
2020-04-04 21:48:05,612 - Deleted record for Dummy
2020-04-04 21:48:05,636 - Record for Dummy *DOES NOT* exists !!!
2020-04-04 21:48:05,664 - First name: Alice, Last name: Doctor, Email: alice.d@timbuk2.do
2020-04-04 21:48:05,664 - First name: Bob, Last name: Builder, Email: bbuilder@nomansland.bu
2020-04-04 21:48:05,664 - First name: Charlie, Last name: Driver, Email: charlie.driver@vehicles.ve
2020-04-04 21:48:05,664 - -------------------------
2020-04-04 21:48:05,665 - Last name: Doctor, Email: alice.d@timbuk2.do
2020-04-04 21:48:05,665 - Last name: Builder, Email: bbuilder@nomansland.bu
2020-04-04 21:48:05,665 - Last name: Driver, Email: charlie.driver@vehicles.ve
2020-04-04 21:48:05,665 - -------------------------
2020-04-04 21:48:05,666 - Last name: Builder, Email: bbuilder@nomansland.bu
2020-04-04 21:48:05,666 - Last name: Doctor, Email: alice.d@timbuk2.do
2020-04-04 21:48:05,666 - Last name: Driver, Email: charlie.driver@vehicles.ve
2020-04-04 21:48:05,666 - -------------------------</pre>
    </div>
    <div id="para-div">
      <p>This concludes the exploration of the basic capabilities in the <span class="bold">SQLAlchemy Core</span> layer.</p>
    </div>
    <div id="section-div">
      <p>References</p>
    </div>
    <div id="para-div">
      <p><a href="https://www.sqlalchemy.org/" target="_blank"><span class="bold">SQLAlchemy</span></a></p>
      <p><a href="https://www.pythonsheets.com/notes/python-sqlalchemy.html" target="_blank"><span class="bold">PySheet SQLAlchemy</span></a></p>
      <p><a href="https://polarsparc.github.io/Docker/Docker.html" target="_blank"><span class="bold">Introduction to Docker</span></a></p>
    </div>
    <br/>
    <hr class="line-hr" />
    <div>
      <a id="footer-a" href="https://polarsparc.github.io/">&copy;&nbsp;PolarSPARC</a>
    </div>
  </body>
</html>
