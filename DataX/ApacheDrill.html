<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="application/xhtml+xml; charset=windows-1252" />
    <meta name="author" content="Bhaskar.S">
    <meta name="description" content="Introduction to Apache Drill">
    <meta name="subject" content="Introduction to Apache Drill">
    <meta name="keywords" content="bigdata, drill, sql">
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <title>Introduction to Apache Drill</title>
    <link href="../css/polarsparc-v2.4.css" type="text/css" rel="stylesheet" />
  </head>
  <body>
    <br/>
    <table borber="0">
      <tr>
        <td valign="bottom"><span id="ps-home"></span></td>
        <td valign="bottom"><span id="home-a"><a id="home-a" href="https://polarsparc.github.io/">PolarSPARC</a></span></td>
      </tr>
    </table>
    <br/>
    <div id="title-div">
      <p>Introduction to Apache Drill</p>
    </div>
    <br />
    <table id="ad-table">
      <tbody>
        <tr>
          <td class="author-td">Bhaskar S</td>
          <td class="date-td">10/14/2022</td>
        </tr>
      </tbody>
    </table>
    <hr class="line-hr" />
    <br/>
    <div id="section-div">
      <p>Overview</p>
    </div>
    <div id="para-div">
      <p>In any typical Enterprise, data is being continuously generated by the various systems (that are spread across) in different
        formats (csv, json, parquet, etc) and being persisted in different data stores (nosql, relational, s3, etc). In order to make
        these various data sets accessible to the data analysts, engineers, and scientists, they are run thorugh a complex set of ETL
        (Extract, Transform, and Load) processes for storage into a big data analytics repository (aka data lake).</p>
      <p>Rather than running a complex ETL processing plant to move the various data sets to the Enterprise lake from the different
        data sources, is there an easier way for users to access and perform adhoc queries or analysis on these data sets ???</p>
      <p>This is where <a href="https://drill.apache.org/" target="_blank"><span class="hi-yellow">Apache Drill</span></a> comes in
        handy !!!</p>
    </div>
    <div id="para-div">
      <p>Apache Drill is a high-performance, low-latency, open-source distributed query engine, which enables in the exploration of
        data that is in either structured and/or semi-structured, using the industry standard ANSI SQL query language.</p>
      <p>It allows one to seemlessly aggregate data from various sources (including data files - csv, json, parquet) as well as data
        stores (hadoop, nosql, relational, s3) for querying and analysis.</p>
    </div>
    <div id="para-div">
      <p>The following illustration depicts the high-level architecture for Apache Drill deployment:</p>
    </div>
    <br/>
    <div id="img-outer-div">
      <img src="./images/drill-1.png" class="img-cls" alt="High Level Architecture" />
      <div class="img-cap">Figure-1</div>
    </div>
    <br/>
    <div id="para-div">
      <p>The query engine of Apache Drill is referred to as the <span class="hi-yellow">Drillbit</span>. The distributed cluster of
        Drillbit nodes is managed through <span class="hi-yellow">Zookeeper</span>.</p>
      <p>Requests from the user community (via query tools or BI tools) goes via the distributed Drillbit cluster, where one Drillbit
        node is choosen as the gateway for all requests and responses (referred to as the <span class="hi-yellow">Foreman</span>).</p>
      <p>Drillbit will parse the user query, create a logical execution plan, run through the query optimizer, and finally convert to
        a physical plan for execution.</p>
    </div>
    <div id="section-div">
      <p>Installation and Setup</p>
    </div>
    <div id="para-div">
      <p>The installation will be on a <span class="bold">Ubuntu 22.04 LTS</span> based Linux desktop. Also, let us assume the logged
        in user be <span class="hi-yellow">polarsparc</span> with the home directory at <span class="hi-grey">/home/polarsparc</span>.
        We will also assume that <span class="hi-yellow">docker</span> has been installed on the system.</p>
      <p>We will create a directory structure as depicted below:</p>
    </div>
    <br/>
    <div id="img-outer-div">
      <img src="./images/drill-2.png" class="img-cls" alt="Top Level Directory Structure" />
      <div class="img-cap">Figure-2</div>
    </div>
    <br/>
    <div id="para-div">
      <p>To create the desired directory structure, execute the following commands:</p>
    </div>
    <div id="cmd-div">
      <p>$ mkdir -p $HOME/drill $HOME/drill/docker $HOME/drill/conf $HOME/drill/data $HOME/drill/log</p>
      <p>$ mkdir -p $HOME/drill/data/csv/D1 $HOME/drill/data/csv/D2</p>
      <p>$ mkdir -p $HOME/drill/data/parquet/D1 $HOME/drill/data/parquet/D2 $HOME/drill/data/parquet/D3</p>
    </div>
    <div id="para-div">
      <p>We will need to build a custom docker image for Apache Drill with the flexibility to run specific commands and to be able
        to mount volumes.</p>
    </div>
    <div id="para-div">
      <p>The following is the <span class="hi-yellow">Dockerfile</span> located in <span class="hi-grey">$HOME/drill/docker</span>:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">Dockerfile</div>
      <div class="src-body-1">
<pre># Base OS/JDK image to use
FROM adoptopenjdk/openjdk11:ubuntu-slim

# Metadata
LABEL Version="1.0" \
      Author="Bhaskar.S" \
      Email="bswamina@polarsparc.com"

# Enviornment variable(s)
ENV DRILL_VERSION=1.20.2 \
    DRILL_USER=drill \
    DRILL_GID=1000 \
    DRILL_UID=1000 \
    DRILL_HOME=/opt/drill \
    DRILL_PID_DIR=/opt/drill \
    DRILL_LOG_DIR=/opt/drill/log \
    DRILL_CONF_DIR=/opt/drill/conf \
    DRILL_DATA_DIR=/data

# Install required core dependencies
RUN apt-get -qq update && \
    apt-get install -y ca-certificates -qq && \
    apt-get install -y wget -qq && \
    apt-get clean

# Prepare Apache Drill environment - user, group, directories
RUN mkdir -p "$DRILL_HOME" "$DRILL_LOG_DIR" "$DRILL_CONF_DIR" "$DRILL_DATA_DIR" && \
    groupadd -r "$DRILL_USER" --gid="$DRILL_GID" && \
    useradd -r -g "$DRILL_USER" --uid="$DRILL_UID" -d "$DRILL_HOME" "$DRILL_USER" && \
    chown -R "$DRILL_USER":"$DRILL_USER" "$DRILL_HOME" && \
    chown -R "$DRILL_USER":"$DRILL_USER" "$DRILL_DATA_DIR"

# Install Apache Drill software
RUN wget -q "https://www.apache.org/dist/drill/$DRILL_VERSION/apache-drill-$DRILL_VERSION.tar.gz" -P /tmp && \
    tar -xzf "/tmp/apache-drill-$DRILL_VERSION.tar.gz" -C /tmp && \
    mv "/tmp/apache-drill-$DRILL_VERSION/"* "$DRILL_HOME" && \
    rm -rf "/tmp/apache-drill-$DRILL_VERSION.tar.gz" "/tmp/apache-drill-$DRILL_VERSION"

# Set the Home directory
WORKDIR $DRILL_HOME

# Expose the desired network ports
EXPOSE 8047 31010 31011 31012

# Set the PATH variable
ENV PATH=$PATH:$DRILL_HOME/bin

# Define volume mount point(s)
VOLUME $DRILL_CONF_DIR
VOLUME $DRILL_LOG_DIR
VOLUME $DRILL_DATA_DIR</pre>
      </div>
    </div>
    <br/>
    <div id="para-div">
      <p>To build the cutom docker image, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ docker build -t bswamina/apache-drill:1.20.2-openjdk-11 .</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.1</h4>
      <pre>Sending build context to Docker daemon  65.42MB
Step 1/12 : FROM adoptopenjdk/openjdk11:ubuntu-slim
ubuntu-slim: Pulling from adoptopenjdk/openjdk11
fb0b3276a519: Pull complete 
6545d0570982: Pull complete 
aea04a60246f: Pull complete 
4834d3313655: Pull complete 
Digest: sha256:7fafb2739d77ab5b8a31ed13b12af7d5d0bfb90dbd88e484bd4ec8d2a34791a3
Status: Downloaded newer image for adoptopenjdk/openjdk11:ubuntu-slim
  ---> 24c3d508d46a
Step 2/12 : LABEL Version="1.0"       Author="Bhaskar.S"       Email="bswamina@polarsparc.com"
  ---> Running in d1951aa8807c
Removing intermediate container d1951aa8807c
  ---> f3275f626c56
Step 3/12 : ENV DRILL_VERSION=1.20.2     DRILL_USER=drill     DRILL_GID=1000     DRILL_UID=1000     DRILL_HOME=/opt/drill     DRILL_PID_DIR=/opt/drill     DRILL_LOG_DIR=/opt/drill/log     DRILL_CONF_DIR=/opt/drill/conf     DRILL_DATA_DIR=/data
  ---> Running in 0292d7a5e273
Removing intermediate container 0292d7a5e273
  ---> 7ee83052f5dd
Step 4/12 : RUN apt-get -qq update &&     apt-get install -y ca-certificates -qq &&     apt-get install -y wget -qq &&     apt-get clean
  ---> Running in a6f6b3664add
debconf: delaying package configuration, since apt-utils is not installed
Selecting previously unselected package wget.
(Reading database ... 7582 files and directories currently installed.)
Preparing to unpack .../wget_1.20.3-1ubuntu2_amd64.deb ...
Unpacking wget (1.20.3-1ubuntu2) ...
Setting up wget (1.20.3-1ubuntu2) ...
Removing intermediate container a6f6b3664add
  ---> 64fe00a5160d
Step 5/12 : RUN mkdir -p "$DRILL_HOME" "$DRILL_LOG_DIR" "$DRILL_CONF_DIR" "$DRILL_DATA_DIR" &&     groupadd -r "$DRILL_USER" --gid="$DRILL_GID" &&     useradd -r -g "$DRILL_USER" --uid="$DRILL_UID" -d "$DRILL_HOME" "$DRILL_USER" &&     chown -R "$DRILL_USER":"$DRILL_USER" "$DRILL_HOME" &&     chown -R "$DRILL_USER":"$DRILL_USER" "$DRILL_DATA_DIR"
  ---> Running in a890485d08cb
Removing intermediate container a890485d08cb
  ---> 8204557d644e
Step 6/12 : RUN wget -q "https://www.apache.org/dist/drill/$DRILL_VERSION/apache-drill-$DRILL_VERSION.tar.gz" -P /tmp &&     tar -xzf "/tmp/apache-drill-$DRILL_VERSION.tar.gz" -C /tmp &&     mv "/tmp/apache-drill-$DRILL_VERSION/"* "$DRILL_HOME" &&     rm -rf "/tmp/apache-drill-$DRILL_VERSION.tar.gz" "/tmp/apache-drill-$DRILL_VERSION"
  ---> Running in e50d9a975442
Removing intermediate container e50d9a975442
  ---> 5a0bca80a5d4
Step 7/12 : WORKDIR $DRILL_HOME
  ---> Running in 61e8365ba71b
Removing intermediate container 61e8365ba71b
  ---> f99f64cd5dd3
Step 8/12 : EXPOSE 8047 31010 31011 31012
  ---> Running in 913afc603967
Removing intermediate container 913afc603967
  ---> 27e5b35764c9
Step 9/12 : ENV PATH=$PATH:$DRILL_HOME/bin
  ---> Running in b65837c9d0dd
Removing intermediate container b65837c9d0dd
  ---> 62885db6dda4
Step 10/12 : VOLUME $DRILL_CONF_DIR
  ---> Running in 0e5158b975f0
Removing intermediate container 0e5158b975f0
  ---> 1b68e4deec81
Step 11/12 : VOLUME $DRILL_LOG_DIR
  ---> Running in 92c467e06110
Removing intermediate container 92c467e06110
  ---> a9ae6e40f187
Step 12/12 : VOLUME $DRILL_DATA_DIR
  ---> Running in 5dedba421c2d
Removing intermediate container 5dedba421c2d
  ---> 4ae42602654c
Successfully built 4ae42602654c
Successfully tagged bswamina/apache-drill:1.20.2-openjdk-11</pre>
    </div>
    <div id="para-div">
      <p>To list all the docker images, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ docker images</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.2</h4>
      <pre>REPOSITORY               TAG                 IMAGE ID       CREATED          SIZE
bswamina/apache-drill    1.20.2-openjdk-11   104e2dbc7c32   49 seconds ago   876MB
adoptopenjdk/openjdk11   ubuntu-slim         6c88963921ad   3 days ago       372MB</pre>
    </div>
    <div id="para-div">
      <p>To ensure the docker image was built right, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ docker run --rm bswamina/apache-drill:1.20.2-openjdk-11 ls /opt/drill/bin</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.3</h4>
      <pre>auto-setup.sh
drill-am.sh
drillbit.sh
drill-conf
drill-config.sh
drill-embedded
drill-embedded.bat
drill-localhost
drill-on-yarn.sh
hadoop-excludes.txt
runbit
sqlline
sqlline.bat
submit_plan
yarn-drillbit.sh</pre>
    </div>
    <div id="para-div">
      <p>One can pull the docker image from the <span class="bold">Docker Hub</span> repository using the following command:</p>
    </div>
    <div id="cmd-div">
      <p>docker pull bswamina/apache-drill:1.20.2-openjdk-11</p>
    </div>
    <div id="para-div">
      <p>Now, we shift gears to setup the configuration files and the data files.</p>
      <p>The following is the config file <span class="hi-yellow">logback.xml</span> that is used to control logging by Apache Drill
        and is located in <span class="hi-grey">$HOME/drill/conf</span>:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">logback.xml</div>
      <div class="src-body-1">
<pre>&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

--&gt;
&lt;configuration&gt;
    &lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;
      &lt;encoder&gt;
        &lt;pattern&gt;%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n
        &lt;/pattern&gt;
      &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;appender name="QUERY" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;
      &lt;file&gt;${log.query.path}&lt;/file&gt;
      &lt;rollingPolicy class="ch.qos.logback.core.rolling.FixedWindowRollingPolicy"&gt;
        &lt;fileNamePattern&gt;${log.query.path}.%i&lt;/fileNamePattern&gt;
        &lt;minIndex&gt;1&lt;/minIndex&gt;
        &lt;maxIndex&gt;10&lt;/maxIndex&gt;
      &lt;/rollingPolicy&gt;
      &lt;triggeringPolicy class="ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy"&gt;
        &lt;maxFileSize&gt;100MB&lt;/maxFileSize&gt;
      &lt;/triggeringPolicy&gt;
      &lt;encoder&gt;
        &lt;pattern&gt;%msg%n&lt;/pattern&gt;
      &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;
      &lt;file&gt;${log.path}&lt;/file&gt;
      &lt;rollingPolicy class="ch.qos.logback.core.rolling.FixedWindowRollingPolicy"&gt;
        &lt;fileNamePattern&gt;${log.path}.%i&lt;/fileNamePattern&gt;
        &lt;minIndex&gt;1&lt;/minIndex&gt;
        &lt;maxIndex&gt;10&lt;/maxIndex&gt;
      &lt;/rollingPolicy&gt;
      &lt;triggeringPolicy class="ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy"&gt;
        &lt;maxFileSize&gt;100MB&lt;/maxFileSize&gt;
      &lt;/triggeringPolicy&gt;
      &lt;encoder&gt;
        &lt;pattern&gt;%date{ISO8601} [%thread] %-5level %logger{36} - %msg%n&lt;/pattern&gt;
      &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;logger name="org.apache.drill" additivity="false"&gt;
      &lt;level value="info" /&gt;
      &lt;appender-ref ref="FILE" /&gt;
    &lt;/logger&gt;

    &lt;logger name="query.logger" additivity="false"&gt;
      &lt;level value="info" /&gt;
      &lt;appender-ref ref="QUERY" /&gt;
    &lt;/logger&gt;

    &lt;root&gt;
      &lt;level value="error" /&gt;
      &lt;appender-ref ref="STDOUT" /&gt;
    &lt;/root&gt;
&lt;/configuration&gt;</pre>
      </div>
    </div>
    <br/>
    <div id="para-div">
      <p>Under the hood Apache Drill uses another framework called <a href="https://calcite.apache.org/" target="_blank">
        <span class="hi-yellow">Apache Calcite</span></a>. The following is the config file <span class="hi-yellow">saffron.properties</span>
        that is used to control the character set and is located in <span class="hi-grey">$HOME/drill/conf</span>:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">saffron.properties</div>
      <div class="src-body-1">
<pre>#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# This properties file is used by Apache Calcite to define allowed charset in string literals,
# which is by default ISO-8859-1.
# Current configuration allows parsing UTF-8 by default, i.e. queries that contain utf-8 string literal.
# To take affect this file should be present in classpath.

saffron.default.charset=UTF-16LE
saffron.default.nationalcharset=UTF-16LE
saffron.default.collation.name=UTF-16LE$en_US</pre>
      </div>
    </div>
    <br/>
    <div id="para-div">
      <p>The following is the config file <span class="hi-yellow">drill-override.conf</span> that is used to configure Apache Drill
        related options and is located in <span class="hi-grey">$HOME/drill/conf</span>:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">drill-override.conf</div>
      <div class="src-body-1">
<pre>#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

drill.exec: {
  cluster-id: "dev-drillbit",
  zk.connect: "localhost:2181",
  sys.store.provider.local.path="/opt/drill/conf"
}</pre>
      </div>
    </div>
    <br/>
    <div id="para-div">
      <p>Finally, the following is the config file <span class="hi-yellow">storage-plugins-override.conf</span> that is used to
        configure the various storage options in Apache Drill and is located in <span class="hi-grey">$HOME/drill/conf</span>:</p>
    </div>
    <br/>
    <div id="src-outer-div-1">
      <div class="src-cap-1">storage-plugins-override.conf</div>
      <div class="src-body-1">
<pre>#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

"storage": {
  dfs: {
    type: "file",
    connection: "file:///",
    workspaces: {
      "data_pq": {
        "location": "/data/parquet/",
        "writable": false,
        "defaultInputFormat": "parquet",
        "allowAccessOutsideWorkspace": false
      },
      "data_csv": {
        "location": "/data/csv/",
        "writable": false,
        "defaultInputFormat": "csv",
        "allowAccessOutsideWorkspace": false
      }
    },
    formats: {
      "parquet": {
        "type": "parquet"
      },
      "csv": {
        "type": "text",
        "extensions": [
          "csv"
        ],
        "extractHeader": true,
        "delimiter": ","
      }
    },
    enabled: true
  }
}</pre>
      </div>
    </div>
    <br/>
    <div id="para-div">
      <p>For our demonstration, we will only leverage the data sets stored in csv and parquet formats in the local filesystem (the
        <span class="hi-yellow">dfs</span> storage).</p>
      <p>We will copy few csv and parquet files into the appropriate locations in <span class="hi-grey">$HOME/drill/data</span>.</p>
    </div>
    <br/>
    <div id="info-div">
      <h4>!!! INFORMATIONAL !!!</h4>
      <pre>The data sets used in this article are from the following two sources:

1. <a href="https://vincentarelbundock.github.io/Rdatasets/csv/palmerpenguins/penguins.csv" target="_blank"><span class="bold">Palmer Penguins</span></a>
2. <a href="https://docs.timescale.com/timescaledb/latest/tutorials/sample-datasets/" target="_blank"><span class="bold">Device Monitoring</span></a>
</pre>
    </div>
    <br/>
    <div id="para-div">
      <p>The following illustration depicts the various data files in the different directories:</p>
    </div>
    <br/>
    <div id="img-outer-div">
      <img src="./images/drill-3.png" class="img-cls" alt="Data Files" />
      <div class="img-cap">Figure-3</div>
    </div>
    <br/>
    <div id="para-div">
      <p>Now, it is time to copy the following files into the appropriate destination as indicated below:</p>
      <ul id="blue-sqr-ul">
        <li>
          <p>The file <a href="https://github.com/bhaskars-repo/Drill/blob/main/data/csv/D1/penguins.csv" target="_blank">
            <span class="hi-yellow">Penguins CSV</span></a> to <span class="hi-grey">$HOME/drill/data/csv/D1</span></p>
        </li>
        <li>
          <p>The file <a href="https://github.com/bhaskars-repo/Drill/blob/main/data/parquet/D1/penquins.parquet" target="_blank">
            <span class="hi-yellow">Penguins Parquet</span></a> to <span class="hi-grey">$HOME/drill/data/parquet/D1</span></p>
        </li>
        <li>
          <p>The file <a href="https://github.com/bhaskars-repo/Drill/blob/main/data/csv/D2/device_info.csv" target="_blank">
            <span class="hi-yellow">Device Info CSV</span></a> to <span class="hi-grey">$HOME/drill/data/csv/D2</span></p>
        </li>
        <li>
          <p>Unzip the file <a href="https://github.com/bhaskars-repo/Drill/blob/main/data/csv/D2/device_readings.csv.zip" target="_blank">
            <span class="hi-yellow">Device Readings CSV ZIP</span></a> to <span class="hi-grey">$HOME/drill/data/csv/D2</span></p>
        </li>
        <li>
          <p>The file <a href="https://github.com/bhaskars-repo/Drill/blob/main/data/parquet/D2/device_info.parquet" target="_blank">
            <span class="hi-yellow">Device Info Parquet</span></a> to <span class="hi-grey">$HOME/drill/data/parquet/D2</span></p>
        </li>
        <li>
          <p>The file <a href="https://github.com/bhaskars-repo/Drill/blob/main/data/parquet/D3/device_readings.parquet" target="_blank">
            <span class="hi-yellow">Device Readings Parquet</span></a> to <span class="hi-grey">$HOME/drill/data/parquet/D3</span></p>
        </li>
      </ul>
      <p>At this point, we are done with all the required setup.</p>
    </div>
    <div id="para-div">
      <p>To start Apache Drill in the embedded mode (single node mode), execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>$ docker run -it --rm --name drill -u $(id -u ${USER}):$(id -g ${USER}) -p 8047:8047 -p 31010:31010 -v /home/polarsparc/drill/conf:/opt/drill/conf -v /home/polarsparc/drill/log:/opt/drill/log -v /home/polarsparc/drill/data:/data bswamina/apache-drill:1.20.2-openjdk-11 /opt/drill/bin/drill-embedded</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.4</h4>
      <pre>"A Drill is a terrible thing to waste."
apache drill></pre>
    </div>
    <br/>
    <div id="para-div">
      <p>Notice the prompt changes to <span class="hi-blue">apache drill></span>.</p>
    </div>
    <div id="section-div">
      <p>Hands-on with Drill</p>
    </div>
    <div id="para-div">
      <p>To ensure Drill has started properly in the embedded mode, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>apache drill> select version from sys.version;</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.5</h4>
      <pre>+---------+
| version |
+---------+
| 1.20.2  |
+---------+
1 row selected (1.326 seconds)</pre>
    </div>
    <br/>
    <div id="para-div">
      <p>We will begin by accessing the penguins parquet file via Apache Drill. Parquet files are stored locally on the filesystem.
        This means we use the <span class="hi-blue">dfs</span> storage plugin. Also, the parquet files are stored in the directory
        <span class="hi-grey">$HOME/drill/data/parquet</span> which is defined under the <span class="hi-yellow">workspace</span>
        of <span class="hi-blue">data_pq</span>. So, the schema to use is <span class="hi-yellow">dfs.data_pq</span>.</p>
      <p>To switch to the schema <span class="hi-yellow">dfs.data_pq</span>, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>apache drill> use dfs.data_pq;</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.6</h4>
      <pre>+------+-----------------------------------------+
|  ok  |                 summary                 |
+------+-----------------------------------------+
| true | Default schema changed to [dfs.data_pq] |
+------+-----------------------------------------+
1 row selected (0.249 seconds)
apache drill (dfs.data_pq)></pre>
    </div>
    <br/>
    <div id="para-div">
      <p>Notice the prompt changes to <span class="hi-blue">apache drill (dfs.data_pq)></span>.</p>
    </div>
    <div id="para-div">
      <p>To display all the file systems visible to drill for query purposes, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>apache drill (dfs.data_pq)> show files;</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.7</h4>
<pre>+------+-------------+--------+--------+-------+-------+-------------+-------------------------+-------------------------+
| name | isDirectory | isFile | length | owner | group | permissions |       accessTime        |    modificationTime     |
+------+-------------+--------+--------+-------+-------+-------------+-------------------------+-------------------------+
| D1   | true        | false  | 4096   | drill | drill | rwxrwxr-x   | 2022-10-14 19:16:13.325 | 2022-10-14 19:33:12.247 |
| D3   | true        | false  | 4096   | drill | drill | rwxrwxr-x   | 2022-10-14 19:18:49.013 | 2022-10-14 19:33:13.585 |
| D2   | true        | false  | 4096   | drill | drill | rwxrwxr-x   | 2022-10-14 19:21:42.013 | 2022-10-14 19:33:14.301 |
+------+-------------+--------+--------+-------+-------+-------------+-------------------------+-------------------------+
3 rows selected (0.152 seconds)</pre>
    </div>
    <br/>
    <div id="para-div">
      <p>To display all the schemas available to drill for access, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>apache drill (dfs.data_pq)> show schemas;</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.8</h4>
<pre>+--------------------+
|    SCHEMA_NAME     |
+--------------------+
| dfs.data_csv       |
| dfs.data_pq        |
| dfs.default        |
| information_schema |
| sys                |
| cp.default         |
+--------------------+
6 rows selected (0.308 seconds)</pre>
    </div>
    <br/>
    <div id="para-div">
      <p>To display the count of records in the penguins parquet file, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>apache drill (dfs.data_pq)> select count(*) as `Count` from dfs.data_pq.`/D1/*.parquet`;</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.9</h4>
<pre>+-------+
| Count |
+-------+
| 342   |
+-------+
1 row selected (0.777 seconds)</pre>
    </div>
    <br/>
    <div id="error-div">
      <h4>!!! ATTENTION !!!</h4>
      <pre>There is a weird bug in Apache Drill. Trying to execute the following SQL results in an error:

select count(*) from dfs.data_pq.`/D1/penguins.parquet`;

The generated error is:

Error: VALIDATION ERROR: From line 1, column 22 to line 1, column 24: Object '/D1/penguins.parquet' not found
[Error Id: 5618fe46-4615-4169-b651-55e4b007293a ] (state=,code=0)</pre>
    </div>
    <br/>
    <div id="para-div">
      <p>To display all the penguin species and their body mass from the penguins parquet file where their body mass is greater than
        or equal to 5750, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>apache drill (dfs.data_pq)> select `species`, `body_mass_g` from dfs.data_pq.`/D1/*.parquet` where `body_mass_g` >= 5750 order by `body_mass_g`;</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.10</h4>
<pre>+---------+-------------+
| species | body_mass_g |
+---------+-------------+
| Gentoo  | 5750.0      |
| Gentoo  | 5800.0      |
| Gentoo  | 5800.0      |
| Gentoo  | 5850.0      |
| Gentoo  | 5850.0      |
| Gentoo  | 5850.0      |
| Gentoo  | 5950.0      |
| Gentoo  | 5950.0      |
| Gentoo  | 6000.0      |
| Gentoo  | 6000.0      |
| Gentoo  | 6050.0      |
| Gentoo  | 6300.0      |
+---------+-------------+
12 rows selected (0.563 seconds)</pre>
    </div>
    <br/>
    <div id="para-div">
      <p>To display the average body mass grouped by the penguin species from the penguins parquet file, execute the following
        command:</p>
    </div>
    <div id="cmd-div">
      <p>apache drill (dfs.data_pq)> select p.species, avg(p.body_mass_g) as `mean_body_mass_g` from dfs.data_pq.`/D1/*.parquet` as p group by p.species;</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.11</h4>
<pre>+-----------+--------------------+
|  species  |  mean_body_mass_g  |
+-----------+--------------------+
| Adelie    | 3700.662251655629  |
| Gentoo    | 5076.016260162602  |
| Chinstrap | 3733.0882352941176 |
+-----------+--------------------+
3 rows selected (0.215 seconds)</pre>
    </div>
    <br/>
    <div id="para-div">
      <p>Moving on to the more complex case of joining multiple sources (two parquet files from the device monitoring data set).</p>
      <p>To display the time, the model, the cpu usage, and the memory usage on devices from the device monitoring parquet files for
        a limit of 10 rows, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>apache drill (dfs.data_pq)> select `b`.`time`, `a`.`model`, `b`.`cpu_avg_5min`, `b`.`mem_used` from `/D2/*.parquet` as `a` inner join `/D3/*.parquet` as `b` on `a`.`device_id` = `b`.`device_id` limit 10;</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.12</h4>
<pre>+------------------------+---------+--------------+-----------+
|          time          |  model  | cpu_avg_5min | mem_used  |
+------------------------+---------+--------------+-----------+
| 2016-11-15 07:00:00-05 | pinto   | 10.802       | 589988922 |
| 2016-11-15 07:00:00-05 | mustang | 8.106        | 279257668 |
| 2016-11-15 07:00:00-05 | focus   | 8.2          | 350418942 |
| 2016-11-15 07:00:00-05 | pinto   | 5.594        | 450422930 |
| 2016-11-15 07:00:00-05 | mustang | 5.13         | 370403299 |
| 2016-11-15 07:00:00-05 | focus   | 7.572        | 590376778 |
| 2016-11-15 07:00:00-05 | pinto   | 7.362        | 350314519 |
| 2016-11-15 07:00:00-05 | mustang | 12.4         | 590887970 |
| 2016-11-15 07:00:00-05 | focus   | 7.232        | 589266926 |
| 2016-11-15 07:00:00-05 | pinto   | 11.014       | 460684425 |
+------------------------+---------+--------------+-----------+
10 rows selected (3.179 seconds)</pre>
    </div>
    <br/>
    <div id="error-div">
      <h4>!!! ATTENTION !!!</h4>
      <pre>There is a weird bug in Apache Drill. Trying to execute the following SQL results in an error:

select b.time, a.model, b.cpu_avg_5min, b.mem_used from `/D2/*.parquet` as a inner join `/D3/*.parquet` as b on a.device_id = b.device_id limit 10;

The generated error is:

Error: PARSE ERROR: Encountered "." at line 1, column 9.
SQL Query: select b.time, a.model, b.cpu_avg_5min, b.mem_used from `/D2/*.parquet` as a inner join `/D3/*.parquet` as b on a.device_id = b.device_id limit 10
                   ^
[Error Id: 7e5a87f7-9dbf-4faf-b291-5e86cc26c0d7 ] (state=,code=0)</pre>
    </div>
    <br/>
    <div id="para-div">
      <p>It is now time to switch gears into the csv space. To switch to the schema <span class="hi-yellow">dfs.data_csv</span>,
        execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>apache drill> use dfs.data_csv;</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.13</h4>
      <pre>+------+------------------------------------------+
|  ok  |                 summary                  |
+------+------------------------------------------+
| true | Default schema changed to [dfs.data_csv] |
+------+------------------------------------------+
1 row selected (0.132 seconds)
apache drill (dfs.data_csv)></pre>
    </div>
    <br/>
    <div id="para-div">
      <p>Notice the prompt changes to <span class="hi-blue">apache drill (dfs.data_csv)></span>.</p>
    </div>
    <div id="para-div">
      <p>To display all the file systems visible to drill for query purposes, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>apache drill (dfs.data_csv)> show files;</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.14</h4>
<pre>+------+-------------+--------+--------+-------+-------+-------------+-------------------------+-------------------------+
| name | isDirectory | isFile | length | owner | group | permissions |       accessTime        |    modificationTime     |
+------+-------------+--------+--------+-------+-------+-------------+-------------------------+-------------------------+
| D1   | true        | false  | 4096   | drill | drill | rwxrwxr-x   | 2022-10-14 19:42:16.223 | 2022-10-14 19:42:16.319 |
| D2   | true        | false  | 4096   | drill | drill | rwxrwxr-x   | 2022-10-14 19:42:17.738 | 2022-10-14 19:42:17.794 |
+------+-------------+--------+--------+-------+-------+-------------+-------------------------+-------------------------+
2 rows selected (0.126 seconds)</pre>
    </div>
    <br/>
    <div id="para-div">
      <p>To display the penguin species and their body mass from the penguins csv file and limit the number of records to 10, execute
        the following command:</p>
    </div>
    <div id="cmd-div">
      <p>apache drill (dfs.data_csv)> select `species`, `body_mass_g` from `/D1/device_info.csv` limit 10;</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.15</h4>
<pre>+---------+-------------+
| species | body_mass_g |
+---------+-------------+
| Gentoo  | 5750.0      |
| Gentoo  | 5800.0      |
| Gentoo  | 5800.0      |
| Gentoo  | 5850.0      |
| Gentoo  | 5850.0      |
| Gentoo  | 5850.0      |
| Gentoo  | 5950.0      |
| Gentoo  | 5950.0      |
| Gentoo  | 6000.0      |
| Gentoo  | 6000.0      |
| Gentoo  | 6050.0      |
| Gentoo  | 6300.0      |
+---------+-------------+
12 rows selected (0.563 seconds)</pre>
    </div>
    <br/>
    <div id="warn-div">
      <h4>!!! ATTENTION !!!</h4>
      <pre>Notice how one is able to refer to the actual data file with csv file(s). This is an issue with the parquet file(s)</pre>
    </div>
    <br/>
    <div id="para-div">
      <p>Now, for the final act of joining multiple sources (a csv file and a parquet file from the device monitoring data set).</p>
      <p>To display the time, the model, the cpu usage, and the memory usage on devices from the device info parquet file and the
        device readings csv file for a limit of 10 rows, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>apache drill (dfs.data_csv)> select `b`.`time`, `a`.`model`, `b`.`cpu_avg_5min`, `b`.`mem_used` from dfs.`/data/parquet/D2/device_info.parquet` as `a` inner join dfs.`/data/csv/D2/device_readings.csv` as `b` on `a`.`device_id` = `b`.`device_id` limit 10;</p>
    </div>
    <div id="para-div">
      <p>The following would be the typical output:</p>
    </div>
    <div id="out-div">
      <h4>Output.16</h4>
<pre>+------------------------+---------+--------------+-----------+
|          time          |  model  | cpu_avg_5min | mem_used  |
+------------------------+---------+--------------+-----------+
| 2016-11-15 07:00:00-05 | pinto   | 10.802       | 589988922 |
| 2016-11-15 07:00:00-05 | mustang | 8.106        | 279257668 |
| 2016-11-15 07:00:00-05 | focus   | 8.2          | 350418942 |
| 2016-11-15 07:00:00-05 | pinto   | 5.594        | 450422930 |
| 2016-11-15 07:00:00-05 | mustang | 5.13         | 370403299 |
| 2016-11-15 07:00:00-05 | focus   | 7.572        | 590376778 |
| 2016-11-15 07:00:00-05 | pinto   | 7.362        | 350314519 |
| 2016-11-15 07:00:00-05 | mustang | 12.4         | 590887970 |
| 2016-11-15 07:00:00-05 | focus   | 7.232        | 589266926 |
| 2016-11-15 07:00:00-05 | pinto   | 11.014       | 460684425 |
+------------------------+---------+--------------+-----------+
10 rows selected (0.48 seconds)</pre>
    </div>
    <br/>
    <div id="para-div">
      <p>One can access the web interface of Apache Drill by launching the url <span class="hi-yellow">http://localhost:8047</span>
        in a web browser.</p>
      <p>The following illustration depicts the Apache Drill web interface:</p>
    </div>
    <br/>
    <div id="img-outer-div">
      <img src="./images/drill-4.png" class="img-cls" alt="Web Interface" />
      <div class="img-cap">Figure-4</div>
    </div>
    <br/>
    <div id="para-div">
      <p>Clicking on the <span class="hi-grey">Storage</span> option from the navigation bar will land one in the storage options
        page as shown in the illustration below:</p>
    </div>
    <br/>
    <div id="img-outer-div">
      <img src="./images/drill-5.png" class="img-cls" alt="Storage Options" />
      <div class="img-cap">Figure-5</div>
    </div>
    <br/>
    <div id="para-div">
      <p>Clicking on the <span class="hi-grey">Query</span> option from the navigation bar will land one in the query execution page
        as shown in the illustration below:</p>
    </div>
    <br/>
    <div id="img-outer-div">
      <img src="./images/drill-6.png" class="img-cls" alt="Query Execution" />
      <div class="img-cap">Figure-6</div>
    </div>
    <br/>
    <div id="para-div">
      <p>To quit from the drill command-line query interface, execute the following command:</p>
    </div>
    <div id="cmd-div">
      <p>apache drill (dfs.data_csv)> !quit</p>
    </div>
    <div id="para-div">
      <p>The following is the link to the <span class="bold">Github Repo</span> that provides the config and data files used in this
        article:</p>
      <ul id="blue-sqr-ul">
        <li><p><a href="https://github.com/bhaskars-repo/Drill" target="_blank"><span class="bold">Drill Config &amp; Data</span></a></p></li>
      </ul>
    </div>
    <br/>
    <div id="section-div">
      <p>References</p>
    </div>
    <div id="para-div">
      <p><a href="https://drill.apache.org" target="_blank"><span class="bold">Apache Drill</span></a></p>
    </div>
    <br/>
    <hr class="line-hr" />
    <div>
      <a id="footer-a" href="https://polarsparc.github.io/">&copy;&nbsp;PolarSPARC</a>
    </div>
  </body>
</html>
